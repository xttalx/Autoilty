<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Add new product - Autoilty Marketplace">
  <title>Create Listing - Autoilty</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <!-- Navigation -->
  <nav class="nav" role="navigation" aria-label="Main navigation">
    <div class="container">
      <div class="nav-inner">
        <a href="index.html" class="logo" aria-label="Autoilty Home">Autoilty</a>
        <div class="nav-links">
          <a href="index.html" class="nav-link">Home</a>
          <a href="marketplace.html" class="nav-link">Marketplace</a>
          <a href="create-listing.html" class="nav-link active">Create Listing</a>
          <button class="cart-toggle" aria-label="Shopping cart" id="cartToggle">
            <i data-lucide="shopping-cart"></i>
            <span class="cart-badge" id="cartBadge">0</span>
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Add Product Form -->
  <main class="add-product-page">
    <div class="container">
      <div class="page-header">
        <h1 class="page-title">Create Listing</h1>
        <p class="page-subtitle">List a new product on the Autoilty marketplace</p>
      </div>

      <form id="productForm" class="product-form">
        <!-- Product Name -->
        <div class="form-group">
          <label for="productName" class="form-label">Product Name *</label>
          <input 
            type="text" 
            id="productName" 
            name="name" 
            class="form-input" 
            placeholder="e.g., Premium Car Wax"
            required
            aria-required="true"
          >
        </div>

        <!-- Category -->
        <div class="form-group">
          <label for="productCategory" class="form-label">Category *</label>
          <select 
            id="productCategory" 
            name="category" 
            class="form-select" 
            required
            aria-required="true"
          >
            <option value="">Select category</option>
            <option value="auto">Auto</option>
            <option value="clothing">Clothing</option>
          </select>
        </div>

        <!-- Price -->
        <div class="form-group">
          <label for="productPrice" class="form-label">Price (CAD) *</label>
          <input 
            type="number" 
            id="productPrice" 
            name="price" 
            class="form-input" 
            placeholder="49.99"
            step="0.01"
            min="0"
            required
            aria-required="true"
          >
        </div>

        <!-- Description -->
        <div class="form-group">
          <label for="productDescription" class="form-label">Description *</label>
          <textarea 
            id="productDescription" 
            name="description" 
            class="form-textarea" 
            rows="4"
            placeholder="Detailed product description..."
            required
            aria-required="true"
          ></textarea>
        </div>

        <!-- Image URL -->
        <div class="form-group">
          <label for="productImage" class="form-label">Image URL *</label>
          <input 
            type="url" 
            id="productImage" 
            name="image" 
            class="form-input" 
            placeholder="https://images.unsplash.com/photo-..."
            required
            aria-required="true"
          >
          <p class="form-hint">Enter a direct image URL (e.g., Unsplash, Imgur)</p>
        </div>

        <!-- Sizes (for clothing only) -->
        <div class="form-group" id="sizesGroup" style="display: none;">
          <label class="form-label">Available Sizes</label>
          <div class="size-checkboxes">
            <label class="checkbox-label">
              <input type="checkbox" name="sizes" value="XS" class="checkbox-input">
              <span>XS</span>
            </label>
            <label class="checkbox-label">
              <input type="checkbox" name="sizes" value="S" class="checkbox-input">
              <span>S</span>
            </label>
            <label class="checkbox-label">
              <input type="checkbox" name="sizes" value="M" class="checkbox-input">
              <span>M</span>
            </label>
            <label class="checkbox-label">
              <input type="checkbox" name="sizes" value="L" class="checkbox-input">
              <span>L</span>
            </label>
            <label class="checkbox-label">
              <input type="checkbox" name="sizes" value="XL" class="checkbox-input">
              <span>XL</span>
            </label>
            <label class="checkbox-label">
              <input type="checkbox" name="sizes" value="XXL" class="checkbox-input">
              <span>XXL</span>
            </label>
            <label class="checkbox-label">
              <input type="checkbox" name="sizes" value="One Size" class="checkbox-input">
              <span>One Size</span>
            </label>
          </div>
        </div>

        <!-- Featured & New -->
        <div class="form-group-row">
          <label class="checkbox-label">
            <input type="checkbox" id="featured" name="featured" class="checkbox-input">
            <span>Featured Product</span>
          </label>
          <label class="checkbox-label">
            <input type="checkbox" id="new" name="new" class="checkbox-input">
            <span>New Product</span>
          </label>
          <label class="checkbox-label">
            <input type="checkbox" id="inStock" name="in_stock" class="checkbox-input" checked>
            <span>In Stock</span>
          </label>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button type="submit" class="btn btn-primary btn-full" id="submitBtn">
            <i data-lucide="plus" class="btn-icon"></i>
            Create Listing
          </button>
          <a href="marketplace.html" class="btn btn-secondary btn-full">
            Cancel
          </a>
        </div>

        <!-- Success/Error Messages -->
        <div id="formMessage" class="form-message" style="display: none;"></div>
      </form>

      <!-- Image Preview -->
      <div class="image-preview-container" id="imagePreview" style="display: none;">
        <h3 class="preview-title">Image Preview</h3>
        <div class="image-preview">
          <img id="previewImage" src="" alt="Preview" class="preview-img">
        </div>
      </div>
    </div>
  </main>

  <!-- Cart Drawer -->
  <div class="cart-drawer" id="cartDrawer" aria-hidden="true">
    <div class="cart-overlay" id="cartOverlay"></div>
    <div class="cart-content">
      <div class="cart-header">
        <h2>Your Cart</h2>
        <button class="cart-close" id="cartClose" aria-label="Close cart">
          <i data-lucide="x"></i>
        </button>
      </div>
      <div class="cart-items" id="cartItems">
        <!-- Cart items loaded dynamically -->
      </div>
      <div class="cart-footer">
        <div class="cart-total">
          <span>Total:</span>
          <span class="cart-total-amount" id="cartTotal">$0.00 CAD</span>
        </div>
        <a href="cart.html" class="btn btn-primary btn-full">Checkout</a>
        <button class="btn btn-secondary btn-full" id="continueShopping">Continue Shopping</button>
      </div>
    </div>
  </div>

  <script src="script.js" defer></script>
  <script>
    // Initialize Lucide icons
    lucide.createIcons();
    
    // Initialize Supabase client
    let supabaseClient = null;
    
    function getSupabaseConfig() {
      if (typeof window !== 'undefined' && window.env) {
        return {
          url: window.env.SUPABASE_URL,
          key: window.env.SUPABASE_ANON_KEY,
        };
      }
      
      if (typeof document !== 'undefined') {
        const script = document.querySelector('script[data-supabase-url]');
        if (script) {
          return {
            url: script.dataset.supabaseUrl,
            key: script.dataset.supabaseKey,
          };
        }
      }
      
      return { url: null, key: null };
    }
    
    try {
      const config = getSupabaseConfig();
      if (config.url && config.key && typeof supabase !== 'undefined') {
        supabaseClient = supabase.createClient(config.url, config.key);
      }
    } catch (error) {
      console.warn('Supabase not configured:', error);
    }
    
    // Show/hide sizes based on category
    const categorySelect = document.getElementById('productCategory');
    const sizesGroup = document.getElementById('sizesGroup');
    
    categorySelect.addEventListener('change', (e) => {
      if (e.target.value === 'clothing') {
        sizesGroup.style.display = 'block';
      } else {
        sizesGroup.style.display = 'none';
        // Uncheck all size checkboxes
        document.querySelectorAll('input[name="sizes"]').forEach(cb => {
          cb.checked = false;
        });
      }
    });
    
    // Image preview on URL input
    const imageInput = document.getElementById('productImage');
    const imagePreview = document.getElementById('imagePreview');
    const previewImage = document.getElementById('previewImage');
    
    imageInput.addEventListener('input', (e) => {
      const url = e.target.value.trim();
      if (url && isValidImageUrl(url)) {
        previewImage.src = url;
        imagePreview.style.display = 'block';
      } else {
        imagePreview.style.display = 'none';
      }
    });
    
    function isValidImageUrl(url) {
      return /\.(jpg|jpeg|png|gif|webp|svg)(\?.*)?$/i.test(url) || url.includes('unsplash.com') || url.includes('imgur.com');
    }
    
    // Form submission
    const form = document.getElementById('productForm');
    const submitBtn = document.getElementById('submitBtn');
    const formMessage = document.getElementById('formMessage');
    
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Get form data
      const formData = new FormData(form);
      const name = formData.get('name').trim();
      const category = formData.get('category');
      const price = parseFloat(formData.get('price'));
      const description = formData.get('description').trim();
      const image = formData.get('image').trim();
      const featured = formData.get('featured') === 'on';
      const isNew = formData.get('new') === 'on';
      const inStock = formData.get('in_stock') !== 'off';
      
      // Get selected sizes
      const sizes = Array.from(formData.getAll('sizes'));
      
      // Validate
      if (!name || !category || !price || !description || !image) {
        showFormMessage('Please fill in all required fields.', 'error');
        return;
      }
      
      if (price <= 0) {
        showFormMessage('Price must be greater than 0.', 'error');
        return;
      }
      
      // Disable submit button
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i data-lucide="loader-2" class="btn-icon"></i> Adding Product...';
      lucide.createIcons();
      
      // Prepare product data
      const productData = {
        title: name,
        name: name,
        price: price,
        category: category,
        image: image,
        images: [image],
        description: description,
        sizes: category === 'clothing' ? sizes : [],
        featured: featured,
        new: isNew,
        in_stock: inStock,
        status: 'approved', // Auto-approve, or change to 'pending' for moderation
      };
      
      try {
        if (supabaseClient) {
          // Save to Supabase
          const { data, error } = await supabaseClient
            .from('products')
            .insert([productData])
            .select()
            .single();
          
          if (error) {
            throw error;
          }
          
          showFormMessage('Product added successfully! Redirecting to marketplace...', 'success');
          
          // Redirect to marketplace after 2 seconds
          setTimeout(() => {
            window.location.href = 'marketplace.html';
          }, 2000);
        } else {
          // Fallback: Save to localStorage (for demo purposes)
          const products = JSON.parse(localStorage.getItem('autoilty_products') || '[]');
          products.push({
            ...productData,
            id: Date.now().toString(),
          });
          localStorage.setItem('autoilty_products', JSON.stringify(products));
          
          showFormMessage('Product added locally! (Supabase not configured)', 'success');
          
          setTimeout(() => {
            window.location.href = 'marketplace.html';
          }, 2000);
        }
      } catch (error) {
        console.error('Error adding product:', error);
        showFormMessage('Failed to add product. Please try again.', 'error');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i data-lucide="plus" class="btn-icon"></i> Add Product';
        lucide.createIcons();
      }
    });
    
    function showFormMessage(message, type) {
      formMessage.textContent = message;
      formMessage.className = `form-message form-message-${type}`;
      formMessage.style.display = 'block';
      
      // Scroll to message
      formMessage.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      
      // Auto-hide success messages
      if (type === 'success') {
        setTimeout(() => {
          formMessage.style.display = 'none';
        }, 5000);
      }
    }
  </script>
</body>
</html>

