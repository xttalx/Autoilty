<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Browse thousands of used cars, auto parts, and automotive services in Canada. Buy used cars Canada, find auto parts Manitoba, and discover quality vehicles at Autoilty marketplace.">
  <meta name="keywords" content="buy used cars Canada, auto parts Manitoba, used cars for sale, car parts online, automotive marketplace, buy cars, sell cars, auto services, used vehicles Canada">
  <meta name="robots" content="index, follow">
  <meta property="og:title" content="Marketplace - Buy Used Cars & Auto Parts Canada">
  <meta property="og:description" content="Browse thousands of used cars, auto parts, and automotive services in Canada.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://autoilty.com/marketplace.html">
  <link rel="canonical" href="https://autoilty.com/marketplace.html">
  <title>Marketplace - Buy Used Cars Canada & Auto Parts | Autoilty</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <script src="public/config.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <!-- Navigation -->
  <nav class="nav" role="navigation" aria-label="Main navigation">
    <div class="container">
      <div class="nav-inner">
        <a href="index.html" class="logo" aria-label="Autoilty Home">Autoilty</a>
        <button class="nav-toggle" id="navToggle" aria-label="Toggle navigation">
          <i data-lucide="menu"></i>
        </button>
        <div class="nav-links" id="navLinks">
          <a href="index.html" class="nav-link">Home</a>
          <a href="marketplace.html" class="nav-link active">Shop</a>
          <a href="marketplace.html" class="nav-link">Marketplace</a>
          <a href="inventory.html" class="nav-link">Find Vehicle</a>
          <a href="resources.html" class="nav-link">Resources</a>
          <a href="#" class="nav-link" id="createPostingLink" style="display: none;">Create Posting</a>
          <a href="login.html?return=marketplace.html" class="nav-link" id="createPostingLoginLink">Create Posting</a>
          <button class="cart-toggle" aria-label="Shopping cart" id="cartToggle">
            <i data-lucide="shopping-cart"></i>
            <span class="cart-badge" id="cartBadge">0</span>
          </button>
          <div class="user-menu" id="userMenu" style="display: none;">
            <button class="user-menu-button" id="userMenuButton">
              <span id="userMenuName">User</span>
              <i data-lucide="chevron-down"></i>
            </button>
            <div class="user-menu-dropdown" id="userMenuDropdown">
              <a href="profile.html" class="user-menu-item">
                <i data-lucide="user" style="width: 1rem; height: 1rem; margin-right: 0.5rem;"></i>
                Profile
              </a>
              <a href="my-postings.html" class="user-menu-item" id="myPostingsLink">
                <i data-lucide="file-text" style="width: 1rem; height: 1rem; margin-right: 0.5rem;"></i>
                My Postings
              </a>
              <a href="messages.html" class="user-menu-item" id="inboxLink">
                <i data-lucide="mail" style="width: 1rem; height: 1rem; margin-right: 0.5rem;"></i>
                Inbox
                <span class="unread-badge" id="unreadBadge" style="display: none; margin-left: auto; background: var(--color-primary); color: white; border-radius: 10px; padding: 2px 6px; font-size: 0.75rem; font-weight: 600; min-width: 18px; text-align: center;">0</span>
              </a>
              <button class="user-menu-item danger" id="logoutButton" style="width: 100%; text-align: left; border: none; cursor: pointer;">
                <i data-lucide="log-out" style="width: 1rem; height: 1rem; margin-right: 0.5rem;"></i>
                Logout
              </button>
            </div>
          </div>
          <a href="login.html?return=marketplace.html" class="nav-link" id="loginLink">Login</a>
        </div>
      </div>
    </div>
  </nav>

  <!-- Breadcrumbs -->
  <nav aria-label="Breadcrumb" class="breadcrumb-nav" style="background: #fafafa; border-bottom: 1px solid var(--color-border); padding: var(--spacing-sm) 0;">
    <div class="container">
      <ol class="breadcrumb-list" style="display: flex; align-items: center; list-style: none; padding: 0; margin: 0; flex-wrap: wrap; gap: var(--spacing-xs);" itemscope itemtype="https://schema.org/BreadcrumbList">
        <li class="breadcrumb-item" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem" style="flex-shrink: 0;">
          <a href="index.html" itemprop="item" class="breadcrumb-link" style="color: var(--color-text-light); text-decoration: none; font-size: 0.875rem; transition: color 0.2s; white-space: nowrap;">
            <span itemprop="name">Home</span>
          </a>
          <meta itemprop="position" content="1" />
        </li>
        <li class="breadcrumb-separator" style="color: var(--color-text-light); margin: 0 var(--spacing-xs); font-size: 0.875rem; flex-shrink: 0;">/</li>
        <li class="breadcrumb-item breadcrumb-current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem" style="color: var(--color-text); font-size: 0.875rem; font-weight: 500; flex: 1 1 auto; min-width: 0; overflow: hidden;">
          <span itemprop="name" style="display: inline-block; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Marketplace</span>
          <meta itemprop="position" content="2" />
        </li>
      </ol>
    </div>
  </nav>

  <!-- Sticky Search Bar -->
  <div class="search-bar-container" role="search">
    <div class="container">
      <div class="search-bar">
        <i data-lucide="search" class="search-icon" aria-hidden="true"></i>
        <input 
          type="text" 
          id="searchInput" 
          class="search-input" 
          placeholder="Search products, cars, parts..."
          aria-label="Search products, cars, and auto parts"
          autocomplete="off"
        >
        <button class="search-clear" id="searchClear" aria-label="Clear search" style="display: none;">
          <i data-lucide="x" aria-hidden="true"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Filter Tabs -->
  <section class="filters-section">
    <div class="container">
      <!-- Mobile Filter Toggle Button -->
      <button class="filter-toggle-btn" id="filterToggleBtn" aria-label="Open filters">
        <i data-lucide="filter" style="width: 1.25rem; height: 1.25rem;"></i>
        <span>Filters</span>
      </button>
      
      <div class="filter-tabs" role="tablist">
        <button class="filter-tab active" data-filter="all" role="tab" aria-selected="true">All</button>
        <button class="filter-tab" data-filter="Cars" role="tab" aria-selected="false">Cars</button>
        <button class="filter-tab" data-filter="Parts" role="tab" aria-selected="false">Parts</button>
        <button class="filter-tab" data-filter="Services" role="tab" aria-selected="false">Services</button>
        <button class="filter-tab" data-filter="Other" role="tab" aria-selected="false">Other</button>
      </div>
      
      <!-- Advanced Filters Panel -->
      <div class="advanced-filters-panel" id="advancedFiltersPanel" style="display: none; margin-top: var(--spacing-lg); padding: var(--spacing-lg); background: white; border: 1px solid var(--color-border); border-radius: var(--radius); box-shadow: var(--shadow-sm);">
        <div class="advanced-filters-header">
          <h3 style="font-size: 1.25rem; margin-bottom: var(--spacing-md);">Advanced Filters</h3>
          <button class="btn btn-secondary btn-sm" id="toggleAdvancedFilters" aria-label="Close advanced filters">
            <i data-lucide="x" class="btn-icon"></i>
            Close
          </button>
        </div>
        
        <div class="advanced-filters-content">
          <div class="filter-row">
            <!-- Price Range Slider -->
            <div class="filter-group">
              <label for="priceRangeMin" class="form-label">Price Range (CAD)</label>
              <div class="price-range-container">
                <input type="number" id="priceRangeMin" class="form-input" placeholder="Min" min="0" step="100" aria-label="Minimum price">
                <span style="margin: 0 var(--spacing-sm); color: var(--color-text-light);">-</span>
                <input type="number" id="priceRangeMax" class="form-input" placeholder="Max" min="0" step="100" aria-label="Maximum price">
              </div>
              <div class="price-slider-container" style="margin-top: var(--spacing-sm);">
                <input type="range" id="priceSlider" class="price-slider" min="0" max="100000" step="1000" value="50000" aria-label="Price range slider">
                <div class="price-slider-labels" style="display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--color-text-light); margin-top: 0.25rem;">
                  <span>$0</span>
                  <span id="priceSliderValue">$50,000</span>
                  <span>$100,000+</span>
                </div>
              </div>
            </div>
            
            <!-- Location Filter with Map Integration -->
            <div class="filter-group">
              <label for="locationFilter" class="form-label">Location</label>
              <div class="location-filter-container">
                <input type="text" id="locationFilter" class="form-input" placeholder="City or postal code" autocomplete="off" aria-label="Filter by location">
                <button type="button" class="btn btn-secondary btn-sm" id="useLocationBtn" aria-label="Use my location">
                  <i data-lucide="map-pin" class="btn-icon"></i>
                  Use My Location
                </button>
              </div>
              <div id="locationMapContainer" style="display: none; margin-top: var(--spacing-md); height: 250px; border-radius: var(--radius); overflow: hidden; border: 1px solid var(--color-border);">
                <!-- Map will be integrated here (Google Maps or Mapbox) -->
                <div id="locationMap" style="width: 100%; height: 100%; background: #f5f5f5; display: flex; align-items: center; justify-content: center; color: var(--color-text-light);">
                  <p>Map integration available</p>
                </div>
              </div>
            </div>
            
            <!-- VIN Verification Filter -->
            <div class="filter-group">
              <label for="vinFilter" class="form-label">VIN Verification</label>
              <select id="vinFilter" class="form-select" aria-label="Filter by VIN verification status">
                <option value="">All</option>
                <option value="verified">Verified VIN Only</option>
                <option value="unverified">Unverified</option>
              </select>
            </div>
            
            <!-- Auto Part Compatibility Checker -->
            <div class="filter-group" id="compatibilityFilterGroup" style="display: none;">
              <label for="vehicleMake" class="form-label">Vehicle Compatibility (Auto Parts)</label>
              <div class="compatibility-filters">
                <select id="vehicleMake" class="form-select" aria-label="Vehicle make">
                  <option value="">Select Make</option>
                  <option value="Toyota">Toyota</option>
                  <option value="Honda">Honda</option>
                  <option value="Ford">Ford</option>
                  <option value="Chevrolet">Chevrolet</option>
                  <option value="BMW">BMW</option>
                  <option value="Mercedes-Benz">Mercedes-Benz</option>
                </select>
                <select id="vehicleModel" class="form-select" aria-label="Vehicle model" disabled>
                  <option value="">Select Model</option>
                </select>
                <select id="vehicleYear" class="form-select" aria-label="Vehicle year" disabled>
                  <option value="">Select Year</option>
                </select>
              </div>
              <button type="button" class="btn btn-secondary btn-sm" id="checkCompatibility" style="margin-top: var(--spacing-sm);" disabled>
                <i data-lucide="check-circle" class="btn-icon"></i>
                Check Compatibility
              </button>
            </div>
          </div>
          
          <div class="filter-actions" style="margin-top: var(--spacing-lg); padding-top: var(--spacing-md); border-top: 1px solid var(--color-border); display: flex; gap: var(--spacing-sm); justify-content: flex-end;">
            <button type="button" class="btn btn-secondary" id="resetFilters" aria-label="Reset all filters">
              <i data-lucide="refresh-cw" class="btn-icon"></i>
              Reset Filters
            </button>
            <button type="button" class="btn btn-primary" id="applyAdvancedFilters" aria-label="Apply advanced filters">
              <i data-lucide="filter" class="btn-icon"></i>
              Apply Filters
            </button>
          </div>
        </div>
      </div>
      
      <!-- Toggle Advanced Filters Button -->
      <div style="text-align: center; margin-top: var(--spacing-md);">
        <button class="btn btn-secondary" id="showAdvancedFilters" aria-label="Show advanced filters">
          <i data-lucide="filter" class="btn-icon"></i>
          Advanced Filters
        </button>
      </div>
    </div>
  </section>

  <!-- Filter Drawer for Mobile -->
  <div class="filter-drawer-overlay" id="filterDrawerOverlay"></div>
  <div class="filter-drawer" id="filterDrawer">
    <div class="filter-drawer-header">
      <h3>Filters</h3>
      <button class="filter-drawer-close" id="filterDrawerClose" aria-label="Close filters">
        <i data-lucide="x" style="width: 1.25rem; height: 1.25rem;"></i>
      </button>
    </div>
    <div class="filter-drawer-body">
      <!-- Category Filters -->
      <div class="filter-group" style="margin-bottom: var(--spacing-lg);">
        <label class="form-label" style="margin-bottom: var(--spacing-sm); font-weight: var(--font-weight-semibold);">Category</label>
        <div style="display: flex; flex-direction: column; gap: var(--spacing-xs);">
          <button class="filter-tab active" data-filter="all" style="text-align: left; padding: var(--spacing-sm); border: 1px solid var(--color-border); border-radius: var(--radius); background: var(--color-bg);">All</button>
          <button class="filter-tab" data-filter="Cars" style="text-align: left; padding: var(--spacing-sm); border: 1px solid var(--color-border); border-radius: var(--radius); background: var(--color-bg);">Cars</button>
          <button class="filter-tab" data-filter="Parts" style="text-align: left; padding: var(--spacing-sm); border: 1px solid var(--color-border); border-radius: var(--radius); background: var(--color-bg);">Parts</button>
          <button class="filter-tab" data-filter="Services" style="text-align: left; padding: var(--spacing-sm); border: 1px solid var(--color-border); border-radius: var(--radius); background: var(--color-bg);">Services</button>
          <button class="filter-tab" data-filter="Other" style="text-align: left; padding: var(--spacing-sm); border: 1px solid var(--color-border); border-radius: var(--radius); background: var(--color-bg);">Other</button>
        </div>
      </div>
      
      <!-- Price Range -->
      <div class="filter-group" style="margin-bottom: var(--spacing-lg);">
        <label for="drawerPriceMin" class="form-label">Price Range (CAD)</label>
        <div class="price-range-container" style="display: flex; gap: var(--spacing-sm); align-items: center;">
          <input type="number" id="drawerPriceMin" class="form-input" placeholder="Min" min="0" step="100" style="flex: 1;">
          <span style="color: var(--color-text-light);">-</span>
          <input type="number" id="drawerPriceMax" class="form-input" placeholder="Max" min="0" step="100" style="flex: 1;">
        </div>
      </div>
      
      <!-- Location -->
      <div class="filter-group" style="margin-bottom: var(--spacing-lg);">
        <label for="drawerLocation" class="form-label">Location</label>
        <input type="text" id="drawerLocation" class="form-input" placeholder="City or postal code" autocomplete="off">
      </div>
    </div>
    <div class="filter-drawer-footer">
      <button class="btn btn-secondary" id="drawerResetFilters">Reset</button>
      <button class="btn btn-primary" id="drawerApplyFilters">Apply</button>
    </div>
  </div>

  <!-- Create Posting CTA -->
  <section class="cta-section" style="padding: var(--spacing-xl) 0; border-bottom: 1px solid var(--color-border); background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);">
    <div class="container">
      <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--spacing-md); padding: var(--spacing-lg); background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
        <div style="flex: 1; min-width: 250px;">
          <h3 style="margin-bottom: var(--spacing-xs); font-size: 1.5rem; font-weight: 600; color: var(--color-text);">Have something to sell?</h3>
          <p style="color: var(--color-text-light); margin: 0; font-size: 0.95rem;">List your automotive items and reach thousands of buyers in minutes.</p>
        </div>
        <button class="btn btn-primary" id="createPostingCtaBtn" onclick="if(typeof openPostingFormModal === 'function') { openPostingFormModal(); } else { window.location.href = 'my-postings.html?create=true'; }" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.875rem 1.75rem; font-weight: 600; font-size: 1rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: all 0.3s ease; white-space: nowrap; cursor: pointer;">
          <i data-lucide="plus" class="btn-icon" style="width: 1.25rem; height: 1.25rem;"></i>
          Create Posting
        </button>
      </div>
    </div>
  </section>

  <!-- Top Deals Section (Curated by Admins) -->
  <section class="top-deals-section" id="topDealsSection" style="display: none; padding: var(--spacing-xl) 0; background: linear-gradient(135deg, #fff5e6 0%, #ffffff 100%); border-bottom: 1px solid var(--color-border);">
    <div class="container">
      <div class="top-deals-header" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--spacing-lg); flex-wrap: wrap; gap: var(--spacing-md);">
        <div>
          <h2 class="section-title" style="display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-xs);">
            <i data-lucide="award" style="width: 1.5rem; height: 1.5rem; color: #ff9800;"></i>
            Top Deals
          </h2>
          <p class="section-subtitle" style="color: var(--color-text-light); margin: 0;">Handpicked by our team - Best deals on quality vehicles and parts</p>
        </div>
        <a href="#productsGrid" class="btn btn-secondary btn-sm" aria-label="View all listings">
          View All
          <i data-lucide="arrow-right" class="btn-icon"></i>
        </a>
      </div>
      <div class="top-deals-grid" id="topDealsGrid" role="list">
        <!-- Top deals loaded dynamically -->
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
      </div>
    </div>
  </section>

  <!-- Products Grid -->
  <main class="main-content">
    <div class="container">
      <div id="resultsHeader" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md); flex-wrap: wrap; gap: var(--spacing-sm);">
        <p id="resultsCount" style="color: var(--color-text-light); font-size: 0.9375rem; margin: 0;">
          <span id="resultsCountNumber">0</span> listings found
        </p>
        <div style="display: flex; gap: var(--spacing-sm); align-items: center;">
          <button class="btn btn-secondary btn-sm" id="viewToggle" aria-label="Toggle view">
            <i data-lucide="layout-grid" class="btn-icon" id="viewToggleIcon"></i>
            <span id="viewToggleText">Grid</span>
          </button>
        </div>
      </div>
      <div class="products-grid" id="productsGrid">
        <!-- Products loaded dynamically -->
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
      </div>
      <div id="emptyState" class="empty-state" style="display: none; grid-column: 1 / -1; text-align: center; padding: var(--spacing-xxl);">
        <i data-lucide="package" style="width: 4rem; height: 4rem; margin: 0 auto var(--spacing-md); color: var(--color-text-light); display: block;"></i>
        <h3 style="margin-bottom: var(--spacing-xs);">No postings found</h3>
        <p style="color: var(--color-text-light); margin-bottom: var(--spacing-md);">Try adjusting your filters or be the first to create a posting!</p>
        <button class="btn btn-primary" onclick="if(typeof openPostingFormModal === 'function') { openPostingFormModal(); } else { window.location.href = 'my-postings.html?create=true'; }" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.875rem 1.75rem; font-weight: 600; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: all 0.3s ease; cursor: pointer;">
          <i data-lucide="plus" class="btn-icon" style="width: 1.25rem; height: 1.25rem;"></i>
          Create Posting
        </button>
      </div>
    </div>
  </main>

  <!-- Floating Cart Button -->
  <button class="floating-cart-btn" id="floatingCartBtn" aria-label="Open shopping cart">
    <i data-lucide="shopping-cart"></i>
    <span class="floating-cart-badge" id="floatingCartBadge">0</span>
  </button>

  <!-- Cart Drawer -->
  <div class="cart-drawer" id="cartDrawer" aria-hidden="true">
    <div class="cart-overlay" id="cartOverlay"></div>
    <div class="cart-content">
      <div class="cart-header">
        <h2>Your Cart</h2>
        <button class="cart-close" id="cartClose" aria-label="Close cart">
          <i data-lucide="x"></i>
        </button>
      </div>
      <div class="cart-items" id="cartItems">
        <!-- Cart items loaded dynamically -->
      </div>
      <div class="cart-footer">
        <div class="cart-total">
          <span>Total:</span>
          <span class="cart-total-amount" id="cartTotal">$0.00 CAD</span>
        </div>
        <a href="cart.html" class="btn btn-primary btn-full">Checkout</a>
        <button class="btn btn-secondary btn-full" id="continueShopping">Continue Shopping</button>
      </div>
    </div>
  </div>

  <!-- Contact Seller Modal -->
  <div class="contact-modal-overlay" id="contactModalOverlay">
    <div class="contact-modal">
      <div class="contact-modal-header">
        <h3>Contact Seller</h3>
        <button class="contact-modal-close" id="contactModalClose" aria-label="Close modal">
          <i data-lucide="x"></i>
        </button>
      </div>
      <div class="contact-modal-body">
        <form id="contactModalForm">
          <input type="hidden" id="contactModalPostingId" name="postingId">
          <input type="hidden" id="contactModalToUserId" name="toUserId">
          
          <div class="form-group" style="margin-bottom: var(--spacing-md);">
            <label for="contactModalMessage" class="form-label">Message</label>
            <textarea id="contactModalMessage" name="message" class="form-textarea" rows="5" required placeholder="Type your message..."></textarea>
          </div>
          
          <div id="contactModalError" style="color: #c53030; font-size: 0.875rem; margin-bottom: var(--spacing-md); display: none;"></div>
          
          <div class="contact-modal-actions">
            <button type="button" class="btn btn-secondary" id="contactModalCancel">Cancel</button>
            <button type="submit" class="btn btn-primary">
              <i data-lucide="send" class="btn-icon"></i>
              Send Message
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="auth.js"></script>
  <script src="marketplace-api.js"></script>
  <script src="messages-api.js"></script>
  <script src="contact-seller-modal.js"></script>
  <script src="posting-form-modal.js"></script>
  <script>
    // Initialize Lucide icons
    lucide.createIcons();
    
    // Setup navigation and user menu
    function setupNavigation() {
    const currentUser = getCurrentUser();
    const userMenu = document.getElementById('userMenu');
    const loginLink = document.getElementById('loginLink');
    const myPostingsLink = document.getElementById('myPostingsLink');
      const createPostingLink = document.getElementById('createPostingLink');
      const createPostingLoginLink = document.getElementById('createPostingLoginLink');
    if (currentUser && isAuthenticated()) {
        // User is logged in - show user menu and create posting link
        if (userMenu) {
      userMenu.style.display = 'block';
          userMenu.style.visibility = 'visible';
        }
        if (loginLink) loginLink.style.display = 'none';
        if (myPostingsLink) myPostingsLink.style.display = 'flex';
        if (createPostingLink) {
          createPostingLink.style.display = 'block';
          // Update link to use modal - clone to remove old listeners and add new one
          const newLink = createPostingLink.cloneNode(true);
          createPostingLink.parentNode.replaceChild(newLink, createPostingLink);
          const updatedLink = document.getElementById('createPostingLink');
          if (updatedLink) {
            updatedLink.addEventListener('click', (e) => {
              e.preventDefault();
              if (typeof openPostingFormModal === 'function') {
                openPostingFormModal();
              } else {
                window.location.href = 'my-postings.html?create=true';
              }
            });
          }
        }
        if (createPostingLoginLink) createPostingLoginLink.style.display = 'none';
        
        const userMenuName = document.getElementById('userMenuName');
        if (userMenuName) userMenuName.textContent = currentUser.username;
        
        // Update unread badge
        if (typeof updateUnreadBadge === 'function') {
          updateUnreadBadge();
        }
      
      // User menu toggle
        const userMenuButton = document.getElementById('userMenuButton');
        const userMenuDropdown = document.getElementById('userMenuDropdown');
        if (userMenuButton && userMenuDropdown) {
          userMenuButton.addEventListener('click', (e) => {
        e.stopPropagation();
            userMenuDropdown.classList.toggle('show');
          });
          
          document.addEventListener('click', (e) => {
            if (!userMenuButton.contains(e.target) && !userMenuDropdown.contains(e.target)) {
              userMenuDropdown.classList.remove('show');
            }
          });
        }
      
      // Logout
        const logoutButton = document.getElementById('logoutButton');
        if (logoutButton) {
          logoutButton.addEventListener('click', () => {
        if (confirm('Are you sure you want to logout?')) {
          logout();
        }
      });
        }
      } else {
        // User is not logged in - show login link and create posting link that redirects to login
        if (userMenu) userMenu.style.display = 'none';
        if (loginLink) loginLink.style.display = 'block';
        if (myPostingsLink) myPostingsLink.style.display = 'none';
        if (createPostingLink) createPostingLink.style.display = 'none';
        if (createPostingLoginLink) createPostingLoginLink.style.display = 'block';
      }
    }
    
    // Mobile hamburger menu toggle (single implementation, no duplicates)
    function setupMobileNav() {
      const navToggle = document.getElementById('navToggle');
      const navLinks = document.getElementById('navLinks');
      
      if (!navToggle || !navLinks) return;
      
      // Show/hide toggle button based on screen size
      function checkMobile() {
        if (window.innerWidth <= 768) {
          navToggle.style.display = 'block';
    } else {
          navToggle.style.display = 'none';
          navLinks.classList.remove('active');
        }
      }
      
      // Initial check
      checkMobile();
      window.addEventListener('resize', checkMobile);
      
      // Toggle menu on click
      navToggle.addEventListener('click', (e) => {
        e.stopPropagation();
        navLinks.classList.toggle('active');
        const icon = navToggle.querySelector('i');
        if (icon) {
          if (navLinks.classList.contains('active')) {
            icon.setAttribute('data-lucide', 'x');
          } else {
            icon.setAttribute('data-lucide', 'menu');
          }
          if (typeof lucide !== 'undefined' && lucide.createIcons) {
            lucide.createIcons();
          }
        }
      });
      
      // Close menu when clicking outside
      document.addEventListener('click', (e) => {
        if (!navLinks.contains(e.target) && !navToggle.contains(e.target)) {
          navLinks.classList.remove('active');
          const icon = navToggle.querySelector('i');
          if (icon) {
            icon.setAttribute('data-lucide', 'menu');
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
              lucide.createIcons();
            }
          }
        }
      });
      
      // Close menu when clicking a link
      navLinks.querySelectorAll('a, button').forEach(item => {
        item.addEventListener('click', () => {
          navLinks.classList.remove('active');
          const icon = navToggle.querySelector('i');
          if (icon) {
            icon.setAttribute('data-lucide', 'menu');
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
              lucide.createIcons();
            }
          }
        });
      });
    }
    
    // Initialize navigation
    setupNavigation();
    setupMobileNav();

    // Create posting link is now a nav link, no need for click handler
    
    let allPostings = [];
    let filteredPostings = [];
    let searchTimeout;
    let currentPage = 1;
    let totalPages = 1;
    let isLoadingMore = false;
    let hasMorePages = true;
    
    // Load all postings from API with loading spinner
    async function loadPostings() {
      try {
        const grid = document.getElementById('productsGrid');
        const emptyState = document.getElementById('emptyState');
        
        // Show loading spinner with null checks
        if (grid) {
        grid.innerHTML = `
            <div class="loading-overlay" style="grid-column: 1 / -1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: var(--spacing-2xl); min-height: 300px;">
              <div class="loading-spinner"></div>
              <p style="margin-top: var(--spacing-md); color: var(--color-text-light);">Loading postings...</p>
            </div>
          `;
        }
        
        if (emptyState) {
        emptyState.style.display = 'none';
        }
        
        console.log('ðŸ”„ Loading postings from API...');
        const data = await fetchPostings({ page: currentPage, limit: 20 });
        console.log('âœ… Received postings data:', data);
        
        allPostings = data.postings || [];
        filteredPostings = [...allPostings];
        totalPages = data.pagination?.totalPages || 1;
        hasMorePages = currentPage < totalPages;
        
        console.log(`ðŸ“¦ Loaded ${allPostings.length} postings (total: ${data.pagination?.total || 0})`);
        renderPostings();
        setupInfiniteScroll();
      } catch (error) {
        console.error('âŒ Error loading postings:', error);
        const grid = document.getElementById('productsGrid');
        if (grid) {
        grid.innerHTML = `
          <div class="empty-state" style="grid-column: 1 / -1; text-align: center; padding: var(--spacing-xxl);">
              <i data-lucide="alert-circle" style="width: 4rem; height: 4rem; margin: 0 auto var(--spacing-md); color: var(--color-text-light); display: block;"></i>
            <h3 style="margin-bottom: var(--spacing-xs);">Error loading postings</h3>
            <p style="color: var(--color-text-light); margin-bottom: var(--spacing-md);">Please refresh the page or try again later.</p>
            <button class="btn btn-primary" onclick="location.reload()" style="display: inline-flex;">
              <i data-lucide="refresh-cw" class="btn-icon"></i>
              Refresh Page
            </button>
          </div>
        `;
        if (typeof lucide !== 'undefined' && lucide.createIcons) {
          lucide.createIcons();
          }
        }
      }
    }
    
    // Render postings with null checks
    function renderPostings() {
      const grid = document.getElementById('productsGrid');
      const emptyState = document.getElementById('emptyState');
      
      if (!grid) {
        console.error('Products grid not found');
        return;
      }
      
      if (filteredPostings.length === 0) {
        grid.style.display = 'none';
        if (emptyState) {
        emptyState.style.display = 'block';
        }
        // Re-initialize icons for empty state
        if (typeof lucide !== 'undefined' && lucide.createIcons) {
          lucide.createIcons();
        }
        return;
      }
      
      grid.style.display = 'grid';
      if (emptyState) {
      emptyState.style.display = 'none';
      }
      
      if (typeof renderPostingsAsProducts === 'function') {
      renderPostingsAsProducts(filteredPostings, grid);
      } else {
        console.error('renderPostingsAsProducts function not found');
        grid.innerHTML = '<p class="empty-state">Error rendering postings. Please refresh the page.</p>';
      }
      
      // Remove existing loading indicator
      const existingLoader = document.getElementById('infiniteScrollLoader');
      if (existingLoader) {
        existingLoader.remove();
      }
      
      // Add loading indicator if there are more pages
      if (hasMorePages && !isLoadingMore) {
        const loader = document.createElement('div');
        loader.id = 'infiniteScrollLoader';
        loader.className = 'infinite-scroll-loader';
        loader.style.cssText = 'grid-column: 1 / -1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: var(--spacing-xl);';
        loader.innerHTML = `
          <div class="loading-spinner"></div>
          <p style="margin-top: var(--spacing-sm); color: var(--color-text-light); font-size: var(--font-size-sm);">Loading more...</p>
        `;
        grid.appendChild(loader);
      }
    }
    
    // ============================================
    // INFINITE SCROLL FUNCTIONALITY
    // ============================================
    function setupInfiniteScroll() {
      // Remove existing scroll listener
      window.removeEventListener('scroll', handleInfiniteScroll);
      
      // Add new scroll listener
      window.addEventListener('scroll', handleInfiniteScroll, { passive: true });
    }
    
    async function handleInfiniteScroll() {
      // Don't load if already loading or no more pages
      if (isLoadingMore || !hasMorePages) return;
      
      // Check if user is near bottom (within 300px)
      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      const windowHeight = window.innerHeight;
      const documentHeight = document.documentElement.scrollHeight;
      
      if (scrollTop + windowHeight >= documentHeight - 300) {
        await loadMorePostings();
      }
    }
    
    async function loadMorePostings() {
      if (isLoadingMore || !hasMorePages) return;
      
      isLoadingMore = true;
      const nextPage = currentPage + 1;
      
      try {
        const query = searchInput ? searchInput.value.trim() : '';
        const category = activeFilter === 'all' ? null : activeFilter;
        
        // Get advanced filter values
        const priceMin = document.getElementById('priceRangeMin')?.value;
        const priceMax = document.getElementById('priceRangeMax')?.value;
        const location = document.getElementById('locationFilter')?.value;
        const vinVerified = document.getElementById('vinFilter')?.value;
        
        console.log(`ðŸ”„ Loading page ${nextPage}...`);
        const data = await fetchPostings({ 
          category: category, 
          search: query || undefined,
          page: nextPage,
          limit: 20
        });
        
        let newPostings = data.postings || [];
        
        // Apply client-side filters (price, location, VIN)
        if (priceMin) {
          newPostings = newPostings.filter(p => parseFloat(p.price || 0) >= parseFloat(priceMin));
        }
        if (priceMax) {
          newPostings = newPostings.filter(p => parseFloat(p.price || 0) <= parseFloat(priceMax));
        }
        if (location) {
          newPostings = newPostings.filter(p => 
            p.location?.toLowerCase().includes(location.toLowerCase()) ||
            p.city?.toLowerCase().includes(location.toLowerCase())
          );
        }
        if (vinVerified === 'verified') {
          newPostings = newPostings.filter(p => p.vin_verified === true);
        }
        
        if (newPostings.length > 0) {
          // Append new postings
          allPostings = [...allPostings, ...newPostings];
          filteredPostings = [...filteredPostings, ...newPostings];
          currentPage = nextPage;
          totalPages = data.pagination?.totalPages || 1;
          hasMorePages = currentPage < totalPages;
          
          // Render new postings
          const grid = document.getElementById('productsGrid');
          if (grid && typeof renderPostingsAsProducts === 'function') {
            renderPostingsAsProducts(filteredPostings, grid);
          }
          
          // Update results count
          const resultsCountNumber = document.getElementById('resultsCountNumber');
          if (resultsCountNumber) {
            resultsCountNumber.textContent = filteredPostings.length;
          }
          
          console.log(`âœ… Loaded ${newPostings.length} more postings (total: ${filteredPostings.length})`);
        } else {
          hasMorePages = false;
        }
      } catch (error) {
        console.error('âŒ Error loading more postings:', error);
        hasMorePages = false;
      } finally {
        isLoadingMore = false;
      }
    }
    
    // Notification helper
    function showNotification(message) {
      const notification = document.createElement('div');
      notification.className = 'notification';
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }
    
    // Search functionality with null checks
    const searchInput = document.getElementById('searchInput');
    const searchClear = document.getElementById('searchClear');
    
    if (searchInput) {
    searchInput.addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      const query = e.target.value.toLowerCase().trim();
      
        if (searchClear) {
      if (query) {
        searchClear.style.display = 'block';
      } else {
        searchClear.style.display = 'none';
          }
      }
      
      searchTimeout = setTimeout(() => {
        applyFilters();
      }, 300);
    });
    }
    
    if (searchClear) {
    searchClear.addEventListener('click', () => {
        if (searchInput) {
      searchInput.value = '';
        }
      searchClear.style.display = 'none';
      applyFilters();
    });
    }
    
    // Filter tabs
    const filterTabs = document.querySelectorAll('.filter-tab');
    let activeFilter = 'all';
    
    filterTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        filterTabs.forEach(t => {
          t.classList.remove('active');
          t.setAttribute('aria-selected', 'false');
        });
        tab.classList.add('active');
        tab.setAttribute('aria-selected', 'true');
        activeFilter = tab.dataset.filter;
        applyFilters();
      });
    });
    
    // Apply filters with loading spinner and advanced filters
    async function applyFilters() {
      const query = searchInput ? searchInput.value.trim() : '';
      const category = activeFilter === 'all' ? null : activeFilter;
      
      // Get advanced filter values
      const priceMin = document.getElementById('priceRangeMin')?.value;
      const priceMax = document.getElementById('priceRangeMax')?.value;
      const location = document.getElementById('locationFilter')?.value;
      const vinVerified = document.getElementById('vinFilter')?.value;
      
      try {
        const grid = document.getElementById('productsGrid');
        const emptyState = document.getElementById('emptyState');
        
        // Show loading spinner
        if (grid) {
        grid.innerHTML = `
            <div class="loading-overlay" style="grid-column: 1 / -1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: var(--spacing-2xl); min-height: 300px;">
              <div class="loading-spinner"></div>
              <p style="margin-top: var(--spacing-md); color: var(--color-text-light);">Loading postings...</p>
            </div>
          `;
        }
        
        if (emptyState) {
          emptyState.style.display = 'none';
        }
        
        console.log('ðŸ” Applying filters - Category:', category, 'Search:', query, 'Price:', priceMin, '-', priceMax, 'Location:', location);
        const data = await fetchPostings({ 
          category: category, 
          search: query || undefined,
          page: 1,
          limit: 20
        });
        console.log('âœ… Filter results:', data.postings?.length || 0, 'postings');
        
        let postings = data.postings || [];
        
        // Apply client-side filters (price, location, VIN)
        if (priceMin) {
          postings = postings.filter(p => parseFloat(p.price || 0) >= parseFloat(priceMin));
        }
        if (priceMax) {
          postings = postings.filter(p => parseFloat(p.price || 0) <= parseFloat(priceMax));
        }
        if (location) {
          postings = postings.filter(p => 
            p.location?.toLowerCase().includes(location.toLowerCase()) ||
            p.city?.toLowerCase().includes(location.toLowerCase())
          );
        }
        if (vinVerified === 'verified') {
          postings = postings.filter(p => p.vin_verified === true);
        }
        
        allPostings = postings;
        filteredPostings = [...postings];
        totalPages = data.pagination?.totalPages || 1;
        currentPage = 1;
        hasMorePages = currentPage < totalPages;
        
        // Update results count
        const resultsCountNumber = document.getElementById('resultsCountNumber');
        if (resultsCountNumber) {
          resultsCountNumber.textContent = filteredPostings.length;
        }
        
        renderPostings();
        setupInfiniteScroll();
      } catch (error) {
        console.error('âŒ Error applying filters:', error);
        const grid = document.getElementById('productsGrid');
        if (grid) {
          grid.innerHTML = `
            <div class="empty-state" style="grid-column: 1 / -1; text-align: center; padding: var(--spacing-xxl);">
              <i data-lucide="alert-circle" style="width: 4rem; height: 4rem; margin: 0 auto var(--spacing-md); color: var(--color-text-light); display: block;"></i>
              <h3 style="margin-bottom: var(--spacing-xs);">Error loading postings</h3>
              <p style="color: var(--color-text-light); margin-bottom: var(--spacing-md);">Please try again later.</p>
              <button class="btn btn-primary" onclick="location.reload()" style="display: inline-flex;">
                <i data-lucide="refresh-cw" class="btn-icon"></i>
                Refresh Page
              </button>
            </div>
          `;
          if (typeof lucide !== 'undefined' && lucide.createIcons) {
            lucide.createIcons();
          }
        }
        if (typeof showNotification === 'function') {
        showNotification('Error applying filters');
        }
      }
    }
    
    // Initialize Contact Seller modal (after DOM is ready)
    function initializeContactModal() {
      // Try to use external modal script if available
      if (typeof window.initContactSellerModal === 'function') {
        window.initContactSellerModal();
      } else if (typeof initContactSellerModal === 'function') {
        initContactSellerModal();
      } else {
        console.warn('initContactSellerModal function not found, using inline fallback');
      }
      
      // Safe inline fallback modal functionality
      const overlay = document.getElementById('contactModalOverlay');
      const closeBtn = document.getElementById('contactModalClose');
      const cancelBtn = document.getElementById('contactModalCancel');
      const form = document.getElementById('contactModalForm');
      
      if (!overlay) {
        console.error('Contact modal overlay not found');
        return;
      }
      
      // Close modal on overlay click
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          overlay.classList.remove('open');
          document.body.style.overflow = '';
        }
      });
      
      // Close on X button
      if (closeBtn) {
        closeBtn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          overlay.classList.remove('open');
          document.body.style.overflow = '';
        });
      }
      
      // Close on Cancel button
      if (cancelBtn) {
        cancelBtn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          overlay.classList.remove('open');
          document.body.style.overflow = '';
        });
      }
      
      // Handle form submission
      if (form) {
        form.addEventListener('submit', (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          const messageInput = document.getElementById('contactModalMessage');
          const message = messageInput ? messageInput.value.trim() : '';
          
          if (!message) {
            alert('Please enter a message');
            return;
          }
          
          // Log to console
          console.log('Contact Seller form submitted:', {
            postingId: document.getElementById('contactModalPostingId')?.value,
            toUserId: document.getElementById('contactModalToUserId')?.value,
            message: message
          });
          
          // Show success message
          alert('Message sent!');
          
          // Close modal
          overlay.classList.remove('open');
          document.body.style.overflow = '';
          form.reset();
        });
      }
      
      // Close on ESC key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && overlay.classList.contains('open')) {
          overlay.classList.remove('open');
          document.body.style.overflow = '';
        }
      });
    }
    
    // Ensure openContactSellerModal exists as fallback
    if (typeof window.openContactSellerModal === 'undefined') {
      window.openContactSellerModal = function(options) {
        const overlay = document.getElementById('contactModalOverlay');
        if (!overlay) {
          console.error('Contact modal overlay not found');
          return;
        }
        
        const postingIdInput = document.getElementById('contactModalPostingId');
        const toUserIdInput = document.getElementById('contactModalToUserId');
        const messageInput = document.getElementById('contactModalMessage');
        const errorDiv = document.getElementById('contactModalError');
        
        if (postingIdInput && options.postingId) {
          postingIdInput.value = options.postingId;
        }
        if (toUserIdInput && options.toUserId) {
          toUserIdInput.value = options.toUserId;
        }
        if (messageInput) {
          messageInput.value = '';
        }
        if (errorDiv) {
          errorDiv.style.display = 'none';
          errorDiv.textContent = '';
        }
        
        overlay.classList.add('open');
        document.body.style.overflow = 'hidden';
        
        if (messageInput) {
          setTimeout(() => messageInput.focus(), 100);
        }
      };
    }
    
    // Initialize modal when page loads
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeContactModal);
    } else {
      initializeContactModal();
    }

    // ============================================
    // ADVANCED FILTERS FUNCTIONALITY
    // ============================================
    (function initAdvancedFilters() {
      const showAdvancedBtn = document.getElementById('showAdvancedFilters');
      const toggleAdvancedBtn = document.getElementById('toggleAdvancedFilters');
      const advancedPanel = document.getElementById('advancedFiltersPanel');
      const priceSlider = document.getElementById('priceSlider');
      const priceSliderValue = document.getElementById('priceSliderValue');
      const priceRangeMin = document.getElementById('priceRangeMin');
      const priceRangeMax = document.getElementById('priceRangeMax');
      const applyAdvancedBtn = document.getElementById('applyAdvancedFilters');
      const resetFiltersBtn = document.getElementById('resetFilters');
      const locationFilter = document.getElementById('locationFilter');
      const useLocationBtn = document.getElementById('useLocationBtn');
      const vinFilter = document.getElementById('vinFilter');
      const vehicleMake = document.getElementById('vehicleMake');
      const vehicleModel = document.getElementById('vehicleModel');
      const vehicleYear = document.getElementById('vehicleYear');
      const checkCompatibilityBtn = document.getElementById('checkCompatibility');
      const compatibilityGroup = document.getElementById('compatibilityFilterGroup');
      
      // Toggle advanced filters panel
      if (showAdvancedBtn && advancedPanel) {
        showAdvancedBtn.addEventListener('click', () => {
          advancedPanel.style.display = advancedPanel.style.display === 'none' ? 'block' : 'none';
          showAdvancedBtn.style.display = advancedPanel.style.display === 'none' ? 'inline-flex' : 'none';
          if (typeof lucide !== 'undefined' && lucide.createIcons) {
            lucide.createIcons();
          }
        });
      }
      
      if (toggleAdvancedBtn && advancedPanel && showAdvancedBtn) {
        toggleAdvancedBtn.addEventListener('click', () => {
          advancedPanel.style.display = 'none';
          showAdvancedBtn.style.display = 'inline-flex';
          if (typeof lucide !== 'undefined' && lucide.createIcons) {
            lucide.createIcons();
          }
        });
      }
      
      // Price slider updates
      if (priceSlider && priceSliderValue) {
        priceSlider.addEventListener('input', (e) => {
          const value = parseInt(e.target.value);
          priceSliderValue.textContent = `$${value.toLocaleString()}`;
          if (priceRangeMax) {
            priceRangeMax.value = value;
          }
        });
      }
      
      // Price range inputs sync with slider
      if (priceRangeMin && priceRangeMax && priceSlider) {
        priceRangeMin.addEventListener('input', (e) => {
          const min = parseInt(e.target.value) || 0;
          if (min > parseInt(priceRangeMax.value || priceSlider.max)) {
            priceRangeMax.value = min;
          }
        });
        
        priceRangeMax.addEventListener('input', (e) => {
          const max = parseInt(e.target.value) || priceSlider.max;
          if (priceSlider) {
            priceSlider.value = Math.min(max, parseInt(priceSlider.max));
            if (priceSliderValue) {
              priceSliderValue.textContent = `$${parseInt(priceSlider.value).toLocaleString()}`;
            }
          }
        });
      }
      
      // Apply advanced filters
      if (applyAdvancedBtn) {
        applyAdvancedBtn.addEventListener('click', () => {
          applyFilters();
          if (advancedPanel) {
            advancedPanel.style.display = 'none';
          }
          if (showAdvancedBtn) {
            showAdvancedBtn.style.display = 'inline-flex';
          }
        });
      }
      
      // Reset filters
      if (resetFiltersBtn) {
        resetFiltersBtn.addEventListener('click', () => {
          if (priceRangeMin) priceRangeMin.value = '';
          if (priceRangeMax) priceRangeMax.value = '';
          if (priceSlider) {
            priceSlider.value = 50000;
            if (priceSliderValue) {
              priceSliderValue.textContent = '$50,000';
            }
          }
          if (locationFilter) locationFilter.value = '';
          if (vinFilter) vinFilter.value = '';
          if (vehicleMake) vehicleMake.value = '';
          if (vehicleModel) vehicleModel.value = '';
          if (vehicleYear) vehicleYear.value = '';
          if (vehicleModel) vehicleModel.disabled = true;
          if (vehicleYear) vehicleYear.disabled = true;
          if (checkCompatibilityBtn) checkCompatibilityBtn.disabled = true;
          applyFilters();
        });
      }
      
      // Use location button
      if (useLocationBtn) {
        useLocationBtn.addEventListener('click', () => {
          if (!navigator.geolocation) {
            alert('Geolocation is not supported by your browser');
            return;
          }
          
          useLocationBtn.disabled = true;
          useLocationBtn.innerHTML = '<div class="loading-spinner" style="width: 16px; height: 16px; margin: 0 auto;"></div>';
          
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const lat = position.coords.latitude;
              const lng = position.coords.longitude;
              
              // Reverse geocode to get address (in production, use a geocoding API)
              if (locationFilter) {
                locationFilter.value = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
              }
              
              // Show map container
              const mapContainer = document.getElementById('locationMapContainer');
              if (mapContainer) {
                mapContainer.style.display = 'block';
                // In production, initialize Google Maps or Mapbox here
                // Example: initializeMap('locationMap', lat, lng);
              }
              
              useLocationBtn.disabled = false;
              useLocationBtn.innerHTML = '<i data-lucide="map-pin" class="btn-icon"></i> Use My Location';
              if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
              }
              
              applyFilters();
            },
            (error) => {
              console.error('Geolocation error:', error);
              alert('Unable to get your location. Please enter it manually.');
              useLocationBtn.disabled = false;
              useLocationBtn.innerHTML = '<i data-lucide="map-pin" class="btn-icon"></i> Use My Location';
              if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
              }
            }
          );
        });
      }
      
      // Vehicle compatibility checker
      if (vehicleMake) {
        vehicleMake.addEventListener('change', (e) => {
          const make = e.target.value;
          if (vehicleModel) {
            vehicleModel.disabled = !make;
            vehicleModel.innerHTML = '<option value="">Select Model</option>';
            
            // Load models based on make (demo data)
            if (make) {
              const models = {
                'Toyota': ['Camry', 'Corolla', 'RAV4', 'Highlander', 'Prius'],
                'Honda': ['Civic', 'Accord', 'CR-V', 'Pilot', 'Odyssey'],
                'Ford': ['F-150', 'Mustang', 'Explorer', 'Escape', 'Edge'],
                'Chevrolet': ['Silverado', 'Malibu', 'Equinox', 'Tahoe', 'Traverse'],
                'BMW': ['3 Series', '5 Series', 'X3', 'X5', 'X7'],
                'Mercedes-Benz': ['C-Class', 'E-Class', 'GLC', 'GLE', 'S-Class']
              };
              
              const makeModels = models[make] || [];
              makeModels.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                vehicleModel.appendChild(option);
              });
            }
          }
          if (vehicleYear) vehicleYear.disabled = true;
          if (checkCompatibilityBtn) checkCompatibilityBtn.disabled = true;
        });
      }
      
      if (vehicleModel) {
        vehicleModel.addEventListener('change', (e) => {
          const model = e.target.value;
          if (vehicleYear) {
            vehicleYear.disabled = !model;
            vehicleYear.innerHTML = '<option value="">Select Year</option>';
            
            // Load years (2015-2025)
            if (model) {
              for (let year = 2025; year >= 2015; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                vehicleYear.appendChild(option);
              }
            }
          }
          if (checkCompatibilityBtn) checkCompatibilityBtn.disabled = true;
        });
      }
      
      if (vehicleYear) {
        vehicleYear.addEventListener('change', (e) => {
          const year = e.target.value;
          if (checkCompatibilityBtn) {
            checkCompatibilityBtn.disabled = !year;
          }
        });
      }
      
      // Show compatibility filter only for Parts category
      const filterTabs = document.querySelectorAll('.filter-tab');
      filterTabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const category = tab.dataset.filter;
          if (compatibilityGroup) {
            compatibilityGroup.style.display = category === 'Parts' ? 'block' : 'none';
          }
        });
      });
      
      // Check compatibility button
      if (checkCompatibilityBtn) {
        checkCompatibilityBtn.addEventListener('click', () => {
          const make = vehicleMake?.value;
          const model = vehicleModel?.value;
          const year = vehicleYear?.value;
          
          if (!make || !model || !year) {
            alert('Please select make, model, and year');
            return;
          }
          
          // Show loading state
          checkCompatibilityBtn.disabled = true;
          checkCompatibilityBtn.innerHTML = '<div class="loading-spinner" style="width: 16px; height: 16px; margin: 0 auto;"></div> Checking...';
          
          // Simulate compatibility check (in production, call API)
          setTimeout(() => {
            alert(`Compatible parts found for ${year} ${make} ${model}! Filters updated.`);
            applyFilters();
            
            checkCompatibilityBtn.disabled = false;
            checkCompatibilityBtn.innerHTML = '<i data-lucide="check-circle" class="btn-icon"></i> Check Compatibility';
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
              lucide.createIcons();
            }
          }, 1000);
        });
      }
    })();

    // ============================================
    // SOCIAL SHARING FUNCTIONALITY
    // ============================================
    (function initSocialSharing() {
      // Social share dropdown toggle
      document.addEventListener('click', (e) => {
        const shareBtn = e.target.closest('.social-share-btn');
        const shareMenu = e.target.closest('.social-share-menu');
        
        // Close all menus
        document.querySelectorAll('.social-share-menu').forEach(menu => {
          menu.style.display = 'none';
          const btn = menu.previousElementSibling;
          if (btn) btn.setAttribute('aria-expanded', 'false');
        });
        
        // Open clicked menu
        if (shareBtn) {
          e.stopPropagation();
          const menu = shareBtn.nextElementSibling;
          if (menu && menu.classList.contains('social-share-menu')) {
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
            shareBtn.setAttribute('aria-expanded', menu.style.display !== 'none');
          }
        } else if (!shareMenu) {
          // Clicked outside - menus already closed above
        }
      });
      
      // Handle social sharing
      document.addEventListener('click', (e) => {
        const shareLink = e.target.closest('.social-share-link');
        if (!shareLink) return;
        
        e.preventDefault();
        const platform = shareLink.dataset.platform;
        const postingId = shareLink.dataset.postingId;
        const url = `${window.location.origin}/posting-detail.html?id=${postingId}`;
        const title = document.title;
        const text = `Check out this listing on Autoilty: ${url}`;
        
        // Get posting details from global storage
        const posting = window.currentPostings?.find(p => p.id === postingId);
        const postingTitle = posting?.title || 'Great listing';
        const postingText = `Check out "${postingTitle}" on Autoilty`;
        
        switch (platform) {
          case 'facebook':
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`, '_blank', 'width=600,height=400');
            break;
          case 'twitter':
            window.open(`https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}&text=${encodeURIComponent(postingText)}`, '_blank', 'width=600,height=400');
            break;
          case 'whatsapp':
            window.open(`https://wa.me/?text=${encodeURIComponent(postingText + ' ' + url)}`, '_blank');
            break;
          case 'copy':
            navigator.clipboard.writeText(url).then(() => {
              if (typeof showNotification === 'function') {
                showNotification('Link copied to clipboard!');
              } else {
                alert('Link copied to clipboard!');
              }
            }).catch(() => {
              alert('Failed to copy link');
            });
            break;
        }
        
        // Close menu
        const menu = shareLink.closest('.social-share-menu');
        if (menu) {
          menu.style.display = 'none';
          const btn = menu.previousElementSibling;
          if (btn) btn.setAttribute('aria-expanded', 'false');
        }
      });
    })();

    // ============================================
    // BUY NOW (STRIPE PAYMENT) FUNCTIONALITY
    // ============================================
    (function initBuyNow() {
      document.addEventListener('click', (e) => {
        const buyBtn = e.target.closest('.buy-now-btn');
        if (!buyBtn) return;
        
        e.stopPropagation();
        const postingId = buyBtn.dataset.postingId;
        const price = buyBtn.dataset.price;
        
        // Check if user is authenticated
        if (typeof isAuthenticated === 'function' && !isAuthenticated()) {
          const returnUrl = encodeURIComponent(window.location.pathname + window.location.search);
          window.location.href = `login.html?return=${returnUrl}`;
          return;
        }
        
        // Check localStorage for auth
        const token = localStorage.getItem('auth_token') || localStorage.getItem('token');
        if (!token) {
          const returnUrl = encodeURIComponent(window.location.pathname + window.location.search);
          window.location.href = `login.html?return=${returnUrl}`;
          return;
        }
        
        // Confirm purchase
        const posting = window.currentPostings?.find(p => p.id === postingId);
        const postingName = posting?.title || 'This item';
        
        if (!confirm(`Buy "${postingName}" for $${parseFloat(price).toFixed(2)} CAD?`)) {
          return;
        }
        
        // Show loading state
        buyBtn.disabled = true;
        const originalText = buyBtn.innerHTML;
        buyBtn.innerHTML = '<div class="loading-spinner" style="width: 16px; height: 16px; margin: 0 auto;"></div> Processing...';
        
        // In production, this would call Stripe API
        // For now, simulate payment processing
        setTimeout(() => {
          // Redirect to checkout page with Stripe
          window.location.href = `checkout.html?posting=${postingId}&price=${price}`;
        }, 500);
      });
    })();

    // ============================================
    // VIN VERIFICATION FUNCTIONALITY
    // ============================================
    (function initVINVerification() {
      // Add VIN verification to listings when VIN field is present
      document.addEventListener('DOMContentLoaded', () => {
        // This would typically be called when a posting with VIN is displayed
        // For now, we'll add verification badges when postings are rendered
      });
      
      // VIN verification API call (demo)
      window.verifyVIN = async function(vin) {
        if (!vin || vin.length !== 17) {
          return { verified: false, error: 'Invalid VIN format' };
        }
        
        try {
          // In production, call VIN verification API
          // For now, simulate verification
          await new Promise(resolve => setTimeout(resolve, 1000));
          
          return {
            verified: true,
            make: 'Toyota',
            model: 'Camry',
            year: '2020',
            engine: '2.5L 4-Cylinder',
            transmission: 'Automatic'
          };
        } catch (error) {
          console.error('VIN verification error:', error);
          return { verified: false, error: 'Verification failed' };
        }
      };
    })();

    // ============================================
    // AUTO PART COMPATIBILITY CHECKER
    // ============================================
    (function initCompatibilityChecker() {
      window.checkPartCompatibility = async function(partId, vehicleMake, vehicleModel, vehicleYear) {
        if (!vehicleMake || !vehicleModel || !vehicleYear) {
          return { compatible: false, error: 'Vehicle information required' };
        }
        
        try {
          // In production, call compatibility API
          // For now, simulate compatibility check
          await new Promise(resolve => setTimeout(resolve, 1000));
          
          // Demo: 70% chance of compatibility
          const compatible = Math.random() > 0.3;
          
          return {
            compatible: compatible,
            message: compatible 
              ? `This part is compatible with ${vehicleYear} ${vehicleMake} ${vehicleModel}`
              : `This part may not be compatible with ${vehicleYear} ${vehicleMake} ${vehicleModel}. Please verify.`,
            alternatives: compatible ? [] : [
              'Alternative Part A - $299.99',
              'Alternative Part B - $349.99'
            ]
          };
        } catch (error) {
          console.error('Compatibility check error:', error);
          return { compatible: false, error: 'Compatibility check failed' };
        }
      };
    })();

    // ============================================
    // SIMILAR POSTINGS FUNCTIONALITY
    // ============================================
    (function initSimilarPostings() {
      window.loadSimilarPostings = async function(postingId, category) {
        try {
          // Get similar postings based on category, price range, etc.
          const currentPosting = window.currentPostings?.find(p => p.id === postingId);
          if (!currentPosting) return [];
          
          // Filter similar postings (same category, similar price range)
          const similar = window.currentPostings
            ?.filter(p => 
              p.id !== postingId && 
              p.category === currentPosting.category &&
              Math.abs(parseFloat(p.price) - parseFloat(currentPosting.price)) < 5000
            )
            .slice(0, 3) || [];
          
          return similar;
        } catch (error) {
          console.error('Error loading similar postings:', error);
          return [];
        }
      };
      
      // Show similar postings on hover or click
      document.addEventListener('mouseenter', (e) => {
        const card = e.target.closest('.product-card');
        if (!card) return;
        
        const postingId = card.dataset.productId;
        const similarContainer = card.querySelector('.similar-postings');
        if (!similarContainer || similarContainer.style.display !== 'none') return;
        
        // Load similar postings
        const category = card.querySelector('.product-category')?.textContent?.toLowerCase();
        loadSimilarPostings(postingId, category).then(similar => {
          if (similar.length > 0 && similarContainer) {
            const similarList = similarContainer.querySelector('.similar-postings-list');
            if (similarList) {
              similarList.innerHTML = similar.map(post => {
                const product = postingToProduct(post);
                return `
                  <a href="posting-detail.html?id=${product.id}" style="display: flex; align-items: center; gap: var(--spacing-sm); padding: var(--spacing-sm); border-radius: var(--radius); transition: background 0.2s; text-decoration: none; color: var(--color-text);" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='transparent'">
                    <img src="${product.image}" alt="${product.name}" style="width: 60px; height: 60px; object-fit: cover; border-radius: var(--radius);">
                    <div style="flex: 1; min-width: 0;">
                      <p style="font-size: 0.875rem; font-weight: 500; margin: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${product.name}</p>
                      <p style="font-size: 0.75rem; color: var(--color-text-light); margin: 0.25rem 0 0 0;">$${product.price.toFixed(2)} CAD</p>
                    </div>
                  </a>
                `;
              }).join('');
              
              similarContainer.style.display = 'block';
            }
          }
        });
      }, true);
    })();

    // ============================================
    // TOP DEALS FUNCTIONALITY
    // ============================================
    (function loadTopDeals() {
      const topDealsSection = document.getElementById('topDealsSection');
      const topDealsGrid = document.getElementById('topDealsGrid');
      
      if (!topDealsSection || !topDealsGrid) return;
      
      async function loadDeals() {
        try {
          // Fetch top deals (in production, call API with is_top_deal=true or admin_curated=true)
          const data = await fetchPostings({ page: 1, limit: 4 });
          
          // Filter or mark top deals (in production, API would return is_top_deal flag)
          const topDeals = (data.postings || [])
            .slice(0, 4)
            .map(post => ({ ...post, is_top_deal: true }));
          
          if (topDeals.length === 0) {
            topDealsSection.style.display = 'none';
            return;
          }
          
          topDealsSection.style.display = 'block';
          
          // Render top deals
          if (typeof renderPostingsAsProducts === 'function') {
            renderPostingsAsProducts(topDeals, topDealsGrid);
          } else {
            topDealsGrid.innerHTML = '<p class="empty-state">Loading top deals...</p>';
          }
          
        } catch (error) {
          console.error('Error loading top deals:', error);
          topDealsSection.style.display = 'none';
        }
      }
      
      // Load top deals after main postings
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          setTimeout(loadDeals, 500); // Wait for main postings to load
        });
      } else {
        setTimeout(loadDeals, 500);
      }
    })();

    // ============================================
    // VIEW TOGGLE (GRID/LIST) FUNCTIONALITY
    // ============================================
    (function initViewToggle() {
      const viewToggle = document.getElementById('viewToggle');
      const viewToggleIcon = document.getElementById('viewToggleIcon');
      const viewToggleText = document.getElementById('viewToggleText');
      const productsGrid = document.getElementById('productsGrid');
      let isGridView = true;
      
      if (!viewToggle || !productsGrid) return;
      
      viewToggle.addEventListener('click', () => {
        isGridView = !isGridView;
        
        if (isGridView) {
          productsGrid.className = 'products-grid';
          if (viewToggleIcon) {
            viewToggleIcon.setAttribute('data-lucide', 'layout-grid');
          }
          if (viewToggleText) {
            viewToggleText.textContent = 'Grid';
          }
        } else {
          productsGrid.className = 'products-list';
          if (viewToggleIcon) {
            viewToggleIcon.setAttribute('data-lucide', 'list');
          }
          if (viewToggleText) {
            viewToggleText.textContent = 'List';
          }
        }
        
        if (typeof lucide !== 'undefined' && lucide.createIcons) {
          lucide.createIcons();
        }
      });
    })();
    
    // ============================================
    // FILTER DRAWER FUNCTIONALITY (MOBILE)
    // ============================================
    (function initFilterDrawer() {
      const filterToggleBtn = document.getElementById('filterToggleBtn');
      const filterDrawer = document.getElementById('filterDrawer');
      const filterDrawerOverlay = document.getElementById('filterDrawerOverlay');
      const filterDrawerClose = document.getElementById('filterDrawerClose');
      const drawerApplyFilters = document.getElementById('drawerApplyFilters');
      const drawerResetFilters = document.getElementById('drawerResetFilters');
      
      function openDrawer() {
        if (filterDrawer && filterDrawerOverlay) {
          filterDrawer.classList.add('open');
          filterDrawerOverlay.classList.add('open');
          document.body.style.overflow = 'hidden';
        }
      }
      
      function closeDrawer() {
        if (filterDrawer && filterDrawerOverlay) {
          filterDrawer.classList.remove('open');
          filterDrawerOverlay.classList.remove('open');
          document.body.style.overflow = '';
        }
      }
      
      if (filterToggleBtn) {
        filterToggleBtn.addEventListener('click', openDrawer);
      }
      
      if (filterDrawerClose) {
        filterDrawerClose.addEventListener('click', closeDrawer);
      }
      
      if (filterDrawerOverlay) {
        filterDrawerOverlay.addEventListener('click', closeDrawer);
      }
      
      // Close drawer on ESC key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && filterDrawer && filterDrawer.classList.contains('open')) {
          closeDrawer();
        }
      });
      
      // Apply filters from drawer
      if (drawerApplyFilters) {
        drawerApplyFilters.addEventListener('click', () => {
          // Sync drawer values with main filter inputs
          const drawerPriceMin = document.getElementById('drawerPriceMin');
          const drawerPriceMax = document.getElementById('drawerPriceMax');
          const drawerLocation = document.getElementById('drawerLocation');
          const priceRangeMin = document.getElementById('priceRangeMin');
          const priceRangeMax = document.getElementById('priceRangeMax');
          const locationFilter = document.getElementById('locationFilter');
          
          if (drawerPriceMin && priceRangeMin) {
            priceRangeMin.value = drawerPriceMin.value;
          }
          if (drawerPriceMax && priceRangeMax) {
            priceRangeMax.value = drawerPriceMax.value;
          }
          if (drawerLocation && locationFilter) {
            locationFilter.value = drawerLocation.value;
          }
          
          // Sync category filter from drawer tabs
          const drawerActiveTab = filterDrawer.querySelector('.filter-tab.active');
          if (drawerActiveTab) {
            activeFilter = drawerActiveTab.dataset.filter;
            // Update main tabs
            document.querySelectorAll('.filter-tabs .filter-tab').forEach(tab => {
              tab.classList.remove('active');
              if (tab.dataset.filter === activeFilter) {
                tab.classList.add('active');
              }
            });
          }
          
          applyFilters();
          closeDrawer();
        });
      }
      
      // Reset filters in drawer
      if (drawerResetFilters) {
        drawerResetFilters.addEventListener('click', () => {
          const drawerPriceMin = document.getElementById('drawerPriceMin');
          const drawerPriceMax = document.getElementById('drawerPriceMax');
          const drawerLocation = document.getElementById('drawerLocation');
          
          if (drawerPriceMin) drawerPriceMin.value = '';
          if (drawerPriceMax) drawerPriceMax.value = '';
          if (drawerLocation) drawerLocation.value = '';
          
          // Reset category to "all"
          filterDrawer.querySelectorAll('.filter-tab').forEach(tab => {
            tab.classList.remove('active');
            if (tab.dataset.filter === 'all') {
              tab.classList.add('active');
            }
          });
        });
      }
      
      // Handle drawer filter tab clicks
      filterDrawer.querySelectorAll('.filter-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          filterDrawer.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
        });
      });
    })();
    
    // Load on page ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadPostings);
    } else {
      loadPostings();
    }
  </script>
</body>
</html>

