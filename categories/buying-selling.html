<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Buy and Sell Cars, Parts, and Accessories - Post free listings with photos in Canada's premier auto marketplace.">
    <meta name="keywords" content="buy cars Canada, sell car, auto parts, car marketplace, classified ads">
    <title>Buying & Selling Marketplace | Autoilty</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/forum.css">
    <link rel="stylesheet" href="../css/backlinks.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <a href="../index.html" class="brand">
                <span class="brand-name">AUTOILTY</span>
            </a>
            
            <div class="nav-links">
                <a href="../index.html" class="nav-link">Home</a>
                <a href="../forum.html" class="nav-link">Forum</a>
                <a href="buying-selling.html" class="nav-link active">Buy/Sell</a>
                <a href="../guides.html" class="nav-link">Guides</a>
                <a href="../tools.html" class="nav-link">Tools</a>
            </div>
            
            <button class="btn-primary" onclick="showSignupModal()" id="authBtn">Sign Up</button>
            <button class="btn-primary" onclick="showLoginModal()" id="loginBtn" style="background:#27ae60;">Login</button>
            <a href="../profile.html" class="btn-primary" id="profileBtn" style="display:none;">My Profile</a>
            <button class="btn-primary" onclick="logout()" id="logoutBtn" style="display:none;background:#e74c3c;">Logout</button>
            <button class="mobile-toggle" onclick="toggleMobileMenu()">☰</button>
        </div>
    </nav>

    <div class="page-header" style="background: linear-gradient(135deg, #27ae60 0%, #1e8449 100%);">
        <div class="container">
            <div class="breadcrumb">
                <a href="../index.html">Home</a> / <a href="../forum.html">Forum</a> / <span>Buying & Selling</span>
            </div>
            <h1>🛒 Buying & Selling Marketplace</h1>
            <p>Buy and Sell Cars, Parts & Accessories - Free Listings!</p>
            <button class="btn-hero" onclick="showPostModal()" style="background:#fff;color:#27ae60;padding:14px 32px;border:none;border-radius:8px;font-weight:600;font-size:16px;cursor:pointer;margin-top:20px;">
                📝 Post Free Listing
            </button>
        </div>
    </div>

    <div class="container" style="padding:48px 0;">
        <!-- Expiration Notifications -->
        <div id="expirationNotifications"></div>
        
        <!-- Filters -->
        <div style="background:#fff;padding:24px;border-radius:12px;margin-bottom:32px;box-shadow:0 2px 8px rgba(0,0,0,0.08);">
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;">
                <select id="categoryFilter" onchange="filterListings()" style="padding:12px;border:2px solid #e0e0e0;border-radius:8px;">
                    <option value="">All Categories</option>
                    <option value="cars">Cars & Trucks</option>
                    <option value="parts">Parts & Accessories</option>
                    <option value="wheels">Wheels & Tires</option>
                    <option value="audio">Audio & Electronics</option>
                    <option value="other">Other</option>
                </select>
                <select id="priceFilter" onchange="filterListings()" style="padding:12px;border:2px solid #e0e0e0;border-radius:8px;">
                    <option value="">Any Price</option>
                    <option value="0-5000">Under $5,000</option>
                    <option value="5000-15000">$5,000 - $15,000</option>
                    <option value="15000-30000">$15,000 - $30,000</option>
                    <option value="30000+">$30,000+</option>
                </select>
                <input type="text" id="searchInput" placeholder="Search listings..." onkeyup="filterListings()" style="padding:12px;border:2px solid #e0e0e0;border-radius:8px;">
            </div>
        </div>

        <!-- Listings Grid -->
        <div id="listingsContainer" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:24px;"></div>
    </div>

    <!-- Auth Modals (Signup and Login) -->
    <div id="signupModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:10000;align-items:center;justify-content:center;">
        <div style="background:#fff;padding:40px;border-radius:16px;max-width:450px;width:90%;">
            <h2 style="margin-bottom:24px;">Create Account</h2>
            <input type="text" id="signupUsername" placeholder="Username" style="width:100%;padding:12px;margin-bottom:16px;border:2px solid #e0e0e0;border-radius:8px;box-sizing:border-box;">
            <input type="email" id="signupEmail" placeholder="Email" style="width:100%;padding:12px;margin-bottom:16px;border:2px solid #e0e0e0;border-radius:8px;box-sizing:border-box;">
            <input type="password" id="signupPassword" placeholder="Password (min 6 characters)" style="width:100%;padding:12px;margin-bottom:16px;border:2px solid #e0e0e0;border-radius:8px;box-sizing:border-box;">
            <input type="password" id="signupConfirmPassword" placeholder="Confirm Password" style="width:100%;padding:12px;margin-bottom:16px;border:2px solid #e0e0e0;border-radius:8px;box-sizing:border-box;">
            <button onclick="handleSignup()" style="width:100%;padding:14px;background:#27ae60;color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;margin-bottom:12px;">Sign Up</button>
            <button onclick="closeSignupModal()" style="width:100%;padding:14px;background:#e0e0e0;color:#333;border:none;border-radius:8px;font-weight:600;cursor:pointer;margin-bottom:16px;">Cancel</button>
            <div style="text-align:center;padding-top:16px;border-top:1px solid #e0e0e0;">
                <p style="color:#666;margin-bottom:12px;">Already have an account?</p>
                <button onclick="closeSignupModal();showLoginModal();" style="padding:12px 24px;background:#27ae60;color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;">Login Here</button>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:10000;align-items:center;justify-content:center;">
        <div style="background:#fff;padding:40px;border-radius:16px;max-width:450px;width:90%;">
            <h2 style="margin-bottom:24px;">Login to Your Account</h2>
            <input type="text" id="loginUsername" placeholder="Username" style="width:100%;padding:12px;margin-bottom:16px;border:2px solid #e0e0e0;border-radius:8px;box-sizing:border-box;">
            <input type="password" id="loginPassword" placeholder="Password" style="width:100%;padding:12px;margin-bottom:16px;border:2px solid #e0e0e0;border-radius:8px;box-sizing:border-box;">
            <button onclick="handleLogin()" style="width:100%;padding:14px;background:#27ae60;color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;margin-bottom:12px;">Login</button>
            <button onclick="closeLoginModal()" style="width:100%;padding:14px;background:#e0e0e0;color:#333;border:none;border-radius:8px;font-weight:600;cursor:pointer;margin-bottom:16px;">Cancel</button>
            <div style="text-align:center;padding-top:16px;border-top:1px solid #e0e0e0;">
                <p style="color:#666;margin-bottom:12px;">Don't have an account?</p>
                <button onclick="closeLoginModal();showSignupModal();" style="padding:12px 24px;background:#27ae60;color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;">Sign Up Here</button>
            </div>
        </div>
    </div>

    <!-- Generic Auth Modal (Fallback for old function) -->
    <div id="authModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:10000;align-items:center;justify-content:center;">
        <div style="background:#fff;padding:40px;border-radius:16px;max-width:400px;width:90%;">
            <h2 style="margin-bottom:24px;">Sign Up / Login</h2>
            <p style="margin-bottom:16px;color:#666;">Please choose:</p>
            <button onclick="closeAuthModal();showSignupModal();" style="width:100%;padding:14px;background:#27ae60;color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;margin-bottom:12px;">Sign Up</button>
            <button onclick="closeAuthModal();showLoginModal();" style="width:100%;padding:14px;background:#0066cc;color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;margin-bottom:12px;">Login</button>
            <button onclick="closeAuthModal()" style="width:100%;padding:14px;background:#e0e0e0;color:#333;border:none;border-radius:8px;font-weight:600;cursor:pointer;">Cancel</button>
        </div>
    </div>

    <!-- Post Listing Modal -->
    <div id="postModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:10000;align-items:center;justify-content:center;overflow-y:auto;">
        <div style="background:#fff;padding:40px;border-radius:16px;max-width:600px;width:90%;margin:40px auto;">
            <h2 style="margin-bottom:24px;">Post New Listing</h2>
            <input type="text" id="titleInput" placeholder="Title (e.g., 2018 Honda Civic)" style="width:100%;padding:12px;margin-bottom:16px;border:2px solid #e0e0e0;border-radius:8px;">
            <select id="categoryInput" style="width:100%;padding:12px;margin-bottom:16px;border:2px solid #e0e0e0;border-radius:8px;">
                <option value="cars">Cars & Trucks</option>
                <option value="parts">Parts & Accessories</option>
                <option value="wheels">Wheels & Tires</option>
                <option value="audio">Audio & Electronics</option>
                <option value="other">Other</option>
            </select>
            <input type="number" id="priceInput" placeholder="Price ($)" style="width:100%;padding:12px;margin-bottom:16px;border:2px solid #e0e0e0;border-radius:8px;">
            <input type="text" id="locationInput" placeholder="Location (City, Province)" style="width:100%;padding:12px;margin-bottom:16px;border:2px solid #e0e0e0;border-radius:8px;">
            <textarea id="descriptionInput" placeholder="Description..." rows="6" style="width:100%;padding:12px;margin-bottom:16px;border:2px solid #e0e0e0;border-radius:8px;resize:vertical;"></textarea>
            <input type="file" id="imageInput" accept="image/*" multiple style="width:100%;margin-bottom:16px;">
            <div style="font-size:12px;color:#666;margin-bottom:16px;">✓ Upload up to 5 images</div>
            <button onclick="submitListing()" style="width:100%;padding:14px;background:#27ae60;color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;margin-bottom:12px;">Post Listing</button>
            <button onclick="closePostModal()" style="width:100%;padding:14px;background:#e0e0e0;color:#333;border:none;border-radius:8px;font-weight:600;cursor:pointer;">Cancel</button>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:10000;overflow-y:auto;padding:40px 0;">
        <div style="background:#fff;padding:40px;border-radius:16px;max-width:800px;width:90%;margin:0 auto;max-height:none;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
                <h2 style="margin:0;">My Profile</h2>
                <button onclick="logout()" style="padding:8px 16px;background:#e74c3c;color:#fff;border:none;border-radius:6px;cursor:pointer;">Logout</button>
            </div>
            <div id="userInfo" style="background:#f8f9fa;padding:20px;border-radius:8px;margin-bottom:24px;"></div>
            <h3 style="margin-bottom:16px;">My Listings</h3>
            <div id="myListings" style="display:grid;gap:16px;"></div>
            <button onclick="closeProfile()" style="width:100%;padding:14px;background:#e0e0e0;color:#333;border:none;border-radius:8px;font-weight:600;cursor:pointer;margin-top:24px;">Close</button>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <div class="footer-grid">
                <div class="footer-col">
                    <h4>Marketplace</h4>
                    <ul>
                        <li><a href="#cars">Cars & Trucks</a></li>
                        <li><a href="#parts">Parts</a></li>
                        <li><a href="#wheels">Wheels & Tires</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>Resources</h4>
                    <ul>
                        <li><a href="../guides.html">Buying Guides</a></li>
                        <li><a href="../tools/financing.html">Financing Calculator</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>Community</h4>
                    <ul>
                        <li><a href="../forum.html">Forums</a></li>
                        <li><a href="../about.html">About</a></li>
                        <li><a href="../contact.html">Contact</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Autoilty. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Email Confirmation Modal -->
    <div id="emailConfirmModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:10001;align-items:center;justify-content:center;">
        <div style="background:#fff;padding:40px;border-radius:16px;max-width:500px;width:90%;text-align:center;">
            <div style="font-size:64px;margin-bottom:20px;">📧</div>
            <h2 style="margin-bottom:16px;">Verify Your Email</h2>
            <p style="color:#666;margin-bottom:24px;">We've sent a confirmation email to:</p>
            <p style="font-weight:600;color:#27ae60;margin-bottom:24px;" id="confirmEmail"></p>
            <div style="background:#f8f9fa;padding:20px;border-radius:8px;margin-bottom:24px;">
                <p style="font-size:14px;color:#666;margin-bottom:12px;">Your confirmation code:</p>
                <p style="font-size:24px;font-weight:700;color:#27ae60;letter-spacing:4px;" id="confirmCode"></p>
            </div>
            <p style="font-size:14px;color:#999;margin-bottom:24px;">Click the button below to simulate email confirmation</p>
            <button onclick="confirmEmail()" style="width:100%;padding:14px;background:#27ae60;color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;margin-bottom:12px;font-size:16px;">✓ Confirm Email</button>
            <p style="font-size:12px;color:#999;margin-top:16px;">In production, you would click a link in your email to confirm</p>
        </div>
    </div>

    <!-- Edit Listing Modal -->
    <div id="editModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:10000;align-items:center;justify-content:center;overflow-y:auto;">
        <div style="background:#fff;padding:40px;border-radius:16px;max-width:600px;width:90%;margin:40px auto;">
            <h2 style="margin-bottom:24px;">Edit Listing</h2>
            <input type="text" id="editTitleInput" placeholder="Title" style="width:100%;padding:12px;margin-bottom:16px;border:2px solid #e0e0e0;border-radius:8px;">
            <select id="editCategoryInput" style="width:100%;padding:12px;margin-bottom:16px;border:2px solid #e0e0e0;border-radius:8px;">
                <option value="cars">Cars & Trucks</option>
                <option value="parts">Parts & Accessories</option>
                <option value="wheels">Wheels & Tires</option>
                <option value="audio">Audio & Electronics</option>
                <option value="other">Other</option>
            </select>
            <input type="number" id="editPriceInput" placeholder="Price ($)" style="width:100%;padding:12px;margin-bottom:16px;border:2px solid #e0e0e0;border-radius:8px;">
            <input type="text" id="editLocationInput" placeholder="Location" style="width:100%;padding:12px;margin-bottom:16px;border:2px solid #e0e0e0;border-radius:8px;">
            <textarea id="editDescriptionInput" placeholder="Description..." rows="6" style="width:100%;padding:12px;margin-bottom:16px;border:2px solid #e0e0e0;border-radius:8px;resize:vertical;"></textarea>
            <input type="file" id="editImageInput" accept="image/*" multiple style="width:100%;margin-bottom:16px;">
            <div style="font-size:12px;color:#666;margin-bottom:16px;">✓ Upload new image (optional)</div>
            <button onclick="updateListing()" style="width:100%;padding:14px;background:#27ae60;color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;margin-bottom:12px;">Update Listing</button>
            <button onclick="closeEditModal()" style="width:100%;padding:14px;background:#e0e0e0;color:#333;border:none;border-radius:8px;font-weight:600;cursor:pointer;">Cancel</button>
        </div>
    </div>

    <!-- Contact Seller Modal -->
    <div id="contactModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:10000;align-items:center;justify-content:center;">
        <div style="background:#fff;padding:40px;border-radius:16px;max-width:500px;width:90%;">
            <h2 style="margin-bottom:16px;">Contact Seller</h2>
            <div id="contactSellerInfo" style="background:#f8f9fa;padding:16px;border-radius:8px;margin-bottom:20px;"></div>
            <textarea id="messageContent" placeholder="Write your message to the seller..." rows="6" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;resize:vertical;margin-bottom:16px;"></textarea>
            <div style="font-size:13px;color:#666;margin-bottom:16px;">💡 The seller will be notified via email at their registered address</div>
            <button onclick="sendMessage()" style="width:100%;padding:14px;background:#27ae60;color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;margin-bottom:12px;">Send Message</button>
            <button onclick="closeContactModal()" style="width:100%;padding:14px;background:#e0e0e0;color:#333;border:none;border-radius:8px;font-weight:600;cursor:pointer;">Cancel</button>
        </div>
    </div>

    <!-- Reply to Message Modal -->
    <div id="replyModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:10000;align-items:center;justify-content:center;">
        <div style="background:#fff;padding:40px;border-radius:16px;max-width:600px;width:90%;box-shadow:0 10px 40px rgba(0,0,0,0.3);">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <h2 style="margin:0;color:#333;">↩️ Reply to Message</h2>
                <button onclick="closeReplyModal()" style="background:transparent;border:none;font-size:24px;color:#999;cursor:pointer;padding:0;width:32px;height:32px;" onmouseover="this.style.color='#333'" onmouseout="this.style.color='#999'">&times;</button>
            </div>
            <div id="replyMessageInfo" style="background:#f8f9fa;padding:20px;border-radius:12px;margin-bottom:24px;border-left:4px solid #3498db;"></div>
            <label style="display:block;font-weight:600;margin-bottom:8px;color:#333;">Your Reply:</label>
            <textarea id="replyContent" placeholder="Type your reply here..." rows="6" style="width:100%;padding:14px;border:2px solid #e0e0e0;border-radius:8px;resize:vertical;margin-bottom:16px;font-size:14px;font-family:inherit;" onfocus="this.style.borderColor='#3498db'" onblur="this.style.borderColor='#e0e0e0'"></textarea>
            <div style="background:#e3f2fd;padding:12px;border-radius:8px;font-size:13px;color:#1976d2;margin-bottom:20px;display:flex;align-items:center;gap:8px;">
                <span style="font-size:18px;">📧</span>
                <span>The seller will receive your reply via email notification</span>
            </div>
            <div style="display:flex;gap:12px;">
                <button onclick="sendReply()" style="flex:1;padding:14px;background:#3498db;color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:15px;transition:all 0.3s;" onmouseover="this.style.background='#2980b9'" onmouseout="this.style.background='#3498db'">📤 Send Reply</button>
                <button onclick="closeReplyModal()" style="padding:14px 24px;background:#f5f5f5;color:#666;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:15px;transition:all 0.3s;" onmouseover="this.style.background='#e0e0e0'" onmouseout="this.style.background='#f5f5f5'">Cancel</button>
            </div>
        </div>
    </div>

    <script src="../js/main.js"></script>
    <script src="../js/backlinks.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/listing-expiration.js"></script>
    <script>
    // Override updateAuthButton to use auth.js
    function updateAuthButton() {
        updateAuthButtons();
    }
    
    // Show auth modal (chooses signup or login)
    function showAuthModal() {
        if (currentUser) {
            goToProfile();
            return;
        }
        // Show choice modal
        document.getElementById('authModal').style.display = 'flex';
    }
    
    // Close auth modal
    function closeAuthModal() {
        document.getElementById('authModal').style.display = 'none';
    }
    
    // Listings Management
    function showPostModal() {
        if (!currentUser) {
            alert('Please sign up or login to post a listing');
            showAuthModal();
            return;
        }
        
        if (!currentUser.confirmed) {
            alert('⚠️ Please confirm your email before posting listings.\n\nCheck your email for the confirmation link.');
            showEmailConfirmation();
            return;
        }
        
        document.getElementById('postModal').style.display = 'flex';
    }
    
    function closePostModal() {
        document.getElementById('postModal').style.display = 'none';
    }
    
    // Compress image client-side to avoid exceeding localStorage quota
    function compressImage(file, maxWidth = 960, maxHeight = 720, qualityStart = 0.7) {
        return new Promise((resolve, reject) => {
            try {
                const img = new Image();
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.onload = function() {
                        let { width, height } = img;
                        const ratio = Math.min(maxWidth / width, maxHeight / height, 1);
                        const canvas = document.createElement('canvas');
                        canvas.width = Math.floor(width * ratio);
                        canvas.height = Math.floor(height * ratio);
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        // Iteratively reduce quality if still large
                        let quality = qualityStart;
                        let dataUrl = canvas.toDataURL('image/jpeg', quality);
                        const maxBytes = 200 * 1024; // 200KB target
                        while (dataUrl.length > maxBytes && quality > 0.45) {
                            quality -= 0.05;
                            dataUrl = canvas.toDataURL('image/jpeg', quality);
                        }
                        resolve(dataUrl);
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            } catch (err) {
                reject(err);
            }
        });
    }

    function submitListing() {
        console.log('submitListing() called');
        
        // Check if user is logged in
        if (!currentUser) {
            alert('❌ Please sign up or login first to post a listing');
            showAuthModal();
            return;
        }
        
        console.log('Current user:', currentUser);
        
        // Check if email is confirmed
        if (!currentUser.confirmed) {
            alert('⚠️ Please confirm your email before posting listings.\n\nCheck your email for the confirmation link.');
            showEmailConfirmation();
            return;
        }
        
        // Get form values
        const title = document.getElementById('titleInput').value.trim();
        const category = document.getElementById('categoryInput').value;
        const price = document.getElementById('priceInput').value;
        const location = document.getElementById('locationInput').value.trim();
        const description = document.getElementById('descriptionInput').value.trim();
        const imageFiles = document.getElementById('imageInput').files;
        
        console.log('Form values:', { title, category, price, location, description, imageCount: imageFiles.length });
        
        // Validate required fields
        if (!title) {
            alert('❌ Please enter a title for your listing');
            document.getElementById('titleInput').focus();
            return;
        }
        
        if (!price || price <= 0) {
            alert('❌ Please enter a valid price');
            document.getElementById('priceInput').focus();
            return;
        }
        
        if (!location) {
            alert('❌ Please enter a location');
            document.getElementById('locationInput').focus();
            return;
        }
        
        if (!description) {
            alert('❌ Please enter a description');
            document.getElementById('descriptionInput').focus();
            return;
        }
        
        // Disable button to prevent double submission
        const submitBtn = document.querySelector('#postModal button[onclick="submitListing()"]');
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '⏳ Posting...';
            submitBtn.style.opacity = '0.7';
        }
        
        // Create listing object
        const listing = {
            id: 'listing_' + Date.now(),
            userId: currentUser.id,
            username: currentUser.username,
            title: title,
            category: category,
            price: parseFloat(price),
            location: location,
            description: description,
            images: [],
            created: new Date().toISOString(),
            views: 0,
            status: 'active'
        };
        
        console.log('Created listing object:', listing);
        
        // Handle images (support multiple images, up to 5)
        if (imageFiles && imageFiles.length > 0) {
            console.log('Processing image upload...', imageFiles.length, 'images');
            const maxImages = Math.min(imageFiles.length, 5);
            const promises = [];
            for (let i = 0; i < maxImages; i++) {
                promises.push(
                    compressImage(imageFiles[i]).then(dataUrl => {
                        listing.images.push(dataUrl);
                    }).catch(err => {
                        console.error('Image compression failed:', err);
                    })
                );
            }
            Promise.all(promises).then(() => {
                if (listing.images.length === 0) {
                    listing.images.push('https://via.placeholder.com/400x300?text=No+Image');
                }
                saveAndClosePost(listing);
            });
        } else {
            console.log('No image uploaded, using placeholder...');
            listing.images.push('https://via.placeholder.com/400x300?text=No+Image');
            saveAndClosePost(listing);
        }
    }
    
    function saveAndClosePost(listing) {
        try {
            console.log('Saving listing to localStorage...');
            
            // Get existing listings with error handling
            let listings = [];
            try {
                const stored = localStorage.getItem('autoilty_listings');
                if (stored) {
                    listings = JSON.parse(stored);
                }
            } catch (e) {
                console.error('Error parsing existing listings:', e);
                // If corrupted, start fresh
                listings = [];
                localStorage.removeItem('autoilty_listings');
            }
            
            console.log('Current listings count:', listings.length);
            
            // Validate listing object
            if (!listing || !listing.id) {
                throw new Error('Invalid listing object');
            }
            
            // Add new listing at the beginning
            listings.unshift(listing);
            
            // Save to localStorage with quota handling and pruning
            try {
                localStorage.setItem('autoilty_listings', JSON.stringify(listings));
                console.log('Listing saved! New count:', listings.length);
            } catch (e) {
                if (e.name === 'QuotaExceededError' || e.code === 22) {
                    console.warn('Quota exceeded. Attempting to reduce size and retry...');
                    // 1) Try removing images from the newest listing and retry
                    const newest = listings[0];
                    if (newest && newest.images && newest.images.length) {
                        newest.images = ['https://via.placeholder.com/400x300?text=No+Image'];
                        try {
                            localStorage.setItem('autoilty_listings', JSON.stringify(listings));
                            console.log('Saved after stripping images from newest listing');
                        } catch (e2) {
                            if (e2.name === 'QuotaExceededError' || e2.code === 22) {
                                // 2) Prune older listings until it fits
                                let pruned = 0;
                                while (listings.length > 1) {
                                    listings.pop();
                                    pruned++;
                                    try {
                                        localStorage.setItem('autoilty_listings', JSON.stringify(listings));
                                        console.log('Saved after pruning', pruned, 'old listings');
                                        break;
                                    } catch (e3) {
                                        if (!(e3.name === 'QuotaExceededError' || e3.code === 22)) {
                                            throw e3;
                                        }
                                    }
                                }
                                if (pruned === 0) {
                                    alert('⚠️ Storage limit reached. Could not save images. The listing was saved with a placeholder image.');
                                }
                            } else {
                                throw e2;
                            }
                        }
                    } else {
                        alert('⚠️ Storage limit reached. Listing saved without images.');
                    }
                } else {
                    throw e;
                }
            }
            
            // Close modal
            closePostModal();
            
            // Clear form
            document.getElementById('titleInput').value = '';
            document.getElementById('priceInput').value = '';
            document.getElementById('locationInput').value = '';
            document.getElementById('descriptionInput').value = '';
            document.getElementById('imageInput').value = '';
            
            // Re-enable button
            const submitBtn = document.querySelector('#postModal button[onclick="submitListing()"]');
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Post Listing';
                submitBtn.style.opacity = '1';
            }
            
            // Show success message
            alert('✅ Listing posted successfully!\n\n' + 
                  '📝 Title: ' + listing.title + '\n' +
                  '💰 Price: $' + listing.price.toLocaleString() + '\n' +
                  '📍 Location: ' + listing.location + '\n\n' +
                  'Your listing is now live and visible to all users!');
            
            // Reload listings to show the new one
            loadListings();
            
        } catch (error) {
            console.error('Error saving listing:', error);
            let errorMsg = '❌ Error posting listing: ' + error.message;
            
            if (error.name === 'QuotaExceededError' || error.code === 22) {
                errorMsg += '\n\n💡 Try:\n• Delete old listings\n• Clear browser cache\n• Use fewer/lower quality images';
            }
            
            alert(errorMsg + '\n\nPlease try again.');
            
            // Re-enable button
            const submitBtn = document.querySelector('#postModal button[onclick="submitListing()"]');
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Post Listing';
                submitBtn.style.opacity = '1';
            }
        }
    }
    
    function loadListings() {
        let listings = JSON.parse(localStorage.getItem('autoilty_listings') || '[]');
        
        // Add sample listings if empty
        if (listings.length === 0) {
            listings = [
                {id:'1',userId:'sample',username:'JohnDoe',title:'2020 Honda Civic Sport',category:'cars',price:22000,location:'Toronto, ON',description:'Well maintained, low km, one owner',images:['https://via.placeholder.com/400x300?text=Honda+Civic'],created:new Date().toISOString(),views:234},
                {id:'2',userId:'sample',username:'MikeTech',title:'Performance Exhaust System',category:'parts',price:800,location:'Vancouver, BC',description:'Borla cat-back exhaust, fits most vehicles',images:['https://via.placeholder.com/400x300?text=Exhaust'],created:new Date().toISOString(),views:156},
                {id:'3',userId:'sample',username:'WheelDeals',title:'18" Alloy Wheels Set of 4',category:'wheels',price:1200,location:'Calgary, AB',description:'Like new condition, includes tires',images:['https://via.placeholder.com/400x300?text=Wheels'],created:new Date().toISOString(),views:89}
            ];
        }
        
        renderListings(listings);
    }
    
    function renderListings(listings) {
        const container = document.getElementById('listingsContainer');
        container.innerHTML = '';
        
        listings.forEach(listing => {
            const card = document.createElement('div');
            card.style.cssText = 'background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.08);transition:transform 0.3s;cursor:pointer;';
            card.onmouseover = () => card.style.transform = 'translateY(-4px)';
            card.onmouseout = () => card.style.transform = 'translateY(0)';
            card.onclick = () => window.location.href = `../listing.html?id=${listing.id}`;
            
            card.innerHTML = `
                <img src="${listing.images[0]}" alt="${listing.title}" style="width:100%;height:200px;object-fit:cover;">
                <div style="padding:20px;">
                    <div style="font-size:24px;font-weight:800;color:#27ae60;margin-bottom:8px;">$${listing.price.toLocaleString()}</div>
                    <h3 style="margin-bottom:8px;font-size:18px;">${listing.title}</h3>
                    <p style="color:#666;font-size:14px;margin-bottom:12px;">${listing.description.substring(0,100)}...</p>
                    <div style="display:flex;justify-content:space-between;align-items:center;padding-top:12px;border-top:1px solid #f0f0f0;margin-bottom:12px;">
                        <span style="color:#999;font-size:13px;">📍 ${listing.location}</span>
                        <span style="color:#999;font-size:13px;">👁️ ${listing.views}</span>
                    </div>
                    ${listing.userId === currentUser?.id ? `
                        <div style="display:flex;gap:8px;">
                            <button onclick="event.stopPropagation();editListing('${listing.id}')" style="flex:1;padding:8px;background:#3498db;color:#fff;border:none;border-radius:6px;cursor:pointer;">Edit</button>
                            <button onclick="event.stopPropagation();deleteListing('${listing.id}')" style="flex:1;padding:8px;background:#e74c3c;color:#fff;border:none;border-radius:6px;cursor:pointer;">Delete</button>
                        </div>
                    ` : `
                        <button onclick="event.stopPropagation();showContactModal('${listing.id}')" style="width:100%;padding:10px;background:#27ae60;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;">📧 Contact Seller</button>
                    `}
                </div>
            `;
            
            container.appendChild(card);
        });
    }
    
    function filterListings() {
        let listings = JSON.parse(localStorage.getItem('autoilty_listings') || '[]');
        const category = document.getElementById('categoryFilter').value;
        const search = document.getElementById('searchInput').value.toLowerCase();
        
        if (category) {
            listings = listings.filter(l => l.category === category);
        }
        
        if (search) {
            listings = listings.filter(l => 
                l.title.toLowerCase().includes(search) || 
                l.description.toLowerCase().includes(search)
            );
        }
        
        renderListings(listings);
    }
    
    function deleteListing(id) {
        if (confirm('Delete this listing?')) {
            let listings = JSON.parse(localStorage.getItem('autoilty_listings') || '[]');
            listings = listings.filter(l => l.id !== id);
            localStorage.setItem('autoilty_listings', JSON.stringify(listings));
            loadListings();
        }
    }
    
    let editingListingId = null;
    
    function editListing(id) {
        editingListingId = id;
        const listings = JSON.parse(localStorage.getItem('autoilty_listings') || '[]');
        const listing = listings.find(l => l.id === id);
        
        if (!listing) {
            alert('Listing not found');
            return;
        }
        
        document.getElementById('editTitleInput').value = listing.title;
        document.getElementById('editCategoryInput').value = listing.category;
        document.getElementById('editPriceInput').value = listing.price;
        document.getElementById('editLocationInput').value = listing.location;
        document.getElementById('editDescriptionInput').value = listing.description;
        
        document.getElementById('editModal').style.display = 'flex';
    }
    
    function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
        editingListingId = null;
    }
    
    function updateListing() {
        if (!editingListingId) {
            alert('⚠️ No listing selected for editing');
            return;
        }
        
        const title = document.getElementById('editTitleInput').value.trim();
        const category = document.getElementById('editCategoryInput').value;
        const price = document.getElementById('editPriceInput').value;
        const location = document.getElementById('editLocationInput').value.trim();
        const description = document.getElementById('editDescriptionInput').value.trim();
        const imageFile = document.getElementById('editImageInput').files[0];
        
        // Validation
        if (!title || !price || !location || !description) {
            alert('❌ Please fill in all required fields');
            return;
        }
        
        if (isNaN(price) || parseFloat(price) <= 0) {
            alert('❌ Please enter a valid price');
            document.getElementById('editPriceInput').focus();
 continued;
        }
        
        try {
            // Get listings with error handling
            let listings = [];
            try {
                const stored = localStorage.getItem('autoilty_listings');
                if (stored) {
                    listings = JSON.parse(stored);
                }
            } catch (e) {
                console.error('Error parsing listings:', e);
                alert('❌ Error loading listings. Please refresh the page and try again.');
                return;
            }
            
            const index = listings.findIndex(l => l.id === editingListingId);
            
            if (index === -1) {
                alert('❌ Listing not found. It may have been deleted.');
                closeEditModal();
                loadListings();
                return;
            }
            
            // Verify ownership
            if (currentUser && listings[index].userId !== currentUser.id) {
                alert('❌ You can only edit your own listings');
                closeEditModal();
                return;
            }
            
            // Update listing fields
            listings[index].title = title;
            listings[index].category = category;
            listings[index].price = parseFloat(price);
            listings[index].location = location;
            listings[index].description = description;
            listings[index].editedAt = new Date().toISOString();
            listings[index].edited = true;
            
            // Handle image update (compress before saving)
            if (imageFile) {
                compressImage(imageFile).then(dataUrl => {
                    try {
                        if (!listings[index].images) {
                            listings[index].images = [];
                        }
                        listings[index].images[0] = dataUrl;
                        try {
                            localStorage.setItem('autoilty_listings', JSON.stringify(listings));
                        } catch (e) {
                            if (e.name === 'QuotaExceededError' || e.code === 22) {
                                // fallback: strip image
                                listings[index].images[0] = 'https://via.placeholder.com/400x300?text=No+Image';
                                localStorage.setItem('autoilty_listings', JSON.stringify(listings));
                                alert('⚠️ Storage limit reached. Image was compressed/removed to save the listing.');
                            } else {
                                throw e;
                            }
                        }
                        closeEditModal();
                        alert('✅ Listing updated successfully!');
                        loadListings();
                        if (window.location.pathname.includes('profile.html')) {
                            window.location.reload();
                        }
                    } catch (error) {
                        console.error('Error saving updated listing:', error);
                        alert('❌ Error saving listing: ' + error.message);
                    }
                }).catch(e => {
                    console.error('Image compression failed:', e);
                    alert('❌ Error processing image. Please try again.');
                });
            } else {
                // No image update, just save the changes
                try {
                    localStorage.setItem('autoilty_listings', JSON.stringify(listings));
                    closeEditModal();
                    alert('✅ Listing updated successfully!');
                    loadListings();
                    // Refresh profile if open
                    if (document.getElementById('profileModal') && document.getElementById('profileModal').style.display === 'flex') {
                        // Refresh profile if modal was open (redirects to profile page now)
                        if (window.location.pathname.includes('profile.html')) {
                            window.location.reload();
                        }
                    }
                } catch (error) {
                    console.error('Error saving listing:', error);
                    if (error.name === 'QuotaExceededError' || error.code === 22) {
                        alert('⚠️ Storage limit reached! Please delete some old listings.');
                    } else {
                        alert('❌ Error saving listing: ' + error.message);
                    }
                }
            }
        } catch (error) {
            console.error('Error updating listing:', error);
            alert('❌ Error updating listing: ' + error.message);
        }
    }
    
    // Contact Seller
    let contactListingId = null;
    
    function showContactModal(listingId) {
        if (!currentUser) {
            alert('Please sign up or login to contact sellers');
            showAuthModal();
            return;
        }
        
        if (!currentUser.confirmed) {
            alert('⚠️ Please confirm your email before contacting sellers.');
            showEmailConfirmation();
            return;
        }
        
        contactListingId = listingId;
        const listings = JSON.parse(localStorage.getItem('autoilty_listings') || '[]');
        const listing = listings.find(l => l.id === listingId);
        
        if (!listing) {
            alert('Listing not found');
            return;
        }
        
        document.getElementById('contactSellerInfo').innerHTML = `
            <div style="font-weight:600;margin-bottom:4px;">Regarding: ${listing.title}</div>
            <div style="color:#27ae60;font-weight:600;margin-bottom:4px;">$${listing.price.toLocaleString()}</div>
            <div style="color:#666;font-size:13px;">Seller: ${listing.username}</div>
        `;
        
        document.getElementById('contactModal').style.display = 'flex';
    }
    
    function closeContactModal() {
        document.getElementById('contactModal').style.display = 'none';
        document.getElementById('messageContent').value = '';
        contactListingId = null;
    }
    
    function sendMessage() {
        if (!currentUser || !contactListingId) return;
        
        const messageContent = document.getElementById('messageContent').value.trim();
        
        if (!messageContent) {
            alert('Please write a message');
            return;
        }
        
        const listings = JSON.parse(localStorage.getItem('autoilty_listings') || '[]');
        const listing = listings.find(l => l.id === contactListingId);
        
        if (!listing) {
            alert('Listing not found');
            return;
        }
        
        const message = {
            id: 'msg_' + Date.now(),
            listingId: listing.id,
            listingTitle: listing.title,
            listingPrice: listing.price,
            fromUserId: currentUser.id,
            fromUsername: currentUser.username,
            toUserId: listing.userId,
            toUsername: listing.username,
            message: messageContent,
            created: new Date().toISOString(),
            read: false
        };
        
        let messages = JSON.parse(localStorage.getItem('autoilty_messages') || '[]');
        messages.push(message);
        localStorage.setItem('autoilty_messages', JSON.stringify(messages));
        
        // Simulate email notification
        alert(`✓ Message sent successfully!\n\n📧 Email notification sent to ${listing.username}'s registered email address.\n\nThey will see your message in their profile.`);
        
        closeContactModal();
    }
    
    // Profile button redirects to profile.html (handled by goToProfile() in auth.js)
    // This function kept for internal modal use on this page only, but nav button redirects
    function showProfileModal() {
        if (!currentUser) return;
        
        const confirmStatus = currentUser.confirmed ? 
            '<span style="color:#27ae60;font-weight:600;">✓ Email Verified</span>' : 
            '<span style="color:#e67e22;font-weight:600;">⚠️ Email Not Verified</span>';
        
        // Get unread message count
        const messages = JSON.parse(localStorage.getItem('autoilty_messages') || '[]');
        const unreadCount = messages.filter(m => m.toUserId === currentUser.id && !m.read).length;
        
        document.getElementById('userInfo').innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                <h4 style="margin:0;">${currentUser.username}</h4>
                ${confirmStatus}
            </div>
            <p style="color:#999;font-size:14px;margin-bottom:8px;">Member since ${new Date(currentUser.joined).toLocaleDateString()}</p>
            ${unreadCount > 0 ? `
                <div style="background:#fff3cd;padding:12px;border-radius:6px;border-left:3px solid #ffc107;margin-bottom:12px;">
                    <p style="color:#856404;font-weight:600;">📬 You have ${unreadCount} new message${unreadCount > 1 ? 's' : ''}!</p>
                </div>
            ` : ''}
            <div style="background:#fff;padding:12px;border-radius:6px;border-left:3px solid #27ae60;">
                <p style="font-size:12px;color:#999;margin-bottom:4px;">🔒 Private - Only you can see this:</p>
                <p style="color:#666;font-size:14px;">${currentUser.email}</p>
            </div>
            ${!currentUser.confirmed ? `
                <button onclick="showEmailConfirmation()" style="margin-top:12px;padding:10px 20px;background:#27ae60;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;">Verify Email Now</button>
            ` : ''}
        `;
        
        const listings = JSON.parse(localStorage.getItem('autoilty_listings') || '[]')
            .filter(l => l.userId === currentUser.id);
        
        const receivedMessages = messages.filter(m => m.toUserId === currentUser.id);
        const sentMessages = messages.filter(m => m.fromUserId === currentUser.id);
        
        const myListingsDiv = document.getElementById('myListings');
        myListingsDiv.innerHTML = `
            <button onclick="showPostModal();closeProfile();" style="width:100%;padding:14px;background:#27ae60;color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;margin-bottom:16px;">+ Post New Listing</button>
            
            <h3 style="margin:24px 0 16px 0;">My Listings</h3>
            ${listings.length === 0 ? 
                '<p style="color:#999;text-align:center;padding:20px;background:#f8f9fa;border-radius:8px;">You haven\'t posted any listings yet.</p>' :
                listings.map(l => `
                    <div style="background:#f8f9fa;padding:16px;border-radius:8px;display:flex;gap:16px;align-items:start;margin-bottom:12px;cursor:pointer;transition:background 0.3s;" onmouseover="this.style.background='#e8f5e9'" onmouseout="this.style.background='#f8f9fa'" onclick="window.location.href='../listing.html?id=${l.id}'">
                        <img src="${l.images[0]}" style="width:80px;height:80px;object-fit:cover;border-radius:8px;">
                        <div style="flex:1;">
                            <strong style="display:block;margin-bottom:4px;">${l.title}</strong>
                            <p style="color:#27ae60;font-weight:600;margin-bottom:4px;">$${l.price.toLocaleString()}</p>
                            <p style="color:#666;font-size:14px;">📍 ${l.location} • 👁️ ${l.views} views</p>
                        </div>
                        <div style="display:flex;gap:8px;flex-shrink:0;">
                            <button onclick="event.stopPropagation();editListing('${l.id}')" style="padding:8px 16px;background:#3498db;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:13px;">Edit</button>
                            <button onclick="event.stopPropagation();deleteListing('${l.id}')" style="padding:8px 16px;background:#e74c3c;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:13px;">Delete</button>
                        </div>
                    </div>
                `).join('')
            }
            
            <h3 style="margin:24px 0 16px 0;">📬 Messages Received (${receivedMessages.length})</h3>
            ${receivedMessages.length === 0 ? 
                '<p style="color:#999;text-align:center;padding:20px;background:#f8f9fa;border-radius:8px;">No messages yet.</p>' :
                receivedMessages.sort((a, b) => new Date(b.created) - new Date(a.created)).map(m => `
                    <div style="background:${m.read ? '#f8f9fa' : '#e8f5e9'};padding:16px;border-radius:8px;margin-bottom:12px;border-left:3px solid ${m.read ? '#e0e0e0' : '#27ae60'};">
                        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px;">
                            <div>
                                <strong style="display:block;">From: ${m.fromUsername}</strong>
                                <span style="color:#666;font-size:13px;">Re: ${m.listingTitle} ($${m.listingPrice.toLocaleString()})</span>
                            </div>
                            ${!m.read ? '<span style="background:#27ae60;color:#fff;padding:4px 8px;border-radius:4px;font-size:11px;font-weight:600;">NEW</span>' : ''}
                        </div>
                        <p style="color:#333;margin-bottom:8px;">${m.message}</p>
                        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin-top:12px;padding-top:12px;border-top:1px solid #e0e0e0;">
                            <span style="color:#999;font-size:12px;">${formatTime(m.created)}</span>
                            <div style="display:flex;gap:8px;">
                                ${!m.read ? `<button onclick="markAsRead('${m.id}')" style="padding:6px 14px;background:#27ae60;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;">✓ Mark as Read</button>` : ''}
                                <button onclick="showReplyModal('${m.id}')" style="padding:6px 14px;background:#3498db;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;transition:all 0.3s;" onmouseover="this.style.background='#2980b9'" onmouseout="this.style.background='#3498db'">↩️ Reply</button>
                            </div>
                        </div>
                    </div>
                `).join('')
            }
            
            <h3 style="margin:24px 0 16px 0;">📤 Messages Sent (${sentMessages.length})</h3>
            ${sentMessages.length === 0 ? 
                '<p style="color:#999;text-align:center;padding:20px;background:#f8f9fa;border-radius:8px;">No sent messages yet.</p>' :
                sentMessages.sort((a, b) => new Date(b.created) - new Date(a.created)).map(m => `
                    <div style="background:#f8f9fa;padding:16px;border-radius:8px;margin-bottom:12px;">
                        <div style="margin-bottom:8px;">
                            <strong style="display:block;">To: ${m.toUsername}</strong>
                            <span style="color:#666;font-size:13px;">Re: ${m.listingTitle} ($${m.listingPrice.toLocaleString()})</span>
                        </div>
                        <p style="color:#333;margin-bottom:8px;">${m.message}</p>
                        <span style="color:#999;font-size:12px;">${formatTime(m.created)}</span>
                    </div>
                `).join('')
            }
        `;
        
        document.getElementById('profileModal').style.display = 'flex';
        // Scroll to top of modal
        document.getElementById('profileModal').scrollTop = 0;
    }
    
    function markAsRead(messageId) {
        let messages = JSON.parse(localStorage.getItem('autoilty_messages') || '[]');
        const messageIndex = messages.findIndex(m => m.id === messageId);
        if (messageIndex !== -1) {
            messages[messageIndex].read = true;
            localStorage.setItem('autoilty_messages', JSON.stringify(messages));
            // If on profile page, reload it
            if (window.location.pathname.includes('profile.html')) {
                window.location.reload();
            }
        }
    }
    
    // Reply to Message
    let replyingToMessageId = null;
    
    function showReplyModal(messageId) {
        replyingToMessageId = messageId;
        const messages = JSON.parse(localStorage.getItem('autoilty_messages') || '[]');
        const originalMessage = messages.find(m => m.id === messageId);
        
        if (!originalMessage) {
            alert('Message not found');
            return;
        }
        
        document.getElementById('replyMessageInfo').innerHTML = `
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                <div style="width:40px;height:40px;background:#3498db;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:bold;font-size:18px;">
                    ${originalMessage.fromUsername.charAt(0).toUpperCase()}
                </div>
                <div>
                    <strong style="display:block;font-size:15px;color:#333;">From: ${originalMessage.fromUsername}</strong>
                    <span style="color:#666;font-size:13px;">Regarding: ${originalMessage.listingTitle} ($${originalMessage.listingPrice.toLocaleString()})</span>
                </div>
            </div>
            <div style="background:#fff;padding:16px;border-radius:8px;border:1px solid #e0e0e0;margin-top:12px;">
                <p style="font-size:12px;color:#999;margin-bottom:8px;text-transform:uppercase;font-weight:600;">Original Message:</p>
                <p style="color:#333;font-size:14px;line-height:1.6;margin:0;">"${originalMessage.message}"</p>
            </div>
        `;
        
        document.getElementById('replyModal').style.display = 'flex';
    }
    
    function closeReplyModal() {
        document.getElementById('replyModal').style.display = 'none';
        document.getElementById('replyContent').value = '';
        replyingToMessageId = null;
    }
    
    function sendReply() {
        if (!currentUser || !replyingToMessageId) return;
        
        const replyContent = document.getElementById('replyContent').value.trim();
        
        if (!replyContent) {
            alert('Please write a reply');
            return;
        }
        
        const messages = JSON.parse(localStorage.getItem('autoilty_messages') || '[]');
        const originalMessage = messages.find(m => m.id === replyingToMessageId);
        
        if (!originalMessage) {
            alert('Original message not found');
            return;
        }
        
        const reply = {
            id: 'msg_' + Date.now(),
            listingId: originalMessage.listingId,
            listingTitle: originalMessage.listingTitle,
            listingPrice: originalMessage.listingPrice,
            fromUserId: currentUser.id,
            fromUsername: currentUser.username,
            toUserId: originalMessage.fromUserId,
            toUsername: originalMessage.fromUsername,
            message: replyContent,
            created: new Date().toISOString(),
            read: false,
            inReplyTo: originalMessage.id
        };
        
        messages.push(reply);
        localStorage.setItem('autoilty_messages', JSON.stringify(messages));
        
        // Mark original as read when replying
        const originalIndex = messages.findIndex(m => m.id === replyingToMessageId);
        if (originalIndex !== -1 && !messages[originalIndex].read) {
            messages[originalIndex].read = true;
            localStorage.setItem('autoilty_messages', JSON.stringify(messages));
        }
        
        alert(`✓ Reply sent successfully!\n\n📧 Email notification sent to ${originalMessage.fromUsername}'s registered email address.`);
        
        closeReplyModal();
        // If on profile page, reload it
        if (window.location.pathname.includes('profile.html')) {
            window.location.reload();
        }
    }
    
    function formatTime(timestamp) {
        const diff = Date.now() - new Date(timestamp).getTime();
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);
        
        if (hours < 1) return 'Just now';
        if (hours < 24) return `${hours}h ago`;
        if (days < 7) return `${days}d ago`;
        return new Date(timestamp).toLocaleDateString();
    }
    
    function closeProfile() {
        document.getElementById('profileModal').style.display = 'none';
    }
    
    // Initialize
    updateAuthButton();
    loadListings();
    
    // Check URL parameters for actions
    const urlParams = new URLSearchParams(window.location.search);
    const editId = urlParams.get('edit');
    const contactId = urlParams.get('contact');
    
    if (editId) {
        setTimeout(() => editListing(editId), 500);
    }
    
    if (contactId) {
        setTimeout(() => showContactModal(contactId), 500);
    }
    </script>
</body>
</html>
