<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Manage your postings - Autoilty Marketplace">
  <title>My Postings - Autoilty</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <script src="public/config.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
  <!-- Navigation -->
  <nav class="nav" role="navigation" aria-label="Main navigation">
    <div class="container">
      <div class="nav-inner">
        <a href="index.html" class="logo" aria-label="Autoilty Home">Autoilty</a>
        <button class="nav-toggle" id="navToggle" aria-label="Toggle navigation" style="display: none;">
          <i data-lucide="menu"></i>
        </button>
        <div class="nav-links" id="navLinks">
          <a href="index.html" class="nav-link">Home</a>
          <a href="marketplace.html" class="nav-link">Marketplace</a>
          <a href="inventory.html" class="nav-link">Find Vehicle</a>
          <a href="resources.html" class="nav-link">Resources</a>
          <a href="my-postings.html?create=true" class="nav-link" id="createPostingLink">Create Posting</a>
          <button class="cart-toggle" aria-label="Shopping cart" id="cartToggle">
            <i data-lucide="shopping-cart"></i>
            <span class="cart-badge" id="cartBadge">0</span>
          </button>
          <div class="user-menu" id="userMenu">
            <button class="user-menu-button" id="userMenuButton">
              <span id="userMenuName">User</span>
              <i data-lucide="chevron-down"></i>
            </button>
            <div class="user-menu-dropdown" id="userMenuDropdown">
              <a href="profile.html" class="user-menu-item">
                <i data-lucide="user" style="width: 1rem; height: 1rem; margin-right: 0.5rem;"></i>
                Profile
              </a>
              <a href="my-postings.html" class="user-menu-item" id="myPostingsLink">
                <i data-lucide="file-text" style="width: 1rem; height: 1rem; margin-right: 0.5rem;"></i>
                My Postings
              </a>
              <a href="messages.html" class="user-menu-item" id="inboxLink">
                <i data-lucide="mail" style="width: 1rem; height: 1rem; margin-right: 0.5rem;"></i>
                Inbox
                <span class="unread-badge" id="unreadBadge" style="display: none; margin-left: auto; background: var(--color-primary); color: white; border-radius: 10px; padding: 2px 6px; font-size: 0.75rem; font-weight: 600; min-width: 18px; text-align: center;">0</span>
              </a>
              <button class="user-menu-item danger" id="logoutButton" style="width: 100%; text-align: left; border: none; cursor: pointer;">
                <i data-lucide="log-out" style="width: 1rem; height: 1rem; margin-right: 0.5rem;"></i>
                Logout
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- My Postings Page -->
  <main class="my-postings-page">
    <div class="container">
      <div class="page-header-actions">
        <div>
          <h1 class="page-title">My Postings</h1>
          <p class="page-subtitle">Manage your marketplace listings</p>
        </div>
        <button class="btn btn-primary" id="createPostingBtn">
          <i data-lucide="plus" class="btn-icon"></i>
          Create New Posting
        </button>
      </div>

      <div id="postingsList" class="postings-list">
        <!-- Postings loaded dynamically -->
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
      </div>

      <div id="emptyPostings" class="empty-postings" style="display: none;">
        <i data-lucide="inbox" class="empty-postings-icon"></i>
        <h2>No postings yet</h2>
        <p>Create your first posting to get started!</p>
        <button class="btn btn-primary" style="margin-top: var(--spacing-md);" onclick="openPostingModal()">
          <i data-lucide="plus" class="btn-icon"></i>
          Create Posting
        </button>
      </div>
    </div>
  </main>

  <!-- Posting Form Modal -->
  <div class="modal-overlay" id="postingModal" style="display: none;">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="modalTitle">Create New Posting</h2>
        <button class="modal-close" id="modalClose" aria-label="Close modal">
          <i data-lucide="x"></i>
        </button>
      </div>
      <form id="postingForm" class="modal-body">
        <div class="form-group">
          <label for="postingTitle" class="form-label">Title *</label>
          <input 
            type="text" 
            id="postingTitle" 
            name="title" 
            class="form-input" 
            placeholder="e.g., 2020 Honda Civic"
            required
            aria-required="true"
          >
        </div>

        <div class="form-group">
          <label for="postingDescription" class="form-label">Description * <span style="font-weight: normal; color: var(--color-text-light); font-size: 0.875rem;">(Recommended: 200+ words for better SEO)</span></label>
          <textarea 
            id="postingDescription" 
            name="description" 
            class="form-textarea" 
            rows="8"
            placeholder="Provide a detailed description of your item. Include: condition, features, history, maintenance records, reason for selling, and any other relevant details. Longer descriptions help buyers make informed decisions and improve search visibility."
            required
            aria-required="true"
            maxlength="2000"
          ></textarea>
          <p class="form-hint" style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--color-text-light);">
            <span id="descriptionCharCount">0</span> / 2000 characters
          </p>
        </div>

        <div class="form-group-row">
          <div class="form-group" style="flex: 1;">
            <label for="postingPrice" class="form-label">Price (CAD) *</label>
            <input 
              type="number" 
              id="postingPrice" 
              name="price" 
              class="form-input" 
              placeholder="0.00"
              step="0.01"
              min="0"
              required
              aria-required="true"
            >
          </div>

          <div class="form-group" style="flex: 1;">
            <label for="postingCategory" class="form-label">Category *</label>
            <select 
              id="postingCategory" 
              name="category" 
              class="form-select" 
              required
              aria-required="true"
            >
              <option value="">Select category</option>
              <option value="Cars">Cars</option>
              <option value="Parts">Parts</option>
              <option value="Services">Services</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>

        <div class="form-group-row">
          <div class="form-group" style="flex: 1;">
            <label for="postingLocation" class="form-label">Location</label>
            <input 
              type="text" 
              id="postingLocation" 
              name="location" 
              class="form-input" 
              placeholder="e.g., Toronto, ON"
            >
          </div>
          <div class="form-group" style="flex: 1;">
            <label for="postingVIN" class="form-label">VIN (Vehicle Identification Number)</label>
            <div style="position: relative;">
              <input 
                type="text" 
                id="postingVIN" 
                name="vin" 
                class="form-input" 
                placeholder="Enter VIN to auto-fill details"
                maxlength="17"
                style="text-transform: uppercase;"
              >
              <button type="button" class="vin-lookup-btn" onclick="lookupVIN()" title="Lookup VIN Details">
                <i data-lucide="search"></i>
              </button>
            </div>
            <p class="form-hint">Enter 17-character VIN to auto-fill vehicle details</p>
            <div id="vinDetails" style="margin-top: var(--spacing-sm); display: none;"></div>
          </div>
        </div>

        <div class="form-group">
          <label for="postingImage" class="form-label">Images</label>
          <div class="image-upload-area">
            <input 
              type="file" 
              id="postingImage" 
              name="image" 
              class="form-input" 
              accept="image/*"
              multiple
            >
            <div class="image-upload-hint">
              <i data-lucide="upload"></i>
              <p>Click to upload or drag and drop</p>
              <p class="form-hint">Multiple images supported (max 10MB each, JPEG/PNG/GIF/WebP)</p>
            </div>
          </div>
          <div id="imagePreviewContainer" class="image-preview-container">
            <!-- Image previews with editing options will be added here -->
          </div>
        </div>

        <div class="form-message" id="formMessage" style="display: none;"></div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
          <button type="submit" class="btn btn-primary" id="submitBtn">
            <i data-lucide="save" class="btn-icon"></i>
            Save Posting
          </button>
        </div>
      </form>
    </div>
  </div>

  <script src="auth.js"></script>
  <script src="messages-api.js"></script>
  <script>
    // Initialize Lucide icons
    lucide.createIcons();

    // Check authentication with proper redirect handling
    if (!isAuthenticated()) {
      const returnUrl = window.location.pathname + window.location.search;
      window.location.href = `login.html?return=${encodeURIComponent(returnUrl)}`;
    }

    // Set user menu
    const currentUser = getCurrentUser();
    if (currentUser) {
      document.getElementById('userMenuName').textContent = currentUser.username;
      
      // Update unread badge
      if (typeof updateUnreadBadge === 'function') {
        updateUnreadBadge();
      }
    }

    // User menu toggle
    const userMenuButton = document.getElementById('userMenuButton');
    const userMenuDropdown = document.getElementById('userMenuDropdown');
    
    userMenuButton.addEventListener('click', (e) => {
      e.stopPropagation();
      userMenuDropdown.classList.toggle('show');
    });

    document.addEventListener('click', () => {
      userMenuDropdown.classList.remove('show');
    });

    // Logout
    document.getElementById('logoutButton').addEventListener('click', () => {
      if (confirm('Are you sure you want to logout?')) {
        logout();
      }
    });

    let editingPostingId = null;
    let allPostings = [];

    // Load postings
    async function loadPostings() {
      try {
        const response = await authenticatedFetch('/postings/user/my-postings');
        const data = await response.json();
        allPostings = data.postings || [];
        renderPostings();
      } catch (error) {
        console.error('Error loading postings:', error);
        showNotification('Failed to load postings', 'error');
      }
    }

    // Render postings
    function renderPostings() {
      const list = document.getElementById('postingsList');
      const empty = document.getElementById('emptyPostings');

      if (allPostings.length === 0) {
        list.style.display = 'none';
        empty.style.display = 'block';
        return;
      }

      list.style.display = 'block';
      empty.style.display = 'none';

      // Get base URL for images (remove /api from API_URL)
      const baseUrl = (window.API_URL || 'https://autoilty-production.up.railway.app/api').replace('/api', '');
      
      list.innerHTML = allPostings.map(posting => `
        <div class="posting-card">
          ${posting.image_url 
            ? `<img src="${baseUrl}${posting.image_url}" alt="${posting.title}" class="posting-card-image">`
            : `<div class="posting-card-image" style="background-color: #f5f5f5; display: flex; align-items: center; justify-content: center; color: var(--color-text-light);">No Image</div>`
          }
          <div class="posting-card-content">
            <span class="posting-card-category">${posting.category}</span>
            <h3 class="posting-card-title">${posting.title}</h3>
            <p class="posting-card-description">${posting.description}</p>
            <div style="margin-top: auto; display: flex; align-items: baseline; gap: var(--spacing-md);">
              <p class="posting-card-price">$${parseFloat(posting.price).toFixed(2)} CAD</p>
              ${posting.location ? `<p class="posting-card-location"><i data-lucide="map-pin" style="width: 0.875rem; height: 0.875rem; display: inline-block; vertical-align: middle;"></i> ${posting.location}</p>` : ''}
            </div>
            <p class="posting-card-location" style="font-size: 0.75rem; color: var(--color-text-light);">
              Created: ${new Date(posting.created_at).toLocaleDateString()}
            </p>
          </div>
          <div class="posting-card-actions">
            <button class="btn btn-secondary" onclick="editPosting(${posting.id})">
              <i data-lucide="edit" class="btn-icon"></i>
              Edit
            </button>
            <button class="btn btn-secondary" onclick="deletePosting(${posting.id}, '${posting.title.replace(/'/g, "\\'")}')">
              <i data-lucide="trash-2" class="btn-icon"></i>
              Delete
            </button>
          </div>
        </div>
      `).join('');

      lucide.createIcons();
    }

    // Open create modal
    function openPostingModal() {
      try {
        editingPostingId = null;
        const modal = document.getElementById('postingModal');
        const modalTitle = document.getElementById('modalTitle');
        const postingForm = document.getElementById('postingForm');
        const imagePreview = document.getElementById('imagePreview');
        
        if (!modal) {
          console.error('Posting modal element not found');
          return;
        }
        
        if (modalTitle) {
          modalTitle.textContent = 'Create New Posting';
        }
        if (postingForm) {
          postingForm.reset();
        }
        if (imagePreview) {
          imagePreview.style.display = 'none';
        }
        modal.style.display = 'flex';
        lucide.createIcons(); // Refresh icons in case they weren't initialized
      } catch (error) {
        console.error('Error opening posting modal:', error);
      }
    }

    // Edit posting
    async function editPosting(id) {
      const posting = allPostings.find(p => p.id === id);
      if (!posting) return;

      editingPostingId = id;
      document.getElementById('modalTitle').textContent = 'Edit Posting';
      document.getElementById('postingTitle').value = posting.title;
      document.getElementById('postingDescription').value = posting.description;
      document.getElementById('postingPrice').value = posting.price;
      document.getElementById('postingCategory').value = posting.category;
      document.getElementById('postingLocation').value = posting.location || '';

      // Handle VIN if exists
      if (posting.vin) {
        document.getElementById('postingVIN').value = posting.vin;
      }
      
      // Handle images
      const container = document.getElementById('imagePreviewContainer');
      if (posting.image_url && container) {
        const baseUrl = (window.API_URL || 'https://autoilty-production.up.railway.app/api').replace('/api', '');
        container.innerHTML = `
          <div class="image-preview-item">
            <div class="image-preview-wrapper">
              <img src="${baseUrl}${posting.image_url}" alt="Current image">
              <div class="image-preview-actions">
                <button type="button" class="image-action-btn" onclick="removeImagePreview(this)" title="Remove">
                  <i data-lucide="x"></i>
                </button>
              </div>
            </div>
          </div>
        `;
        lucide.createIcons();
      }

      document.getElementById('postingModal').style.display = 'flex';
    }

    // Improved confirmation dialog for delete
    function confirmDeletePosting(id, title) {
      const modal = document.createElement('div');
      modal.className = 'confirm-modal-overlay';
      modal.innerHTML = `
        <div class="confirm-modal">
          <div class="confirm-modal-header">
            <i data-lucide="alert-triangle" style="width: 48px; height: 48px; color: #dc2626;"></i>
            <h3>Delete Posting?</h3>
          </div>
          <div class="confirm-modal-body">
            <p>Are you sure you want to delete <strong>"${title}"</strong>?</p>
            <p style="color: var(--color-text-light); font-size: 0.875rem; margin-top: 0.5rem;">This action cannot be undone.</p>
          </div>
          <div class="confirm-modal-footer">
            <button class="btn btn-secondary" onclick="this.closest('.confirm-modal-overlay').remove()">Cancel</button>
            <button class="btn btn-danger" onclick="deletePosting(${id}, '${title.replace(/'/g, "\\'")}'); this.closest('.confirm-modal-overlay').remove();">Delete</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      lucide.createIcons();
    }

    // Delete posting
    async function deletePosting(id, title) {
      try {
        const response = await authenticatedFetch(`/postings/${id}`, {
          method: 'DELETE'
        });

        if (!response.ok) {
          throw new Error('Failed to delete posting');
        }

        showNotification('Posting deleted successfully', 'success');
        await loadPostings();
      } catch (error) {
        console.error('Error deleting posting:', error);
        showNotification('Failed to delete posting', 'error');
      }
    }

    // View posting analytics
    function viewPostingAnalytics(id) {
      const posting = allPostings.find(p => p.id === id);
      if (!posting) return;

      const modal = document.createElement('div');
      modal.className = 'analytics-modal-overlay';
      modal.innerHTML = `
        <div class="analytics-modal">
          <div class="analytics-modal-header">
            <h3>Performance Report: ${posting.title}</h3>
            <button class="analytics-modal-close" onclick="this.closest('.analytics-modal-overlay').remove()">
              <i data-lucide="x"></i>
            </button>
          </div>
          <div class="analytics-modal-body">
            <div class="analytics-grid">
              <div class="analytics-card">
                <div class="analytics-icon">
                  <i data-lucide="eye"></i>
                </div>
                <div class="analytics-content">
                  <h4>${posting.views || 0}</h4>
                  <p>Total Views</p>
                </div>
              </div>
              <div class="analytics-card">
                <div class="analytics-icon">
                  <i data-lucide="message-circle"></i>
                </div>
                <div class="analytics-content">
                  <h4>${posting.inquiries || 0}</h4>
                  <p>Inquiries</p>
                </div>
              </div>
              <div class="analytics-card">
                <div class="analytics-icon">
                  <i data-lucide="trending-up"></i>
                </div>
                <div class="analytics-content">
                  <h4>${posting.is_boosted ? 'Yes' : 'No'}</h4>
                  <p>Boosted</p>
                </div>
              </div>
              <div class="analytics-card">
                <div class="analytics-icon">
                  <i data-lucide="calendar"></i>
                </div>
                <div class="analytics-content">
                  <h4>${Math.floor((new Date() - new Date(posting.created_at)) / (1000 * 60 * 60 * 24))}</h4>
                  <p>Days Active</p>
                </div>
              </div>
            </div>
            <div class="analytics-chart-placeholder">
              <p>Engagement metrics chart coming soon</p>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      lucide.createIcons();

      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
    }

    // Toggle boost posting
    async function toggleBoostPosting(id) {
      const posting = allPostings.find(p => p.id === id);
      if (!posting) return;

      const isBoosted = posting.is_boosted || false;
      
      if (!isBoosted) {
        // Show boost options modal
        const modal = document.createElement('div');
        modal.className = 'boost-modal-overlay';
        modal.innerHTML = `
          <div class="boost-modal">
            <div class="boost-modal-header">
              <h3>Boost Your Listing</h3>
              <button class="boost-modal-close" onclick="this.closest('.boost-modal-overlay').remove()">
                <i data-lucide="x"></i>
              </button>
            </div>
            <div class="boost-modal-body">
              <p>Boost your listing to get more visibility and reach more buyers!</p>
              <div class="boost-options">
                <div class="boost-option">
                  <input type="radio" id="boost-7" name="boost-duration" value="7" checked>
                  <label for="boost-7">
                    <strong>7 Days</strong>
                    <span>$9.99</span>
                  </label>
                </div>
                <div class="boost-option">
                  <input type="radio" id="boost-14" name="boost-duration" value="14">
                  <label for="boost-14">
                    <strong>14 Days</strong>
                    <span>$17.99</span>
                  </label>
                </div>
                <div class="boost-option">
                  <input type="radio" id="boost-30" name="boost-duration" value="30">
                  <label for="boost-30">
                    <strong>30 Days</strong>
                    <span>$29.99</span>
                  </label>
                </div>
              </div>
            </div>
            <div class="boost-modal-footer">
              <button class="btn btn-secondary" onclick="this.closest('.boost-modal-overlay').remove()">Cancel</button>
              <button class="btn btn-primary" onclick="confirmBoostPosting(${id}, this.closest('.boost-modal'));">Boost Now</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
        lucide.createIcons();

        modal.addEventListener('click', (e) => {
          if (e.target === modal) modal.remove();
        });
      } else {
        // Remove boost
        if (confirm('Remove boost from this listing?')) {
          try {
            const response = await authenticatedFetch(`/postings/${id}/boost`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ boost: false })
            });

            if (!response.ok) throw new Error('Failed to remove boost');
            showNotification('Boost removed successfully', 'success');
            await loadPostings();
          } catch (error) {
            console.error('Error removing boost:', error);
            showNotification('Failed to remove boost', 'error');
          }
        }
      }
    }

    async function confirmBoostPosting(id, modalElement) {
      const selectedDuration = modalElement.querySelector('input[name="boost-duration"]:checked')?.value;
      if (!selectedDuration) return;

      try {
        const response = await authenticatedFetch(`/postings/${id}/boost`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ boost: true, duration: parseInt(selectedDuration) })
        });

        if (!response.ok) throw new Error('Failed to boost posting');
        
        modalElement.closest('.boost-modal-overlay').remove();
        showNotification('Listing boosted successfully!', 'success');
        await loadPostings();
      } catch (error) {
        console.error('Error boosting posting:', error);
        showNotification('Failed to boost listing. Please try again.', 'error');
      }
    }

    // Toggle auto-renew
    async function toggleAutoRenew(id, currentValue) {
      try {
        const response = await authenticatedFetch(`/postings/${id}/auto-renew`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ auto_renew: !currentValue })
        });

        if (!response.ok) throw new Error('Failed to update auto-renew');
        showNotification(`Auto-renew ${!currentValue ? 'enabled' : 'disabled'}`, 'success');
        await loadPostings();
      } catch (error) {
        console.error('Error updating auto-renew:', error);
        showNotification('Failed to update auto-renew', 'error');
      }
    }


    // Form submission
    document.getElementById('postingForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(e.target);
      const isEdit = editingPostingId !== null;
      const apiUrl = window.API_URL || 'https://autoilty-production.up.railway.app/api';
      const url = isEdit 
        ? `${apiUrl}/postings/${editingPostingId}`
        : `${apiUrl}/postings`;

      const submitBtn = document.getElementById('submitBtn');
      const formMessage = document.getElementById('formMessage');

      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i data-lucide="loader-2" class="btn-icon"></i> Saving...';
      lucide.createIcons();
      formMessage.style.display = 'none';

      try {
        const token = getAuthToken();
        const headers = {
          'Authorization': `Bearer ${token}`
        };

        const response = await fetch(url, {
          method: isEdit ? 'PUT' : 'POST',
          headers: headers,
          body: formData
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to save posting');
        }

        showNotification(isEdit ? 'Posting updated successfully!' : 'Posting created successfully!', 'success');
        closePostingModal();
        await loadPostings();
      } catch (error) {
        console.error('Error saving posting:', error);
        formMessage.textContent = error.message || 'Failed to save posting. Please try again.';
        formMessage.className = 'form-message form-message-error';
        formMessage.style.display = 'block';
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i data-lucide="save" class="btn-icon"></i> Save Posting';
        lucide.createIcons();
      }
    });

    // Close modal
    function closePostingModal() {
      document.getElementById('postingModal').style.display = 'none';
      document.getElementById('postingForm').reset();
      editingPostingId = null;
    }

    document.getElementById('modalClose').addEventListener('click', closePostingModal);
    document.getElementById('cancelBtn').addEventListener('click', closePostingModal);
    
    // Handle create posting button on page
    const createPostingBtn = document.getElementById('createPostingBtn');
    if (createPostingBtn) {
      createPostingBtn.addEventListener('click', openPostingModal);
    }
    
    // Check if we should open the modal from URL parameter (when coming from nav link)
    function checkUrlParams() {
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('create') === 'true') {
        // Remove the parameter from URL for cleaner navigation
        window.history.replaceState({}, document.title, window.location.pathname);
        // Open modal after ensuring all elements are ready
        setTimeout(() => {
          const modal = document.getElementById('postingModal');
          if (modal) {
            openPostingModal();
          } else {
            console.error('Posting modal not found');
          }
        }, 200);
      }
    }
    
    // Check URL params after page loads
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', checkUrlParams);
    } else {
      checkUrlParams();
    }

    // Close modal on overlay click
    document.getElementById('postingModal').addEventListener('click', (e) => {
      if (e.target.id === 'postingModal') {
        closePostingModal();
      }
    });

    // Notification function
    function showNotification(message, type) {
      const notification = document.createElement('div');
      notification.className = 'notification';
      notification.textContent = message;
      notification.style.backgroundColor = type === 'success' ? '#155724' : '#c53030';
      document.body.appendChild(notification);

      setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // VIN Lookup function
    async function lookupVIN() {
      const vinInput = document.getElementById('postingVIN');
      const vin = vinInput.value.trim().toUpperCase();
      const vinDetails = document.getElementById('vinDetails');

      if (vin.length !== 17) {
        showNotification('VIN must be 17 characters long', 'error');
        return;
      }

      vinInput.disabled = true;
      vinDetails.innerHTML = '<div class="vin-loading">Looking up VIN details...</div>';
      vinDetails.style.display = 'block';

      try {
        // This would call an actual VIN lookup API in production
        // For now, we'll simulate with a placeholder
        await new Promise(resolve => setTimeout(resolve, 1500));

        // Simulated VIN data (replace with actual API call)
        const vinData = {
          make: 'Honda',
          model: 'Civic',
          year: '2020',
          trim: 'EX',
          engine: '1.5L Turbo 4-Cylinder',
          transmission: 'CVT',
          drivetrain: 'FWD',
          fuelType: 'Gasoline',
          color: 'Crystal Black Pearl'
        };

        vinDetails.innerHTML = `
          <div class="vin-details-card">
            <h4>VIN Details Found</h4>
            <div class="vin-details-grid">
              <div><strong>Make:</strong> ${vinData.make}</div>
              <div><strong>Model:</strong> ${vinData.model}</div>
              <div><strong>Year:</strong> ${vinData.year}</div>
              <div><strong>Trim:</strong> ${vinData.trim}</div>
              <div><strong>Engine:</strong> ${vinData.engine}</div>
              <div><strong>Transmission:</strong> ${vinData.transmission}</div>
              <div><strong>Drivetrain:</strong> ${vinData.drivetrain}</div>
              <div><strong>Fuel Type:</strong> ${vinData.fuelType}</div>
              <div><strong>Color:</strong> ${vinData.color}</div>
            </div>
            <button type="button" class="btn btn-secondary btn-sm" onclick="applyVINDetails()">Apply to Title</button>
          </div>
        `;

        // Store VIN data for later use
        window.currentVINData = vinData;

      } catch (error) {
        console.error('Error looking up VIN:', error);
        vinDetails.innerHTML = '<div class="vin-error">VIN lookup failed. Please enter details manually.</div>';
      } finally {
        vinInput.disabled = false;
        lucide.createIcons();
      }
    }

    // Apply VIN details to form
    function applyVINDetails() {
      const vinData = window.currentVINData;
      if (!vinData) return;

      const titleInput = document.getElementById('postingTitle');
      if (titleInput && !titleInput.value) {
        titleInput.value = `${vinData.year} ${vinData.make} ${vinData.model} ${vinData.trim}`;
      }

      const descriptionInput = document.getElementById('postingDescription');
      if (descriptionInput && !descriptionInput.value) {
        descriptionInput.value = `Vehicle Details:\n- Year: ${vinData.year}\n- Make: ${vinData.make}\n- Model: ${vinData.model}\n- Trim: ${vinData.trim}\n- Engine: ${vinData.engine}\n- Transmission: ${vinData.transmission}\n- Drivetrain: ${vinData.drivetrain}\n- Fuel Type: ${vinData.fuelType}\n- Color: ${vinData.color}`;
      }

      showNotification('VIN details applied to form', 'success');
    }

    // Enhanced image upload with editing
    document.getElementById('postingImage').addEventListener('change', (e) => {
      const files = Array.from(e.target.files);
      const container = document.getElementById('imagePreviewContainer');
      container.innerHTML = '';

      files.forEach((file, index) => {
        if (!file.type.startsWith('image/')) {
          showNotification(`${file.name} is not an image file`, 'error');
          return;
        }

        if (file.size > 10 * 1024 * 1024) {
          showNotification(`${file.name} is too large (max 10MB)`, 'error');
          return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
          const imageItem = document.createElement('div');
          imageItem.className = 'image-preview-item';
          imageItem.innerHTML = `
            <div class="image-preview-wrapper">
              <img src="${e.target.result}" alt="Preview ${index + 1}">
              <div class="image-preview-actions">
                <button type="button" class="image-action-btn" onclick="removeImagePreview(this)" title="Remove">
                  <i data-lucide="x"></i>
                </button>
                <button type="button" class="image-action-btn" onclick="editImagePreview(this)" title="Edit">
                  <i data-lucide="edit"></i>
                </button>
              </div>
            </div>
            <input type="hidden" name="image_order" value="${index}">
          `;
          container.appendChild(imageItem);
          lucide.createIcons();
        };
        reader.readAsDataURL(file);
      });
    });

    function removeImagePreview(button) {
      button.closest('.image-preview-item').remove();
    }

    function editImagePreview(button) {
      // Simple image editing would go here (crop, rotate, etc.)
      // For now, just show a message
      showNotification('Image editing feature coming soon', 'info');
    }

    // Export functions globally
    window.openPostingModal = openPostingModal;
    window.editPosting = editPosting;
    window.deletePosting = deletePosting;
    window.confirmDeletePosting = confirmDeletePosting;
    window.viewPostingAnalytics = viewPostingAnalytics;
    window.toggleBoostPosting = toggleBoostPosting;
    window.toggleAutoRenew = toggleAutoRenew;
    window.lookupVIN = lookupVIN;
    window.applyVINDetails = applyVINDetails;
    window.removeImagePreview = removeImagePreview;
    window.editImagePreview = editImagePreview;

    // Mobile hamburger menu toggle
    function setupMobileNav() {
      const navToggle = document.getElementById('navToggle');
      const navLinks = document.getElementById('navLinks');
      
      if (!navToggle || !navLinks) return;
      
      // Show/hide toggle button based on screen size
      function checkMobile() {
        if (window.innerWidth <= 768) {
          navToggle.style.display = 'block';
        } else {
          navToggle.style.display = 'none';
          navLinks.classList.remove('active');
        }
      }
      
      // Initial check
      checkMobile();
      window.addEventListener('resize', checkMobile);
      
      // Toggle menu on click
      navToggle.addEventListener('click', (e) => {
        e.stopPropagation();
        navLinks.classList.toggle('active');
        const icon = navToggle.querySelector('i');
        if (icon) {
          if (navLinks.classList.contains('active')) {
            icon.setAttribute('data-lucide', 'x');
          } else {
            icon.setAttribute('data-lucide', 'menu');
          }
          if (typeof lucide !== 'undefined' && lucide.createIcons) {
            lucide.createIcons();
          }
        }
      });
      
      // Close menu when clicking outside
      document.addEventListener('click', (e) => {
        if (!navLinks.contains(e.target) && !navToggle.contains(e.target)) {
          navLinks.classList.remove('active');
          const icon = navToggle.querySelector('i');
          if (icon) {
            icon.setAttribute('data-lucide', 'menu');
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
              lucide.createIcons();
            }
          }
        }
      });
      
      // Close menu when clicking a link
      navLinks.querySelectorAll('a, button').forEach(item => {
        item.addEventListener('click', () => {
          navLinks.classList.remove('active');
          const icon = navToggle.querySelector('i');
          if (icon) {
            icon.setAttribute('data-lucide', 'menu');
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
              lucide.createIcons();
            }
          }
        });
      });
    }
    
    // Initialize mobile nav
    setupMobileNav();
    
    // Load postings on page load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadPostings);
    } else {
      loadPostings();
    }
  </script>
</body>
</html>

