<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Buy used cars Canada, auto parts Manitoba, and automotive services. Autoilty - Your trusted marketplace for quality vehicles, car parts, and accessories across Canada.">
  <meta name="keywords" content="buy used cars Canada, auto parts Manitoba, used cars, car parts, automotive marketplace, buy cars online, car accessories, auto services Canada, sell cars Canada">
  <meta name="author" content="Autoilty">
  <meta name="robots" content="index, follow">
  <meta property="og:title" content="Autoilty - Buy Used Cars & Auto Parts in Canada">
  <meta property="og:description" content="Buy used cars Canada, auto parts Manitoba, and automotive services. Your trusted marketplace for quality vehicles and parts.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://autoilty.com/">
  <meta property="og:image" content="https://autoilty.com/og-image.jpg">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Autoilty - Buy Used Cars & Auto Parts in Canada">
  <meta name="twitter:description" content="Buy used cars Canada, auto parts Manitoba, and automotive services.">
  <link rel="canonical" href="https://autoilty.com/">
  <title>Autoilty - Buy Used Cars Canada & Auto Parts Manitoba | Automotive Marketplace</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <script src="public/config.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="auth.js"></script>
  <script src="messages-api.js"></script>
  <script src="posting-form-modal.js"></script>
</head>
<body>
  <!-- Navigation -->
  <nav class="nav" role="navigation" aria-label="Main navigation">
    <div class="container">
      <div class="nav-inner">
        <a href="index.html" class="logo" aria-label="Autoilty Home">Autoilty</a>
        <button class="nav-toggle" id="navToggle" aria-label="Toggle navigation" style="display: none;">
          <i data-lucide="menu"></i>
        </button>
        <div class="nav-links" id="navLinks">
          <a href="index.html" class="nav-link active">Home</a>
          <a href="marketplace.html" class="nav-link">Marketplace</a>
          <a href="inventory.html" class="nav-link">Find Vehicle</a>
          <a href="resources.html" class="nav-link">Resources</a>
          <a href="#" class="nav-link" id="createPostingLink" style="display: none;">Create Posting</a>
          <a href="login.html?return=my-postings.html?create=true" class="nav-link" id="createPostingLoginLink">Create Posting</a>
          <button class="cart-toggle" aria-label="Shopping cart" id="cartToggle">
            <i data-lucide="shopping-cart"></i>
            <span class="cart-badge" id="cartBadge">0</span>
          </button>
          <div class="user-menu" id="userMenu" style="display: none;">
            <button class="user-menu-button" id="userMenuButton">
              <span id="userMenuName">User</span>
              <i data-lucide="chevron-down"></i>
            </button>
            <div class="user-menu-dropdown" id="userMenuDropdown">
              <a href="profile.html" class="user-menu-item">
                <i data-lucide="user" style="width: 1rem; height: 1rem; margin-right: 0.5rem;"></i>
                Profile
              </a>
              <a href="my-postings.html" class="user-menu-item" id="myPostingsLink">
                <i data-lucide="file-text" style="width: 1rem; height: 1rem; margin-right: 0.5rem;"></i>
                My Postings
              </a>
              <a href="messages.html" class="user-menu-item" id="inboxLink">
                <i data-lucide="mail" style="width: 1rem; height: 1rem; margin-right: 0.5rem;"></i>
                Inbox
                <span class="unread-badge" id="unreadBadge" style="display: none; margin-left: auto; background: var(--color-primary); color: white; border-radius: 10px; padding: 2px 6px; font-size: 0.75rem; font-weight: 600; min-width: 18px; text-align: center;">0</span>
              </a>
              <button class="user-menu-item danger" id="logoutButton" style="width: 100%; text-align: left; border: none; cursor: pointer;">
                <i data-lucide="log-out" style="width: 1rem; height: 1rem; margin-right: 0.5rem;"></i>
                Logout
              </button>
            </div>
          </div>
          <a href="login.html" class="nav-link" id="loginLink">Login</a>
        </div>
      </div>
    </div>
  </nav>

  <!-- Breadcrumbs -->
  <nav aria-label="Breadcrumb" style="background: #fafafa; border-bottom: 1px solid var(--color-border); padding: var(--spacing-sm) 0;">
    <div class="container">
      <ol style="display: flex; align-items: center; list-style: none; padding: 0; margin: 0; flex-wrap: wrap; gap: var(--spacing-xs);" itemscope itemtype="https://schema.org/BreadcrumbList">
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem" style="color: var(--color-text); font-size: 0.875rem; font-weight: 500;">
          <span itemprop="name">Home</span>
          <meta itemprop="position" content="1" />
        </li>
      </ol>
    </div>
  </nav>

  <!-- Breadcrumbs -->
  <nav aria-label="Breadcrumb" style="padding: var(--spacing-md) 0; border-bottom: 1px solid var(--color-border);">
    <div class="container">
      <ol style="display: flex; align-items: center; gap: var(--spacing-xs); list-style: none; padding: 0; margin: 0; font-size: 0.9375rem;">
        <li style="color: var(--color-text); font-weight: 500;" aria-current="page">Home</li>
      </ol>
    </div>
  </nav>

  <!-- Hero Section -->
  <section class="hero" aria-label="Hero section">
    <div class="container">
      <div class="hero-content">
        <h1 class="hero-title">Autoilty Marketplace</h1>
        <p class="hero-subtitle">Premium auto care. Branded gear. Built for detailers.</p>
        <a href="marketplace.html" class="btn btn-primary" aria-label="Explore marketplace">
          Explore Marketplace
          <i data-lucide="arrow-right" class="btn-icon"></i>
        </a>
      </div>
    </div>
  </section>

  <!-- Business Directory Search -->
  <section class="directory-section" aria-label="Find local businesses">
    <div class="container">
      <h2 class="section-title">Find Local Auto Businesses</h2>
      <p class="section-subtitle" style="text-align: center; color: var(--color-text-light); margin-bottom: var(--spacing-xl);">
        Search for auto repair shops, detailers, parts stores, and more in your area
      </p>

      <div class="directory-search-container">
        <form id="directorySearchForm" class="directory-search-form">
          <div class="search-form-row">
            <div class="form-group" style="flex: 1;">
              <label for="searchKeyword" class="form-label">What are you looking for?</label>
              <input 
                type="text" 
                id="searchKeyword" 
                name="keyword" 
                class="form-input" 
                placeholder="e.g., detailing, tuning, auto parts"
                autocomplete="off"
              >
            </div>

            <div class="form-group" style="flex: 1;">
              <label for="searchLocation" class="form-label">Location</label>
              <input 
                type="text" 
                id="searchLocation" 
                name="location" 
                class="form-input" 
                placeholder="City, ZIP, or use my location"
                autocomplete="off"
              >
            </div>

            <div class="form-group" style="flex: 0 0 120px;">
              <label class="form-label" style="visibility: hidden;">Use Location</label>
              <button type="button" class="btn btn-secondary" id="useLocationBtn" style="width: 100%;">
                <i data-lucide="map-pin" class="btn-icon"></i>
                Use My Location
              </button>
            </div>
          </div>

          <div class="search-form-row">
            <div class="form-group" style="flex: 1;">
              <label for="searchCategory" class="form-label">Category (Optional)</label>
              <select id="searchCategory" name="category" class="form-select">
                <option value="">All Categories</option>
                <option value="Regular Maintenance">Regular Maintenance</option>
                <option value="Detailing">Detailing</option>
                <option value="Custom Builds">Custom Builds</option>
                <option value="Tuning">Tuning</option>
                <option value="Wheels and Tires">Wheels and Tires</option>
                <option value="Auto Parts Yard">Auto Parts Yard</option>
              </select>
            </div>

            <div class="form-group" style="flex: 0 0 150px;">
              <label for="distanceUnit" class="form-label">Distance Unit</label>
              <select id="distanceUnit" name="unit" class="form-select">
                <option value="miles">Miles</option>
                <option value="km">Kilometers</option>
              </select>
            </div>

            <div class="form-group" style="flex: 0 0 150px;">
              <label class="form-label" style="visibility: hidden;">Search</label>
              <button type="submit" class="btn btn-primary" style="width: 100%;">
                <i data-lucide="search" class="btn-icon"></i>
                Search
              </button>
            </div>
          </div>
        </form>

        <div id="directoryLoading" class="loading-state" style="display: none;">
          <div class="loading-spinner"></div>
          <p>Searching for businesses...</p>
        </div>

        <div id="directoryError" class="error-state" style="display: none;"></div>

        <div id="directoryResults" class="businesses-grid" style="display: none;">
          <!-- Business cards loaded dynamically -->
        </div>
      </div>
    </div>
  </section>

  <!-- Featured Products -->
  <section class="featured" aria-label="Featured products">
    <div class="container">
      <h2 class="section-title">Featured Products</h2>
      <div class="products-grid" id="featuredProducts">
        <!-- Products loaded dynamically -->
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="footer" role="contentinfo">
    <div class="container">
      <div class="footer-content">
        <div class="footer-section">
          <h3 class="footer-title">Autoilty</h3>
          <p class="footer-text">Premium automotive detailing products and branded gear.</p>
        </div>
        <div class="footer-section">
          <h4 class="footer-heading">Links</h4>
          <ul class="footer-links">
            <li><a href="marketplace.html">Marketplace</a></li>
            <li><a href="cart.html">Cart</a></li>
            <li><a href="mailto:contact@autoilty.com">Contact</a></li>
          </ul>
        </div>
      </div>
      <div class="footer-bottom">
        <p>&copy; 2025 Autoilty. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <!-- Cart Drawer -->
  <div class="cart-drawer" id="cartDrawer" aria-hidden="true">
    <div class="cart-overlay" id="cartOverlay"></div>
    <div class="cart-content">
      <div class="cart-header">
        <h2>Your Cart</h2>
        <button class="cart-close" id="cartClose" aria-label="Close cart">
          <i data-lucide="x"></i>
        </button>
      </div>
      <div class="cart-items" id="cartItems">
        <!-- Cart items loaded dynamically -->
      </div>
      <div class="cart-footer">
        <div class="cart-total">
          <span>Total:</span>
          <span class="cart-total-amount" id="cartTotal">$0.00 CAD</span>
        </div>
        <a href="cart.html" class="btn btn-primary btn-full">Checkout</a>
        <button class="btn btn-secondary btn-full" id="continueShopping">Continue Shopping</button>
      </div>
    </div>
  </div>

  <script src="script.js"></script>
  <script src="directory.js"></script>
  <script>
    // Wait for script.js to load
    async function loadFeaturedProducts() {
      // Wait a bit for script.js to initialize
      if (typeof getProducts === 'undefined') {
        await new Promise(resolve => setTimeout(resolve, 100));
      }
      
      // Initialize Lucide icons if available
      if (typeof lucide !== 'undefined' && lucide.createIcons) {
        lucide.createIcons();
      }
      try {
        const grid = document.getElementById('featuredProducts');
        
        // Show loading state
        if (grid) {
          grid.innerHTML = `
            <div class="skeleton-card"></div>
            <div class="skeleton-card"></div>
            <div class="skeleton-card"></div>
            <div class="skeleton-card"></div>
          `;
        }
        
        // Get products (this should always return fallback products)
        let products = [];
        try {
          if (typeof getProducts === 'function') {
            products = await getProducts();
          } else {
            // If getProducts isn't loaded yet, use fallback directly
            products = window.FALLBACK_PRODUCTS || [];
          }
        } catch (error) {
          console.warn('Error loading products, using fallback:', error);
          products = window.FALLBACK_PRODUCTS || [];
        }
        
        if (!products || products.length === 0) {
          if (grid) {
            grid.innerHTML = '<p class="empty-state">No products available. Please check your connection.</p>';
          }
          return;
        }
        
        const featured = products.filter(p => p && p.featured).slice(0, 4);
        
        if (!grid) {
          console.error('Featured products grid not found');
          return;
        }
        
        if (featured.length === 0) {
          // If no featured products, show all products
          const allProducts = products.slice(0, 4);
          grid.innerHTML = allProducts.map(product => `
            <div class="product-card" data-product-id="${product.id}">
              <div class="product-image">
                <img src="${product.image || 'https://via.placeholder.com/400'}" alt="${product.name || 'Product'}" loading="lazy" onerror="this.src='https://via.placeholder.com/400'">
              </div>
              <div class="product-info">
                <span class="product-category">${product.category === 'auto' ? 'AUTO' : 'APPAREL'}</span>
                <h3 class="product-name">${product.name || 'Unnamed Product'}</h3>
                <p class="product-price">$${(product.price || 0).toFixed(2)} CAD</p>
                <button class="btn-quick-add" data-product-id="${product.id}" aria-label="Add ${product.name} to cart">
                  Quick Add
                </button>
              </div>
            </div>
          `).join('');
        } else {
          grid.innerHTML = featured.map(product => `
            <div class="product-card" data-product-id="${product.id}">
              <div class="product-image">
                <img src="${product.image || 'https://via.placeholder.com/400'}" alt="${product.name || 'Product'}" loading="lazy" onerror="this.src='https://via.placeholder.com/400'">
              </div>
              <div class="product-info">
                <span class="product-category">${product.category === 'auto' ? 'AUTO' : 'APPAREL'}</span>
                <h3 class="product-name">${product.name || 'Unnamed Product'}</h3>
                <p class="product-price">$${(product.price || 0).toFixed(2)} CAD</p>
                <button class="btn-quick-add" data-product-id="${product.id}" aria-label="Add ${product.name} to cart">
                  Quick Add
                </button>
              </div>
            </div>
          `).join('');
        }
        
        // Re-initialize icons for dynamically added content
        if (typeof lucide !== 'undefined' && lucide.createIcons) {
          lucide.createIcons();
        }
        
        // Add click handlers
        document.querySelectorAll('.product-card').forEach(card => {
          card.addEventListener('click', (e) => {
            if (!e.target.closest('.btn-quick-add')) {
              const productId = card.dataset.productId;
              if (productId) {
                window.location.href = `product.html?id=${productId}`;
              }
            }
          });
        });
        
        document.querySelectorAll('.btn-quick-add').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            e.stopPropagation();
            const productId = btn.dataset.productId;
            const product = products.find(p => p && p.id === productId);
            if (product) {
              if (typeof addToCart === 'function') {
                addToCart(product);
              }
              if (typeof showNotification === 'function') {
                showNotification('Added to cart!');
              }
            }
          });
        });
      } catch (error) {
        console.error('Error loading featured products:', error);
        const grid = document.getElementById('featuredProducts');
        if (grid) {
          grid.innerHTML = '<p class="empty-state">Error loading products. Please refresh the page.</p>';
        }
      }
    }
    
    // Load on page ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadFeaturedProducts);
    } else {
      loadFeaturedProducts();
    }

    // ============================================
    // BUSINESS DIRECTORY SEARCH
    // ============================================
    
    const directoryForm = document.getElementById('directorySearchForm');
    const directoryResults = document.getElementById('directoryResults');
    const directoryLoading = document.getElementById('directoryLoading');
    const directoryError = document.getElementById('directoryError');
    const useLocationBtn = document.getElementById('useLocationBtn');
    const distanceUnitSelect = document.getElementById('distanceUnit');

    // Set distance unit - use the one from directory.js if available
    // Use a different variable name to avoid conflicts
    let localDistanceUnit = typeof window.distanceUnit !== 'undefined' ? window.distanceUnit : 'miles';

    // Update distance unit
    distanceUnitSelect.addEventListener('change', (e) => {
      localDistanceUnit = e.target.value;
      window.distanceUnit = localDistanceUnit;
      // Re-render results if they exist
      const existingBusinesses = window.currentBusinesses;
      if (existingBusinesses && existingBusinesses.length > 0) {
        renderBusinessGrid(existingBusinesses, directoryResults);
      }
    });

    // Use location button
    useLocationBtn.addEventListener('click', async () => {
      const locationInput = document.getElementById('searchLocation');
      useLocationBtn.disabled = true;
      useLocationBtn.innerHTML = '<i data-lucide="loader-2" class="btn-icon"></i> Getting Location...';
      lucide.createIcons();

      try {
        const location = await getUserLocation();
        locationInput.value = `${location.lat.toFixed(4)}, ${location.lng.toFixed(4)}`;
        locationInput.placeholder = 'Using your location';
        showNotification('Location detected!');
      } catch (error) {
        console.error('Geolocation error:', error);
        showNotification('Unable to get your location. Please enter a city or ZIP code.', 'error');
      } finally {
        useLocationBtn.disabled = false;
        useLocationBtn.innerHTML = '<i data-lucide="map-pin" class="btn-icon"></i> Use My Location';
        lucide.createIcons();
      }
    });

    // Form submission
    directoryForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const keyword = document.getElementById('searchKeyword').value.trim();
      const location = document.getElementById('searchLocation').value.trim();
      const category = document.getElementById('searchCategory').value;
      localDistanceUnit = distanceUnitSelect.value;
      window.distanceUnit = localDistanceUnit;

      // Validation
      if (!keyword && !category) {
        showError('Please enter a keyword or select a category');
        return;
      }

      if (!location) {
        // Try to use geolocation
        try {
          await getUserLocation();
        } catch (error) {
          showError('Please enter a location or click "Use My Location"');
          return;
        }
      }

      // Hide previous results and errors
      directoryResults.style.display = 'none';
      directoryError.style.display = 'none';
      directoryLoading.style.display = 'block';

      try {
        const searchParams = {
          keyword,
          location,
          category
        };

        const result = await searchBusinesses(searchParams);

        directoryLoading.style.display = 'none';

        if (!result.businesses || result.businesses.length === 0) {
          showError(result.message || 'No businesses found. Try adjusting your search criteria.');
          return;
        }

        // Store businesses for re-rendering with different units
        window.currentBusinesses = result.businesses;

        // Render results
        renderBusinessGrid(result.businesses, directoryResults);
        directoryResults.style.display = 'grid';

        // Scroll to results
        directoryResults.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

      } catch (error) {
        console.error('Search error:', error);
        directoryLoading.style.display = 'none';
        showError(error.message || 'Failed to search businesses. Please try again.');
      }
    });

    function showError(message) {
      directoryError.textContent = message;
      directoryError.style.display = 'block';
      directoryError.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
    
    // Mobile hamburger menu toggle
    function setupMobileNav() {
      const navToggle = document.getElementById('navToggle');
      const navLinks = document.getElementById('navLinks');
      
      if (!navToggle || !navLinks) return;
      
      // Show/hide toggle button based on screen size
      function checkMobile() {
        if (window.innerWidth <= 768) {
          navToggle.style.display = 'block';
        } else {
          navToggle.style.display = 'none';
          navLinks.classList.remove('active');
        }
      }
      
      // Initial check
      checkMobile();
      window.addEventListener('resize', checkMobile);
      
      // Toggle menu on click
      navToggle.addEventListener('click', (e) => {
        e.stopPropagation();
        navLinks.classList.toggle('active');
        const icon = navToggle.querySelector('i');
        if (icon) {
          if (navLinks.classList.contains('active')) {
            icon.setAttribute('data-lucide', 'x');
          } else {
            icon.setAttribute('data-lucide', 'menu');
          }
          if (typeof lucide !== 'undefined' && lucide.createIcons) {
            lucide.createIcons();
          }
        }
      });
      
      // Close menu when clicking outside
      document.addEventListener('click', (e) => {
        if (!navLinks.contains(e.target) && !navToggle.contains(e.target)) {
          navLinks.classList.remove('active');
          const icon = navToggle.querySelector('i');
          if (icon) {
            icon.setAttribute('data-lucide', 'menu');
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
              lucide.createIcons();
            }
          }
        }
      });
      
      // Close menu when clicking a link
      navLinks.querySelectorAll('a, button').forEach(item => {
        item.addEventListener('click', () => {
          navLinks.classList.remove('active');
          const icon = navToggle.querySelector('i');
          if (icon) {
            icon.setAttribute('data-lucide', 'menu');
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
              lucide.createIcons();
            }
          }
        });
      });
    }
    
    // Initialize mobile nav
    setupMobileNav();
    
    // Setup navigation and user menu
    function setupNavigation() {
      const currentUser = getCurrentUser();
      const userMenu = document.getElementById('userMenu');
      const loginLink = document.getElementById('loginLink');
      const myPostingsLink = document.getElementById('myPostingsLink');
      const createPostingLink = document.getElementById('createPostingLink');
      const createPostingLoginLink = document.getElementById('createPostingLoginLink');
      
      if (currentUser && isAuthenticated()) {
        // User is logged in - show user menu and create posting link
        if (userMenu) {
          userMenu.style.display = 'block';
          userMenu.style.visibility = 'visible';
        }
        if (loginLink) loginLink.style.display = 'none';
        if (myPostingsLink) myPostingsLink.style.display = 'flex';
        if (createPostingLink) createPostingLink.style.display = 'block';
        if (createPostingLoginLink) createPostingLoginLink.style.display = 'none';
        
        const userMenuName = document.getElementById('userMenuName');
        if (userMenuName) userMenuName.textContent = currentUser.username;
        
        // Update unread badge
        if (typeof updateUnreadBadge === 'function') {
          updateUnreadBadge();
        }
        
        // User menu toggle
        const userMenuButton = document.getElementById('userMenuButton');
        const userMenuDropdown = document.getElementById('userMenuDropdown');
        if (userMenuButton && userMenuDropdown) {
          userMenuButton.addEventListener('click', (e) => {
            e.stopPropagation();
            userMenuDropdown.classList.toggle('show');
          });
          
          document.addEventListener('click', (e) => {
            if (!userMenuButton.contains(e.target) && !userMenuDropdown.contains(e.target)) {
              userMenuDropdown.classList.remove('show');
            }
          });
        }
        
        // Logout
        const logoutButton = document.getElementById('logoutButton');
        if (logoutButton) {
          logoutButton.addEventListener('click', () => {
            if (confirm('Are you sure you want to logout?')) {
              logout();
            }
          });
        }
      } else {
        // User is not logged in - show login link and create posting link that redirects to login
        if (userMenu) userMenu.style.display = 'none';
        if (loginLink) loginLink.style.display = 'block';
        if (myPostingsLink) myPostingsLink.style.display = 'none';
        if (createPostingLink) createPostingLink.style.display = 'none';
        if (createPostingLoginLink) createPostingLoginLink.style.display = 'block';
      }
    }
    
    // Initialize navigation
    if (typeof getCurrentUser !== 'undefined' && typeof isAuthenticated !== 'undefined') {
      setupNavigation();
    }
  </script>
</body>
</html>
