<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Buy used cars Manitoba, auto parts Canada, and automotive services. Autoilty - Your trusted marketplace for quality vehicles, car parts, VIN lookup, and accessories across Canada. Find the best deals on used cars for sale.">
  <meta name="keywords" content="buy used cars Manitoba, buy used cars Canada, auto parts Manitoba, used cars for sale, car parts online, automotive marketplace, VIN lookup, buy cars online, sell cars Canada, car accessories, auto services Canada, used vehicles Manitoba, car dealership, auto trader Canada, vehicle listings, car inventory">
  <meta name="author" content="Autoilty">
  <meta name="robots" content="index, follow">
  <meta property="og:title" content="Autoilty - Buy Used Cars & Auto Parts in Canada">
  <meta property="og:description" content="Buy used cars Canada, auto parts Manitoba, and automotive services. Your trusted marketplace for quality vehicles and parts.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://autoilty.com/">
  <meta property="og:image" content="https://autoilty.com/og-image.jpg">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Autoilty - Buy Used Cars & Auto Parts in Canada">
  <meta name="twitter:description" content="Buy used cars Canada, auto parts Manitoba, and automotive services.">
  <link rel="canonical" href="https://autoilty.com/">
  <title>Buy Used Cars Manitoba & Auto Parts Canada | Autoilty - Automotive Marketplace</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <script src="public/config.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="auth.js"></script>
  <script src="messages-api.js"></script>
  <script src="posting-form-modal.js"></script>
</head>
<body>
  <!-- Navigation -->
  <nav class="nav" role="navigation" aria-label="Main navigation">
    <div class="container">
      <div class="nav-inner">
        <a href="index.html" class="logo" aria-label="Autoilty Home">Autoilty</a>
        <button class="nav-toggle" id="navToggle" aria-label="Toggle navigation">
          <i data-lucide="menu"></i>
        </button>
        <div class="nav-links" id="navLinks">
          <a href="index.html" class="nav-link active">Home</a>
          <a href="shop.html" class="nav-link">Shop</a>
          <a href="marketplace.html" class="nav-link">Marketplace</a>
          <a href="shop.html#sell" class="nav-link" id="sellAtShopLink" style="display: none;"><i data-lucide="plus" style="width: 1rem; height: 1rem; margin-right: 0.25rem;"></i> Sell at Shop</a>
          <a href="inventory.html" class="nav-link">Find Vehicle</a>
          <a href="resources.html" class="nav-link">Resources</a>
          <a href="#" class="nav-link" id="createPostingLink" style="display: none;">Create Posting</a>
          <a href="login.html?return=my-postings.html?create=true" class="nav-link" id="createPostingLoginLink">Create Posting</a>
          <button class="cart-toggle" aria-label="Shopping cart" id="cartToggle">
            <i data-lucide="shopping-cart"></i>
            <span class="cart-badge" id="cartBadge">0</span>
          </button>
          <div class="user-menu" id="userMenu" style="display: none;">
            <button class="user-menu-button" id="userMenuButton">
              <span id="userMenuName">User</span>
              <i data-lucide="chevron-down"></i>
            </button>
            <div class="user-menu-dropdown" id="userMenuDropdown">
              <a href="profile.html" class="user-menu-item">
                <i data-lucide="user" style="width: 1rem; height: 1rem; margin-right: 0.5rem;"></i>
                Profile
              </a>
              <a href="my-postings.html" class="user-menu-item" id="myPostingsLink">
                <i data-lucide="file-text" style="width: 1rem; height: 1rem; margin-right: 0.5rem;"></i>
                My Postings
              </a>
              <a href="messages.html" class="user-menu-item" id="inboxLink">
                <i data-lucide="mail" style="width: 1rem; height: 1rem; margin-right: 0.5rem;"></i>
                Inbox
                <span class="unread-badge" id="unreadBadge" style="display: none; margin-left: auto; background: var(--color-primary); color: white; border-radius: 10px; padding: 2px 6px; font-size: 0.75rem; font-weight: 600; min-width: 18px; text-align: center;">0</span>
              </a>
              <button class="user-menu-item danger" id="logoutButton" style="width: 100%; text-align: left; border: none; cursor: pointer;">
                <i data-lucide="log-out" style="width: 1rem; height: 1rem; margin-right: 0.5rem;"></i>
                Logout
              </button>
            </div>
          </div>
          <a href="login.html" class="nav-link" id="loginLink">Login</a>
        </div>
      </div>
    </div>
  </nav>

  <!-- Breadcrumbs -->
  <nav aria-label="Breadcrumb" style="background: #fafafa; border-bottom: 1px solid var(--color-border); padding: var(--spacing-sm) 0;">
    <div class="container">
      <ol style="display: flex; align-items: center; list-style: none; padding: 0; margin: 0; flex-wrap: wrap; gap: var(--spacing-xs);" itemscope itemtype="https://schema.org/BreadcrumbList">
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem" style="color: var(--color-text); font-size: 0.875rem; font-weight: 500;">
          <span itemprop="name">Home</span>
          <meta itemprop="position" content="1" />
        </li>
      </ol>
    </div>
  </nav>

  <!-- Hero Carousel with Trending Listings -->
  <section class="hero-carousel-section" aria-label="Trending vehicle listings">
    <div class="container">
      <div class="hero-carousel-wrapper">
        <h1 class="hero-title">Find Your Perfect Vehicle in Manitoba</h1>
        <p class="hero-subtitle">Browse trending listings and discover the best deals on used cars, auto parts, and services</p>
        <div class="trending-carousel" id="trendingCarousel" role="region" aria-label="Trending listings carousel">
          <button class="carousel-btn carousel-prev" id="carouselPrev" aria-label="Previous slide">
            <i data-lucide="chevron-left"></i>
          </button>
          <div class="carousel-track" id="carouselTrack">
            <div class="carousel-slide active">
              <div class="carousel-slide-content">
                <img src="https://images.unsplash.com/photo-1552519507-da3b142c6e3d?w=800&h=400&fit=crop" alt="Trending vehicle listing - Quality used cars in Manitoba" loading="lazy" class="carousel-image">
                <div class="carousel-overlay">
                  <h2>Premium Used Cars</h2>
                  <p>Find quality vehicles at unbeatable prices</p>
                  <a href="inventory.html" class="btn btn-primary">Browse Inventory</a>
                </div>
              </div>
            </div>
            <div class="carousel-slide">
              <div class="carousel-slide-content">
                <img src="https://images.unsplash.com/photo-1600298881974-6be191ceeda1?w=800&h=400&fit=crop" alt="Auto parts - Find car parts and accessories" loading="lazy" class="carousel-image">
                <div class="carousel-overlay">
                  <h2>Auto Parts & Accessories</h2>
                  <p>Everything you need for your vehicle</p>
                  <a href="marketplace.html" class="btn btn-primary">Shop Parts</a>
                </div>
              </div>
            </div>
            <div class="carousel-slide">
              <div class="carousel-slide-content">
                <img src="https://images.unsplash.com/photo-1632516643720-e7f5d7d6ecc9?w=800&h=400&fit=crop" alt="Auto services - Professional automotive services in Canada" loading="lazy" class="carousel-image">
                <div class="carousel-overlay">
                  <h2>Professional Services</h2>
                  <p>Expert mechanics and auto services near you</p>
                  <a href="directory.html" class="btn btn-primary">Find Services</a>
                </div>
              </div>
            </div>
          </div>
          <button class="carousel-btn carousel-next" id="carouselNext" aria-label="Next slide">
            <i data-lucide="chevron-right"></i>
          </button>
          <div class="carousel-indicators" role="tablist" aria-label="Carousel navigation">
            <button class="carousel-indicator active" data-slide="0" aria-label="Slide 1" role="tab"></button>
            <button class="carousel-indicator" data-slide="1" aria-label="Slide 2" role="tab"></button>
            <button class="carousel-indicator" data-slide="2" aria-label="Slide 3" role="tab"></button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Personalized Recommendations Section -->
  <section class="recommendations-section" aria-label="Personalized recommendations">
    <div class="container">
      <h2 class="section-title">Based on Your Location: Manitoba Deals</h2>
      <p class="section-subtitle">Discover exclusive deals on used cars and auto parts available in your area</p>
      <div class="recommendations-grid" id="manitobaDeals">
        <!-- Dynamic recommendations loaded here -->
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
      </div>
    </div>
  </section>

  <!-- VIN Lookup Tool -->
  <section class="vin-lookup-section" aria-label="VIN lookup tool">
    <div class="container">
      <div class="vin-lookup-card">
        <div class="vin-lookup-content">
          <h2 class="section-title">Quick Vehicle Specs Lookup</h2>
          <p class="section-subtitle">Enter a VIN number to instantly get vehicle specifications, history, and details</p>
          <form id="vinLookupForm" class="vin-lookup-form" aria-label="VIN lookup form">
            <div class="vin-input-group">
              <label for="vinInput" class="visually-hidden">Vehicle Identification Number</label>
              <input 
                type="text" 
                id="vinInput" 
                name="vin" 
                class="form-input vin-input" 
                placeholder="Enter 17-character VIN"
                maxlength="17"
                pattern="[A-HJ-NPR-Z0-9]{17}"
                aria-describedby="vinHelp"
                aria-required="true"
              >
              <button type="submit" class="btn btn-primary" aria-label="Lookup VIN">
                <i data-lucide="search" class="btn-icon"></i>
                Lookup
              </button>
            </div>
            <p id="vinHelp" class="form-help-text">Enter a 17-character Vehicle Identification Number (VIN) to get instant vehicle information</p>
          </form>
          <div id="vinResults" class="vin-results" aria-live="polite" aria-atomic="true" style="display: none;">
            <!-- VIN lookup results displayed here -->
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Business Directory Search -->
  <section class="directory-section" aria-label="Find local businesses">
    <div class="container">
      <h2 class="section-title">Find Local Auto Businesses</h2>
      <p class="section-subtitle" style="text-align: center; color: var(--color-text-light); margin-bottom: var(--spacing-xl);">
        Search for auto repair shops, detailers, parts stores, and more in your area
      </p>

      <div class="directory-search-container">
        <form id="directorySearchForm" class="directory-search-form">
          <div class="search-form-row">
            <div class="form-group" style="flex: 1;">
              <label for="searchKeyword" class="form-label">What are you looking for?</label>
              <input 
                type="text" 
                id="searchKeyword" 
                name="keyword" 
                class="form-input" 
                placeholder="e.g., detailing, tuning, auto parts"
                autocomplete="off"
              >
            </div>

            <div class="form-group" style="flex: 1;">
              <label for="searchLocation" class="form-label">Location</label>
              <input 
                type="text" 
                id="searchLocation" 
                name="location" 
                class="form-input" 
                placeholder="City, ZIP, or use my location"
                autocomplete="off"
              >
            </div>

            <div class="form-group" style="flex: 0 0 120px;">
              <label class="form-label" style="visibility: hidden;">Use Location</label>
              <button type="button" class="btn btn-secondary" id="useLocationBtn" style="width: 100%;">
                <i data-lucide="map-pin" class="btn-icon"></i>
                Use My Location
              </button>
            </div>
          </div>

          <div class="search-form-row">
            <div class="form-group" style="flex: 1;">
              <label for="searchCategory" class="form-label">Category (Optional)</label>
              <select id="searchCategory" name="category" class="form-select">
                <option value="">All Categories</option>
                <option value="Regular Maintenance">Regular Maintenance</option>
                <option value="Detailing">Detailing</option>
                <option value="Custom Builds">Custom Builds</option>
                <option value="Tuning">Tuning</option>
                <option value="Wheels and Tires">Wheels and Tires</option>
                <option value="Auto Parts Yard">Auto Parts Yard</option>
              </select>
            </div>

            <div class="form-group" style="flex: 0 0 150px;">
              <label for="distanceUnit" class="form-label">Distance Unit</label>
              <select id="distanceUnit" name="unit" class="form-select">
                <option value="miles">Miles</option>
                <option value="km">Kilometers</option>
              </select>
            </div>

            <div class="form-group" style="flex: 0 0 150px;">
              <label class="form-label" style="visibility: hidden;">Search</label>
              <button type="submit" class="btn btn-primary" style="width: 100%;">
                <i data-lucide="search" class="btn-icon"></i>
                Search
              </button>
            </div>
          </div>
        </form>

        <div id="directoryLoading" class="loading-state" style="display: none;">
          <div class="loading-spinner"></div>
          <p>Searching for businesses...</p>
        </div>

        <div id="directoryError" class="error-state" style="display: none;"></div>

        <div id="directoryResults" class="businesses-grid" style="display: none;">
          <!-- Business cards loaded dynamically -->
        </div>
      </div>
    </div>
  </section>

  <!-- Featured Products -->
  <section class="featured" aria-label="Featured products">
    <div class="container">
      <h2 class="section-title">Featured Products</h2>
      <div class="products-grid" id="featuredProducts">
        <!-- Products loaded dynamically -->
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
      </div>
    </div>
  </section>

  <!-- Featured Sellers Section -->
  <section class="featured-sellers-section" aria-label="Featured sellers">
    <div class="container">
      <h2 class="section-title">Featured Sellers</h2>
      <p class="section-subtitle">Trusted sellers with excellent ratings and quality listings</p>
      <div class="sellers-grid" id="featuredSellers" role="list">
        <div class="seller-card" role="listitem">
          <div class="seller-avatar">
            <img src="https://ui-avatars.com/api/?name=Auto+Expert&background=000000&color=fff&size=80" alt="Auto Expert - Featured seller profile" loading="lazy">
          </div>
          <div class="seller-info">
            <h3 class="seller-name">Auto Expert Manitoba</h3>
            <div class="seller-rating" aria-label="5 out of 5 stars">
              <span class="stars">★★★★★</span>
              <span class="rating-text">5.0 (128 reviews)</span>
            </div>
            <p class="seller-description">Premium used cars and auto parts with verified history</p>
            <a href="marketplace.html?seller=auto-expert" class="product-link" aria-label="View listings from Auto Expert Manitoba">View Listings</a>
          </div>
        </div>
        <div class="seller-card" role="listitem">
          <div class="seller-avatar">
            <img src="https://ui-avatars.com/api/?name=Car+Parts+Pro&background=000000&color=fff&size=80" alt="Car Parts Pro - Featured seller profile" loading="lazy">
          </div>
          <div class="seller-info">
            <h3 class="seller-name">Car Parts Pro Canada</h3>
            <div class="seller-rating" aria-label="4.8 out of 5 stars">
              <span class="stars">★★★★★</span>
              <span class="rating-text">4.8 (95 reviews)</span>
            </div>
            <p class="seller-description">OEM and aftermarket parts with fast shipping nationwide</p>
            <a href="marketplace.html?seller=car-parts-pro" class="product-link" aria-label="View listings from Car Parts Pro Canada">View Listings</a>
          </div>
        </div>
        <div class="seller-card" role="listitem">
          <div class="seller-avatar">
            <img src="https://ui-avatars.com/api/?name=Quality+Autos&background=000000&color=fff&size=80" alt="Quality Autos - Featured seller profile" loading="lazy">
          </div>
          <div class="seller-info">
            <h3 class="seller-name">Quality Autos Winnipeg</h3>
            <div class="seller-rating" aria-label="4.9 out of 5 stars">
              <span class="stars">★★★★★</span>
              <span class="rating-text">4.9 (210 reviews)</span>
            </div>
            <p class="seller-description">Certified pre-owned vehicles with warranty included</p>
            <a href="marketplace.html?seller=quality-autos" class="product-link" aria-label="View listings from Quality Autos Winnipeg">View Listings</a>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- User Testimonials Section -->
  <section class="testimonials-section" aria-label="Customer testimonials">
    <div class="container">
      <h2 class="section-title">What Our Customers Say</h2>
      <p class="section-subtitle">Real reviews from satisfied buyers across Canada</p>
      <div class="testimonials-grid" role="list">
        <div class="testimonial-card" role="listitem">
          <div class="testimonial-content">
            <div class="testimonial-stars" aria-label="5 out of 5 stars">★★★★★</div>
            <p class="testimonial-text">"Found the perfect used car in Manitoba at a great price! The VIN lookup tool helped me verify everything before purchasing. Highly recommend Autoilty!"</p>
          </div>
          <div class="testimonial-author">
            <div class="author-avatar">
              <img src="https://ui-avatars.com/api/?name=John+Smith&background=000000&color=fff&size=48" alt="John Smith - Customer" loading="lazy">
            </div>
            <div class="author-info">
              <h4 class="author-name">John Smith</h4>
              <p class="author-location">Winnipeg, MB</p>
            </div>
          </div>
        </div>
        <div class="testimonial-card" role="listitem">
          <div class="testimonial-content">
            <div class="testimonial-stars" aria-label="5 out of 5 stars">★★★★★</div>
            <p class="testimonial-text">"Best auto parts marketplace in Canada! Quick delivery and authentic parts. The seller ratings really helped me make the right choice."</p>
          </div>
          <div class="testimonial-author">
            <div class="author-avatar">
              <img src="https://ui-avatars.com/api/?name=Sarah+Johnson&background=000000&color=fff&size=48" alt="Sarah Johnson - Customer" loading="lazy">
            </div>
            <div class="author-info">
              <h4 class="author-name">Sarah Johnson</h4>
              <p class="author-location">Calgary, AB</p>
            </div>
          </div>
        </div>
        <div class="testimonial-card" role="listitem">
          <div class="testimonial-content">
            <div class="testimonial-stars" aria-label="5 out of 5 stars">★★★★★</div>
            <p class="testimonial-text">"Sold my car quickly through Autoilty. The process was smooth and the buyer was verified. Great platform for buying and selling vehicles!"</p>
          </div>
          <div class="testimonial-author">
            <div class="author-avatar">
              <img src="https://ui-avatars.com/api/?name=Mike+Chen&background=000000&color=fff&size=48" alt="Mike Chen - Customer" loading="lazy">
            </div>
            <div class="author-info">
              <h4 class="author-name">Mike Chen</h4>
              <p class="author-location">Toronto, ON</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Newsletter Signup Section -->
  <section class="newsletter-section" aria-label="Newsletter signup">
    <div class="container">
      <div class="newsletter-card">
        <div class="newsletter-content">
          <h2 class="section-title">Get Auto Tips & Exclusive Deals</h2>
          <p class="section-subtitle">Subscribe to our newsletter for the latest automotive tips, maintenance guides, and exclusive deals on used cars and auto parts in Manitoba</p>
          <form id="newsletterForm" class="newsletter-form" aria-label="Newsletter subscription form">
            <div class="newsletter-input-group">
              <label for="newsletterEmail" class="visually-hidden">Email address</label>
              <input 
                type="email" 
                id="newsletterEmail" 
                name="email" 
                class="form-input newsletter-input" 
                placeholder="Enter your email address"
                aria-required="true"
                aria-describedby="newsletterHelp"
                required
              >
              <button type="submit" class="btn btn-primary" aria-label="Subscribe to newsletter">
                <span>Subscribe</span>
                <i data-lucide="arrow-right" class="btn-icon"></i>
              </button>
            </div>
            <p id="newsletterHelp" class="form-help-text">We'll send you weekly tips and exclusive deals. Unsubscribe anytime.</p>
            <div id="newsletterMessage" class="newsletter-message" aria-live="polite" style="display: none;"></div>
          </form>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="footer" role="contentinfo">
    <div class="container">
      <div class="footer-content">
        <div class="footer-section">
          <h3 class="footer-title">Autoilty</h3>
          <p class="footer-text">Premium automotive detailing products and branded gear.</p>
        </div>
        <div class="footer-section">
          <h4 class="footer-heading">Links</h4>
          <ul class="footer-links">
            <li><a href="marketplace.html">Marketplace</a></li>
            <li><a href="cart.html">Cart</a></li>
            <li><a href="mailto:contact@autoilty.com">Contact</a></li>
          </ul>
        </div>
      </div>
      <div class="footer-bottom">
        <p>&copy; 2025 Autoilty. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <!-- Cart Drawer -->
  <div class="cart-drawer" id="cartDrawer" aria-hidden="true">
    <div class="cart-overlay" id="cartOverlay"></div>
    <div class="cart-content">
      <div class="cart-header">
        <h2>Your Cart</h2>
        <button class="cart-close" id="cartClose" aria-label="Close cart">
          <i data-lucide="x"></i>
        </button>
      </div>
      <div class="cart-items" id="cartItems">
        <!-- Cart items loaded dynamically -->
      </div>
      <div class="cart-footer">
        <div class="cart-total">
          <span>Total:</span>
          <span class="cart-total-amount" id="cartTotal">$0.00 CAD</span>
        </div>
        <a href="cart.html" class="btn btn-primary btn-full">Checkout</a>
        <button class="btn btn-secondary btn-full" id="continueShopping">Continue Shopping</button>
      </div>
    </div>
  </div>

  <script src="script.js"></script>
  <script src="directory.js"></script>
  <script>
    // Wait for script.js to load
    async function loadFeaturedProducts() {
      // Wait a bit for script.js to initialize
      if (typeof getProducts === 'undefined') {
        await new Promise(resolve => setTimeout(resolve, 100));
      }
      
      // Initialize Lucide icons if available
      if (typeof lucide !== 'undefined' && lucide.createIcons) {
        lucide.createIcons();
      }
      try {
        const grid = document.getElementById('featuredProducts');
        
        // Show loading state
        if (grid) {
          grid.innerHTML = `
            <div class="skeleton-card"></div>
            <div class="skeleton-card"></div>
            <div class="skeleton-card"></div>
            <div class="skeleton-card"></div>
          `;
        }
        
        // Get products (this should always return fallback products)
        let products = [];
        try {
          if (typeof getProducts === 'function') {
            products = await getProducts();
          } else {
            // If getProducts isn't loaded yet, use fallback directly
            products = window.FALLBACK_PRODUCTS || [];
          }
        } catch (error) {
          console.warn('Error loading products, using fallback:', error);
          products = window.FALLBACK_PRODUCTS || [];
        }
        
        if (!products || products.length === 0) {
          if (grid) {
            grid.innerHTML = '<p class="empty-state">No products available. Please check your connection.</p>';
          }
          return;
        }
        
        const featured = products.filter(p => p && p.featured).slice(0, 4);
        
        if (!grid) {
          console.error('Featured products grid not found');
          return;
        }
        
        if (featured.length === 0) {
          // If no featured products, show all products
          const allProducts = products.slice(0, 4);
          grid.innerHTML = allProducts.map(product => `
            <div class="product-card" data-product-id="${product.id}">
              <div class="product-image">
                <img src="${product.image || 'https://via.placeholder.com/400'}" alt="${product.name ? `${product.name} - ${product.category === 'auto' ? 'Auto product' : 'Apparel item'} for sale on Autoilty` : 'Product image'}" loading="lazy" onerror="this.src='https://via.placeholder.com/400'" aria-label="${product.name || 'Product image'}">
              </div>
              <div class="product-info">
                <span class="product-category">${product.category === 'auto' ? 'AUTO' : 'APPAREL'}</span>
                <h3 class="product-name">${product.name || 'Unnamed Product'}</h3>
                <p class="product-price">$${(product.price || 0).toFixed(2)} CAD</p>
                <button class="btn-quick-add" data-product-id="${product.id}" aria-label="Add ${product.name} to cart">
                  Quick Add
                </button>
              </div>
            </div>
          `).join('');
        } else {
          grid.innerHTML = featured.map(product => `
            <div class="product-card" data-product-id="${product.id}">
              <div class="product-image">
                <img src="${product.image || 'https://via.placeholder.com/400'}" alt="${product.name ? `${product.name} - ${product.category === 'auto' ? 'Auto product' : 'Apparel item'} for sale on Autoilty` : 'Product image'}" loading="lazy" onerror="this.src='https://via.placeholder.com/400'" aria-label="${product.name || 'Product image'}">
              </div>
              <div class="product-info">
                <span class="product-category">${product.category === 'auto' ? 'AUTO' : 'APPAREL'}</span>
                <h3 class="product-name">${product.name || 'Unnamed Product'}</h3>
                <p class="product-price">$${(product.price || 0).toFixed(2)} CAD</p>
                <button class="btn-quick-add" data-product-id="${product.id}" aria-label="Add ${product.name} to cart">
                  Quick Add
                </button>
              </div>
            </div>
          `).join('');
        }
        
        // Re-initialize icons for dynamically added content
        if (typeof lucide !== 'undefined' && lucide.createIcons) {
          lucide.createIcons();
        }
        
        // Add click handlers
        document.querySelectorAll('.product-card').forEach(card => {
          card.addEventListener('click', (e) => {
            if (!e.target.closest('.btn-quick-add')) {
              const productId = card.dataset.productId;
              if (productId) {
                window.location.href = `product.html?id=${productId}`;
              }
            }
          });
        });
        
        document.querySelectorAll('.btn-quick-add').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            e.stopPropagation();
            const productId = btn.dataset.productId;
            const product = products.find(p => p && p.id === productId);
            if (product) {
              if (typeof addToCart === 'function') {
                addToCart(product);
              }
              if (typeof showNotification === 'function') {
                showNotification('Added to cart!');
              }
            }
          });
        });
      } catch (error) {
        console.error('Error loading featured products:', error);
        const grid = document.getElementById('featuredProducts');
        if (grid) {
          grid.innerHTML = '<p class="empty-state">Error loading products. Please refresh the page.</p>';
        }
      }
    }
    
    // Load on page ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadFeaturedProducts);
    } else {
      loadFeaturedProducts();
    }

    // ============================================
    // BUSINESS DIRECTORY SEARCH
    // ============================================
    
    const directoryForm = document.getElementById('directorySearchForm');
    const directoryResults = document.getElementById('directoryResults');
    const directoryLoading = document.getElementById('directoryLoading');
    const directoryError = document.getElementById('directoryError');
    const useLocationBtn = document.getElementById('useLocationBtn');
    const distanceUnitSelect = document.getElementById('distanceUnit');

    // Set distance unit - use the one from directory.js if available
    // Use a different variable name to avoid conflicts
    let localDistanceUnit = typeof window.distanceUnit !== 'undefined' ? window.distanceUnit : 'miles';

    // Update distance unit
    distanceUnitSelect.addEventListener('change', (e) => {
      localDistanceUnit = e.target.value;
      window.distanceUnit = localDistanceUnit;
      // Re-render results if they exist
      const existingBusinesses = window.currentBusinesses;
      if (existingBusinesses && existingBusinesses.length > 0) {
        renderBusinessGrid(existingBusinesses, directoryResults);
      }
    });

    // Use location button
    useLocationBtn.addEventListener('click', async () => {
      const locationInput = document.getElementById('searchLocation');
      useLocationBtn.disabled = true;
      useLocationBtn.innerHTML = '<i data-lucide="loader-2" class="btn-icon"></i> Getting Location...';
      lucide.createIcons();

      try {
        const location = await getUserLocation();
        locationInput.value = `${location.lat.toFixed(4)}, ${location.lng.toFixed(4)}`;
        locationInput.placeholder = 'Using your location';
        showNotification('Location detected!');
      } catch (error) {
        console.error('Geolocation error:', error);
        showNotification('Unable to get your location. Please enter a city or ZIP code.', 'error');
      } finally {
        useLocationBtn.disabled = false;
        useLocationBtn.innerHTML = '<i data-lucide="map-pin" class="btn-icon"></i> Use My Location';
        lucide.createIcons();
      }
    });

    // Form submission
    directoryForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const keyword = document.getElementById('searchKeyword').value.trim();
      const location = document.getElementById('searchLocation').value.trim();
      const category = document.getElementById('searchCategory').value;
      localDistanceUnit = distanceUnitSelect.value;
      window.distanceUnit = localDistanceUnit;

      // Validation
      if (!keyword && !category) {
        showError('Please enter a keyword or select a category');
        return;
      }

      if (!location) {
        // Try to use geolocation
        try {
          await getUserLocation();
        } catch (error) {
          showError('Please enter a location or click "Use My Location"');
          return;
        }
      }

      // Hide previous results and errors
      directoryResults.style.display = 'none';
      directoryError.style.display = 'none';
      directoryLoading.style.display = 'block';

      try {
        const searchParams = {
          keyword,
          location,
          category
        };

        const result = await searchBusinesses(searchParams);

        directoryLoading.style.display = 'none';

        if (!result.businesses || result.businesses.length === 0) {
          showError(result.message || 'No businesses found. Try adjusting your search criteria.');
          return;
        }

        // Store businesses for re-rendering with different units
        window.currentBusinesses = result.businesses;

        // Render results
        renderBusinessGrid(result.businesses, directoryResults);
        directoryResults.style.display = 'grid';

        // Scroll to results
        directoryResults.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

      } catch (error) {
        console.error('Search error:', error);
        directoryLoading.style.display = 'none';
        showError(error.message || 'Failed to search businesses. Please try again.');
      }
    });

    function showError(message) {
      directoryError.textContent = message;
      directoryError.style.display = 'block';
      directoryError.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
    
    // Mobile hamburger menu toggle
    function setupMobileNav() {
      const navToggle = document.getElementById('navToggle');
      const navLinks = document.getElementById('navLinks');
      
      if (!navToggle || !navLinks) return;
      
      // Show/hide toggle button based on screen size
      function checkMobile() {
        if (window.innerWidth <= 768) {
          navToggle.style.display = 'block';
        } else {
          navToggle.style.display = 'none';
          navLinks.classList.remove('active');
        }
      }
      
      // Initial check
      checkMobile();
      window.addEventListener('resize', checkMobile);
      
      // Toggle menu on click
      navToggle.addEventListener('click', (e) => {
        e.stopPropagation();
        navLinks.classList.toggle('active');
        const icon = navToggle.querySelector('i');
        if (icon) {
          if (navLinks.classList.contains('active')) {
            icon.setAttribute('data-lucide', 'x');
          } else {
            icon.setAttribute('data-lucide', 'menu');
          }
          if (typeof lucide !== 'undefined' && lucide.createIcons) {
            lucide.createIcons();
          }
        }
      });
      
      // Close menu when clicking outside
      document.addEventListener('click', (e) => {
        if (!navLinks.contains(e.target) && !navToggle.contains(e.target)) {
          navLinks.classList.remove('active');
          const icon = navToggle.querySelector('i');
          if (icon) {
            icon.setAttribute('data-lucide', 'menu');
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
              lucide.createIcons();
            }
          }
        }
      });
      
      // Close menu when clicking a link
      navLinks.querySelectorAll('a, button').forEach(item => {
        item.addEventListener('click', () => {
          navLinks.classList.remove('active');
          const icon = navToggle.querySelector('i');
          if (icon) {
            icon.setAttribute('data-lucide', 'menu');
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
              lucide.createIcons();
            }
          }
        });
      });
    }
    
    // Initialize mobile nav
    setupMobileNav();
    
    // Setup navigation and user menu
    function setupNavigation() {
      const currentUser = getCurrentUser();
      const userMenu = document.getElementById('userMenu');
      const loginLink = document.getElementById('loginLink');
      const myPostingsLink = document.getElementById('myPostingsLink');
      const createPostingLink = document.getElementById('createPostingLink');
      const createPostingLoginLink = document.getElementById('createPostingLoginLink');
      
      if (currentUser && isAuthenticated()) {
        // User is logged in - show user menu and create posting link
        if (userMenu) {
          userMenu.style.display = 'block';
          userMenu.style.visibility = 'visible';
        }
        if (loginLink) loginLink.style.display = 'none';
        if (myPostingsLink) myPostingsLink.style.display = 'flex';
        if (createPostingLink) createPostingLink.style.display = 'block';
        if (createPostingLoginLink) createPostingLoginLink.style.display = 'none';
        
        const userMenuName = document.getElementById('userMenuName');
        if (userMenuName) userMenuName.textContent = currentUser.username;
        
        // Update unread badge
        if (typeof updateUnreadBadge === 'function') {
          updateUnreadBadge();
        }
        
        // User menu toggle
        const userMenuButton = document.getElementById('userMenuButton');
        const userMenuDropdown = document.getElementById('userMenuDropdown');
        if (userMenuButton && userMenuDropdown) {
          userMenuButton.addEventListener('click', (e) => {
            e.stopPropagation();
            userMenuDropdown.classList.toggle('show');
          });
          
          document.addEventListener('click', (e) => {
            if (!userMenuButton.contains(e.target) && !userMenuDropdown.contains(e.target)) {
              userMenuDropdown.classList.remove('show');
            }
          });
        }
        
        // Logout
        const logoutButton = document.getElementById('logoutButton');
        if (logoutButton) {
          logoutButton.addEventListener('click', () => {
            if (confirm('Are you sure you want to logout?')) {
              logout();
            }
          });
        }
      } else {
        // User is not logged in - show login link and create posting link that redirects to login
        if (userMenu) userMenu.style.display = 'none';
        if (loginLink) loginLink.style.display = 'block';
        if (myPostingsLink) myPostingsLink.style.display = 'none';
        if (createPostingLink) createPostingLink.style.display = 'none';
        if (createPostingLoginLink) createPostingLoginLink.style.display = 'block';
      }
    }
    
    // Initialize navigation
    if (typeof getCurrentUser !== 'undefined' && typeof isAuthenticated !== 'undefined') {
      setupNavigation();
    }
    // ============================================
    // HERO CAROUSEL FUNCTIONALITY
    // ============================================
    (function initCarousel() {
      const carouselTrack = document.getElementById('carouselTrack');
      const prevBtn = document.getElementById('carouselPrev');
      const nextBtn = document.getElementById('carouselNext');
      const indicators = document.querySelectorAll('.carousel-indicator');
      const slides = document.querySelectorAll('.carousel-slide');
      
      if (!carouselTrack || !slides.length) return;
      
      let currentSlide = 0;
      const totalSlides = slides.length;
      
      function showSlide(index) {
        // Remove active class from all slides and indicators
        slides.forEach((slide, i) => {
          slide.classList.toggle('active', i === index);
        });
        indicators.forEach((indicator, i) => {
          indicator.classList.toggle('active', i === index);
          indicator.setAttribute('aria-selected', i === index);
        });
        
        currentSlide = index;
      }
      
      function nextSlide() {
        const next = (currentSlide + 1) % totalSlides;
        showSlide(next);
      }
      
      function prevSlide() {
        const prev = (currentSlide - 1 + totalSlides) % totalSlides;
        showSlide(prev);
      }
      
      // Event listeners
      if (nextBtn) nextBtn.addEventListener('click', nextSlide);
      if (prevBtn) prevBtn.addEventListener('click', prevSlide);
      
      indicators.forEach((indicator, index) => {
        indicator.addEventListener('click', () => showSlide(index));
      });
      
      // Auto-advance carousel every 5 seconds
      setInterval(nextSlide, 5000);
      
      // Initialize
      showSlide(0);
    })();

    // ============================================
    // VIN LOOKUP FUNCTIONALITY
    // ============================================
    (function initVINLookup() {
      const vinForm = document.getElementById('vinLookupForm');
      const vinInput = document.getElementById('vinInput');
      const vinResults = document.getElementById('vinResults');
      
      if (!vinForm || !vinInput) return;
      
      // Format VIN input (uppercase, no spaces)
      vinInput.addEventListener('input', (e) => {
        e.target.value = e.target.value.toUpperCase().replace(/[^A-HJ-NPR-Z0-9]/g, '');
      });
      
      vinForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const vin = vinInput.value.trim().toUpperCase();
        
        // Validate VIN (17 characters)
        if (vin.length !== 17) {
          showVINMessage('Please enter a valid 17-character VIN number.', 'error');
          return;
        }
        
        // Show loading state
        vinResults.style.display = 'block';
        vinResults.innerHTML = '<p>Looking up VIN information...</p>';
        
        try {
          // Note: In production, this would call a real VIN lookup API
          // For now, we'll simulate with demo data
          await new Promise(resolve => setTimeout(resolve, 1000));
          
          // Demo VIN data structure
          const vinData = {
            vin: vin,
            make: 'Toyota',
            model: 'Camry',
            year: '2020',
            engine: '2.5L 4-Cylinder',
            transmission: 'Automatic',
            drivetrain: 'FWD',
            fuelType: 'Gasoline',
            bodyType: 'Sedan',
            color: 'Silver',
            trim: 'LE'
          };
          
          // Display results
          vinResults.innerHTML = `
            <h3>Vehicle Information</h3>
            <div class="vin-result-item">
              <span class="vin-result-label">VIN:</span>
              <span class="vin-result-value">${vinData.vin}</span>
            </div>
            <div class="vin-result-item">
              <span class="vin-result-label">Make:</span>
              <span class="vin-result-value">${vinData.make}</span>
            </div>
            <div class="vin-result-item">
              <span class="vin-result-label">Model:</span>
              <span class="vin-result-value">${vinData.model}</span>
            </div>
            <div class="vin-result-item">
              <span class="vin-result-label">Year:</span>
              <span class="vin-result-value">${vinData.year}</span>
            </div>
            <div class="vin-result-item">
              <span class="vin-result-label">Engine:</span>
              <span class="vin-result-value">${vinData.engine}</span>
            </div>
            <div class="vin-result-item">
              <span class="vin-result-label">Transmission:</span>
              <span class="vin-result-value">${vinData.transmission}</span>
            </div>
            <div class="vin-result-item">
              <span class="vin-result-label">Trim:</span>
              <span class="vin-result-value">${vinData.trim}</span>
            </div>
            <p style="margin-top: var(--spacing-md); color: var(--color-text-light); font-size: 0.875rem;">
              <em>Note: This is demo data. In production, this would connect to a VIN lookup API service.</em>
            </p>
          `;
          
        } catch (error) {
          console.error('VIN lookup error:', error);
          vinResults.innerHTML = '<p style="color: #f44336;">Error looking up VIN. Please try again.</p>';
        }
      });
      
      function showVINMessage(message, type) {
        if (vinResults) {
          vinResults.style.display = 'block';
          vinResults.innerHTML = `<p class="${type === 'error' ? 'error' : 'success'}" style="padding: var(--spacing-sm); background: ${type === 'error' ? '#ffebee' : '#e8f5e9'}; color: ${type === 'error' ? '#c62828' : '#2e7d32'}; border-radius: var(--radius);">${message}</p>`;
        }
      }
    })();

    // ============================================
    // NEWSLETTER SIGNUP FUNCTIONALITY
    // ============================================
    (function initNewsletter() {
      const newsletterForm = document.getElementById('newsletterForm');
      const newsletterEmail = document.getElementById('newsletterEmail');
      const newsletterMessage = document.getElementById('newsletterMessage');
      
      if (!newsletterForm) return;
      
      newsletterForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const email = newsletterEmail.value.trim();
        
        // Basic email validation
        if (!email || !email.includes('@')) {
          showNewsletterMessage('Please enter a valid email address.', 'error');
          return;
        }
        
        // Show loading state
        newsletterMessage.style.display = 'block';
        newsletterMessage.className = 'newsletter-message';
        newsletterMessage.textContent = 'Subscribing...';
        
        try {
          // In production, this would call a backend API
          await new Promise(resolve => setTimeout(resolve, 1000));
          
          // Simulate success
          showNewsletterMessage('Thank you for subscribing! Check your email for confirmation.', 'success');
          newsletterEmail.value = '';
          
          // Store subscription (localStorage for demo)
          const subscriptions = JSON.parse(localStorage.getItem('newsletterSubscriptions') || '[]');
          subscriptions.push({ email, date: new Date().toISOString() });
          localStorage.setItem('newsletterSubscriptions', JSON.stringify(subscriptions));
          
        } catch (error) {
          console.error('Newsletter subscription error:', error);
          showNewsletterMessage('Sorry, something went wrong. Please try again later.', 'error');
        }
      });
      
      function showNewsletterMessage(message, type) {
        if (newsletterMessage) {
          newsletterMessage.style.display = 'block';
          newsletterMessage.className = `newsletter-message ${type}`;
          newsletterMessage.textContent = message;
          
          // Auto-hide after 5 seconds
          setTimeout(() => {
            newsletterMessage.style.display = 'none';
          }, 5000);
        }
      }
    })();

    // ============================================
    // MANITOBA DEALS RECOMMENDATIONS
    // ============================================
    (function loadManitobaDeals() {
      const dealsGrid = document.getElementById('manitobaDeals');
      if (!dealsGrid) return;
      
      // Load products and filter by Manitoba location
      async function loadDeals() {
        try {
          let products = [];
          if (typeof getProducts === 'function') {
            products = await getProducts();
          } else if (window.FALLBACK_PRODUCTS) {
            products = window.FALLBACK_PRODUCTS;
          }
          
          // Filter or tag products as "Manitoba deals" (in production, this would filter by location)
          const manitobaDeals = products.slice(0, 4).map(product => ({
            ...product,
            location: 'Manitoba',
            dealBadge: 'Local Deal'
          }));
          
          if (manitobaDeals.length === 0) {
            dealsGrid.innerHTML = '<p class="empty-state">No deals available in Manitoba at this time.</p>';
            return;
          }
          
          // Render deals
          dealsGrid.innerHTML = manitobaDeals.map(product => `
            <div class="product-card" data-product-id="${product.id}">
              <div class="product-image">
                ${product.dealBadge ? `<span class="product-badge">${product.dealBadge}</span>` : ''}
                <img src="${product.image || 'https://via.placeholder.com/400'}" alt="${product.name ? `${product.name} - ${product.category === 'auto' ? 'Auto product' : 'Apparel item'} for sale in Manitoba on Autoilty` : 'Product image'}" loading="lazy" onerror="this.src='https://via.placeholder.com/400'" aria-label="${product.name || 'Product image'}">
              </div>
              <div class="product-info">
                <span class="product-category">${product.category === 'auto' ? 'AUTO' : 'APPAREL'}</span>
                <h3 class="product-name">${product.name || 'Unnamed Product'}</h3>
                <p class="product-price">$${(product.price || 0).toFixed(2)} CAD</p>
                <p style="font-size: 0.875rem; color: var(--color-text-light); margin: 0.5rem 0;">📍 Available in Manitoba</p>
                <button class="btn-quick-add" data-product-id="${product.id}" aria-label="Add ${product.name} to cart">
                  Quick Add
                </button>
              </div>
            </div>
          `).join('');
          
          // Re-initialize Lucide icons
          if (typeof lucide !== 'undefined' && lucide.createIcons) {
            lucide.createIcons();
          }
          
          // Add click handlers for quick add buttons
          dealsGrid.querySelectorAll('.btn-quick-add').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              e.stopPropagation();
              const productId = btn.dataset.productId;
              const product = manitobaDeals.find(p => p && p.id === productId);
              if (product) {
                if (typeof addToCart === 'function') {
                  addToCart(product);
                }
                if (typeof showNotification === 'function') {
                  showNotification('Added to cart!');
                }
              }
            });
          });
          
        } catch (error) {
          console.error('Error loading Manitoba deals:', error);
          dealsGrid.innerHTML = '<p class="empty-state">Error loading deals. Please refresh the page.</p>';
        }
      }
      
      // Load on page ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadDeals);
      } else {
        loadDeals();
      }
    })();

  </script>
</body>
</html>
