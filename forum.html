<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Community forum for car enthusiasts. Create threads, ask questions, share photos, and discuss everything automotive.">
    <title>Community Forum - Create Threads & Discuss | Autoilty</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/forum.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <a href="index.html" class="brand">AUTOILTY</a>
            <div class="nav-links">
                <a href="index.html" class="nav-link">Home</a>
                <a href="forum.html" class="nav-link active">Forum</a>
                <a href="guides.html" class="nav-link">Guides</a>
                <a href="tools.html" class="nav-link">Tools</a>
            </div>
            <button class="btn-primary" onclick="showAuthModal()" id="authBtn">Sign Up / Login</button>
            <button class="btn-primary" onclick="showProfile()" id="profileBtn" style="display:none;">My Profile</button>
            <button class="btn-primary" onclick="logout()" id="logoutBtn" style="display:none;background:#e74c3c;">Logout</button>
        </div>
    </nav>

    <div class="page-header">
        <div class="container">
            <h1>🗣️ Community Forum</h1>
            <p>Join 50,000+ auto enthusiasts in discussions</p>
            <button class="btn-hero" onclick="showThreadModal()" style="background:#fff;color:#E2231A;padding:14px 32px;border:none;border-radius:8px;font-weight:600;font-size:16px;cursor:pointer;margin-top:20px;">
                ✏️ Create New Thread
            </button>
        </div>
    </div>

    <div class="container" style="padding:48px 0;">
        <!-- Categories Filter -->
        <div style="background:#fff;padding:24px;border-radius:12px;margin-bottom:32px;box-shadow:0 2px 8px rgba(0,0,0,0.08);">
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;">
                <select id="categoryFilter" onchange="filterThreads()" style="padding:12px;border:2px solid #e0e0e0;border-radius:8px;">
                    <option value="">All Categories</option>
                    <option value="general">General Discussion</option>
                    <option value="maintenance">Maintenance & Repair</option>
                    <option value="buying">Buying & Selling</option>
                    <option value="mods">Modifications</option>
                    <option value="events">Events & Meetups</option>
                    <option value="regional">Regional</option>
                </select>
                <select id="sortFilter" onchange="filterThreads()" style="padding:12px;border:2px solid #e0e0e0;border-radius:8px;">
                    <option value="recent">Most Recent</option>
                    <option value="popular">Most Popular</option>
                    <option value="replies">Most Replies</option>
                </select>
                <input type="text" id="searchInput" placeholder="Search threads..." onkeyup="filterThreads()" style="padding:12px;border:2px solid #e0e0e0;border-radius:8px;">
            </div>
        </div>

        <!-- Threads List -->
        <div id="threadsContainer" style="display:grid;gap:20px;"></div>
        
        <div id="noThreads" style="display:none;text-align:center;padding:60px 20px;background:#f8f9fa;border-radius:12px;">
            <h3 style="color:#666;margin-bottom:12px;">No threads yet</h3>
            <p style="color:#999;">Be the first to start a discussion!</p>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="authModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:10000;align-items:center;justify-content:center;">
        <div style="background:#fff;padding:40px;border-radius:16px;max-width:400px;width:90%;">
            <h2 style="margin-bottom:24px;">Sign Up / Login</h2>
            <input type="text" id="usernameInput" placeholder="Username" style="width:100%;padding:12px;margin-bottom:16px;border:2px solid #e0e0e0;border-radius:8px;">
            <input type="email" id="emailInput" placeholder="Email" style="width:100%;padding:12px;margin-bottom:16px;border:2px solid #e0e0e0;border-radius:8px;">
            <button onclick="handleAuth()" style="width:100%;padding:14px;background:#E2231A;color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;margin-bottom:12px;">Continue</button>
            <button onclick="closeAuthModal()" style="width:100%;padding:14px;background:#e0e0e0;color:#333;border:none;border-radius:8px;font-weight:600;cursor:pointer;">Cancel</button>
        </div>
    </div>

    <!-- Create Thread Modal -->
    <div id="threadModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:10000;align-items:center;justify-content:center;overflow-y:auto;">
        <div style="background:#fff;padding:40px;border-radius:16px;max-width:700px;width:90%;margin:40px auto;">
            <h2 style="margin-bottom:24px;">Create New Thread</h2>
            <input type="text" id="threadTitle" placeholder="Thread Title" style="width:100%;padding:12px;margin-bottom:16px;border:2px solid #e0e0e0;border-radius:8px;">
            <select id="threadCategory" style="width:100%;padding:12px;margin-bottom:16px;border:2px solid #e0e0e0;border-radius:8px;">
                <option value="general">General Discussion</option>
                <option value="maintenance">Maintenance & Repair</option>
                        <option value="buying">Buying & Selling</option>
                <option value="mods">Modifications & Performance</option>
                <option value="events">Events & Meetups</option>
                <option value="regional">Regional</option>
                    </select>
            <textarea id="threadContent" placeholder="What's your question or topic?" rows="8" style="width:100%;padding:12px;margin-bottom:16px;border:2px solid #e0e0e0;border-radius:8px;resize:vertical;"></textarea>
            <input type="file" id="threadImage" accept="image/*" style="width:100%;margin-bottom:16px;">
            <div style="font-size:12px;color:#666;margin-bottom:16px;">✓ Optional: Add an image to your thread</div>
            <button onclick="submitThread()" style="width:100%;padding:14px;background:#E2231A;color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;margin-bottom:12px;">Post Thread</button>
            <button onclick="closeThreadModal()" style="width:100%;padding:14px;background:#e0e0e0;color:#333;border:none;border-radius:8px;font-weight:600;cursor:pointer;">Cancel</button>
                </div>
            </div>
            
    <!-- Email Confirmation Modal -->
    <div id="emailConfirmModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:10001;align-items:center;justify-content:center;">
        <div style="background:#fff;padding:40px;border-radius:16px;max-width:500px;width:90%;text-align:center;">
            <div style="font-size:64px;margin-bottom:20px;">📧</div>
            <h2 style="margin-bottom:16px;">Verify Your Email</h2>
            <p style="color:#666;margin-bottom:24px;">We've sent a confirmation email to:</p>
            <p style="font-weight:600;color:#E2231A;margin-bottom:24px;" id="confirmEmail"></p>
            <div style="background:#f8f9fa;padding:20px;border-radius:8px;margin-bottom:24px;">
                <p style="font-size:14px;color:#666;margin-bottom:12px;">Your confirmation code:</p>
                <p style="font-size:24px;font-weight:700;color:#E2231A;letter-spacing:4px;" id="confirmCode"></p>
            </div>
            <p style="font-size:14px;color:#999;margin-bottom:24px;">Click the button below to simulate email confirmation</p>
            <button onclick="confirmEmail()" style="width:100%;padding:14px;background:#27ae60;color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;margin-bottom:12px;font-size:16px;">✓ Confirm Email</button>
            <p style="font-size:12px;color:#999;margin-top:16px;">In production, you would click a link in your email to confirm</p>
        </div>
            </div>
            
    <!-- Profile Modal -->
    <div id="profileModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:10000;overflow-y:auto;padding:40px 0;">
        <div style="background:#fff;padding:40px;border-radius:16px;max-width:800px;width:90%;margin:0 auto;max-height:none;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
                <h2 style="margin:0;">My Profile</h2>
                <button onclick="logout()" style="padding:8px 16px;background:#e74c3c;color:#fff;border:none;border-radius:6px;cursor:pointer;">Logout</button>
            </div>
            <div id="userInfo" style="background:#f8f9fa;padding:20px;border-radius:8px;margin-bottom:24px;"></div>
            
            <h3 style="margin-bottom:16px;">My Threads</h3>
            <div id="myThreads" style="display:grid;gap:16px;margin-bottom:32px;"></div>
            
            <h3 style="margin-bottom:16px;">My Replies</h3>
            <div id="myReplies" style="display:grid;gap:16px;"></div>
            
            <button onclick="closeProfile()" style="width:100%;padding:14px;background:#e0e0e0;color:#333;border:none;border-radius:8px;font-weight:600;cursor:pointer;margin-top:24px;">Close</button>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <div class="footer-grid">
                <div class="footer-col">
                    <h4>Forum Categories</h4>
                    <ul>
                        <li><a href="categories/general-discussion.html">General Discussion</a></li>
                        <li><a href="categories/maintenance-repair.html">Maintenance</a></li>
                        <li><a href="categories/buying-selling.html">Buying & Selling</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>Resources</h4>
                    <ul>
                        <li><a href="guides.html">Guides</a></li>
                        <li><a href="tools.html">Tools</a></li>
                        <li><a href="qa.html">Q&A</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>Community</h4>
                    <ul>
                        <li><a href="about.html">About</a></li>
                        <li><a href="contact.html">Contact</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Autoilty. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="js/main.js"></script>
    <script src="js/auth.js"></script>
    <script>
    // Override updateAuthButton to use auth.js
    function updateAuthButton() {
        updateAuthButtons();
    }
    
    // Thread Management
    function showThreadModal() {
        if (!currentUser) {
            alert('Please sign up or login to create a thread');
            showAuthModal();
            return;
        }
        
        if (!currentUser.confirmed) {
            alert('⚠️ Please confirm your email before creating threads.\n\nCheck your email for the confirmation link.');
            showEmailConfirmation();
            return;
        }
        
        document.getElementById('threadModal').style.display = 'flex';
    }
    
    function closeThreadModal() {
        document.getElementById('threadModal').style.display = 'none';
    }
    
    function submitThread() {
        if (!currentUser) {
            alert('Please login first');
            return;
        }
        
        const title = document.getElementById('threadTitle').value.trim();
        const category = document.getElementById('threadCategory').value;
        const content = document.getElementById('threadContent').value.trim();
        const imageFile = document.getElementById('threadImage').files[0];
        
        if (!title || !content) {
            alert('Please fill in title and content');
            return;
        }
        
        const thread = {
            id: 'thread_' + Date.now(),
            userId: currentUser.id,
            username: currentUser.username,
            title: title,
            category: category,
            content: content,
            image: null,
            created: new Date().toISOString(),
            views: 0,
            replies: 0,
            likes: 0
        };
        
        // Handle image
        if (imageFile) {
            const reader = new FileReader();
            reader.onload = function(e) {
                thread.image = e.target.result;
                saveAndCloseThread(thread);
            };
            reader.readAsDataURL(imageFile);
        } else {
            saveAndCloseThread(thread);
        }
    }
    
    function saveAndCloseThread(thread) {
        let threads = JSON.parse(localStorage.getItem('autoilty_threads') || '[]');
        threads.unshift(thread);
        localStorage.setItem('autoilty_threads', JSON.stringify(threads));
        
        closeThreadModal();
        document.getElementById('threadTitle').value = '';
        document.getElementById('threadContent').value = '';
        document.getElementById('threadImage').value = '';
        
        alert('Thread posted successfully!');
        loadThreads();
    }
    
    function loadThreads() {
        let threads = JSON.parse(localStorage.getItem('autoilty_threads') || '[]');
        
        // Add sample threads if empty
        if (threads.length === 0) {
            threads = [
                {id:'sample1',userId:'sample',username:'CarGuru2024',title:'Best winter tires for Ontario winters?',category:'maintenance',content:'Looking for recommendations for good winter tires. Budget around $800-1000 for a set.',image:null,created:new Date(Date.now()-3600000).toISOString(),views:234,replies:45,likes:23},
                {id:'sample2',userId:'sample',username:'TechMike',title:'2024 Honda Civic vs Toyota Corolla - Which to buy?',category:'buying',content:'Torn between these two. Both seem great but need help deciding. Daily commuter, 30k km/year.',image:null,created:new Date(Date.now()-7200000).toISOString(),views:567,replies:89,likes:67},
                {id:'sample3',userId:'sample',username:'ModEnthusiast',title:'Installed cold air intake - Before/After dyno results',category:'mods',content:'Just installed a cold air intake on my Mustang GT. Gained 15hp! Here are the dyno charts.',image:null,created:new Date(Date.now()-10800000).toISOString(),views:892,replies:124,likes:156}
            ];
        }
        
        renderThreads(threads);
    }
    
    function renderThreads(threads) {
        const container = document.getElementById('threadsContainer');
        const noThreads = document.getElementById('noThreads');
        
        if (threads.length === 0) {
            container.style.display = 'none';
            noThreads.style.display = 'block';
            return;
        }
        
        container.style.display = 'grid';
        noThreads.style.display = 'none';
        container.innerHTML = '';
        
        threads.forEach(thread => {
            const card = document.createElement('div');
            card.style.cssText = 'background:#fff;border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,0.08);transition:transform 0.3s;cursor:pointer;';
            card.onmouseover = () => card.style.transform = 'translateY(-2px)';
            card.onmouseout = () => card.style.transform = 'translateY(0)';
            card.onclick = () => window.location.href = `thread.html?id=${thread.id}`;
            
            const categoryColors = {
                general: '#3498db',
                maintenance: '#e67e22',
                buying: '#27ae60',
                mods: '#9b59b6',
                events: '#f39c12',
                regional: '#1abc9c'
            };
            
            card.innerHTML = `
                <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px;">
                    <h3 style="margin:0;font-size:20px;color:#1a1a1a;">${thread.title}</h3>
                    <span style="background:${categoryColors[thread.category]};color:#fff;padding:4px 12px;border-radius:12px;font-size:12px;font-weight:600;white-space:nowrap;margin-left:16px;">${thread.category}</span>
                </div>
                <p style="color:#666;margin-bottom:16px;line-height:1.6;">${thread.content.substring(0,200)}${thread.content.length > 200 ? '...' : ''}</p>
                ${thread.image ? `<img src="${thread.image}" style="width:100%;max-height:300px;object-fit:cover;border-radius:8px;margin-bottom:16px;">` : ''}
                <div style="display:flex;justify-content:space-between;align-items:center;padding-top:16px;border-top:1px solid #f0f0f0;">
                    <div style="display:flex;gap:16px;">
                        <span style="color:#999;font-size:14px;">👤 ${thread.username}</span>
                        <span style="color:#999;font-size:14px;">👁️ ${thread.views} views</span>
                        <span style="color:#999;font-size:14px;">💬 ${thread.replies} replies</span>
                        <span style="color:#999;font-size:14px;">⭐ ${thread.likes} likes</span>
                    </div>
                    <span style="color:#999;font-size:14px;">${formatTime(thread.created)}</span>
                </div>
                ${thread.userId === currentUser?.id ? `
                    <div style="margin-top:16px;display:flex;gap:8px;">
                        <button onclick="event.stopPropagation();editThread('${thread.id}')" style="flex:1;padding:10px;background:#3498db;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;">Edit</button>
                        <button onclick="event.stopPropagation();deleteThread('${thread.id}')" style="flex:1;padding:10px;background:#e74c3c;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;">Delete</button>
                    </div>
                ` : ''}
            `;
            
            container.appendChild(card);
        });
    }
    
    function formatTime(timestamp) {
        const diff = Date.now() - new Date(timestamp).getTime();
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);
        
        if (hours < 1) return 'Just now';
        if (hours < 24) return `${hours}h ago`;
        if (days < 7) return `${days}d ago`;
        return new Date(timestamp).toLocaleDateString();
    }
    
    function filterThreads() {
        let threads = JSON.parse(localStorage.getItem('autoilty_threads') || '[]');
        const category = document.getElementById('categoryFilter').value;
        const search = document.getElementById('searchInput').value.toLowerCase();
        const sort = document.getElementById('sortFilter').value;
        
        if (category) {
            threads = threads.filter(t => t.category === category);
        }
        
        if (search) {
            threads = threads.filter(t => 
                t.title.toLowerCase().includes(search) || 
                t.content.toLowerCase().includes(search)
            );
        }
        
        // Sort
        if (sort === 'popular') {
            threads.sort((a, b) => (b.views + b.likes) - (a.views + a.likes));
        } else if (sort === 'replies') {
            threads.sort((a, b) => b.replies - a.replies);
        }
        
        renderThreads(threads);
    }
    
    function deleteThread(id) {
        if (confirm('Delete this thread?')) {
            let threads = JSON.parse(localStorage.getItem('autoilty_threads') || '[]');
            threads = threads.filter(t => t.id !== id);
            localStorage.setItem('autoilty_threads', JSON.stringify(threads));
            loadThreads();
        }
    }
    
    function editThread(id) {
        alert('Edit functionality coming soon!');
    }
    
    // Profile
    function showProfile() {
        if (!currentUser) return;
        
        const confirmStatus = currentUser.confirmed ? 
            '<span style="color:#27ae60;font-weight:600;">✓ Email Verified</span>' : 
            '<span style="color:#e67e22;font-weight:600;">⚠️ Email Not Verified</span>';
        
        document.getElementById('userInfo').innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                <h4 style="margin:0;">${currentUser.username}</h4>
                ${confirmStatus}
            </div>
            <p style="color:#999;font-size:14px;margin-bottom:8px;">Member since ${new Date(currentUser.joined).toLocaleDateString()}</p>
            <div style="background:#fff;padding:12px;border-radius:6px;border-left:3px solid #E2231A;">
                <p style="font-size:12px;color:#999;margin-bottom:4px;">Private - Only you can see this:</p>
                <p style="color:#666;font-size:14px;">${currentUser.email}</p>
            </div>
            ${!currentUser.confirmed ? `
                <button onclick="showEmailConfirmation()" style="margin-top:12px;padding:10px 20px;background:#E2231A;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;">Verify Email Now</button>
            ` : ''}
        `;
        
        const threads = JSON.parse(localStorage.getItem('autoilty_threads') || '[]')
            .filter(t => t.userId === currentUser.id);
        
        const myThreadsDiv = document.getElementById('myThreads');
        myThreadsDiv.innerHTML = threads.length === 0 ? 
            '<p style="color:#999;">You haven\'t created any threads yet.</p>' :
            threads.map(t => `
                <div style="background:#f8f9fa;padding:16px;border-radius:8px;">
                    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px;">
                        <a href="thread.html?id=${t.id}" style="font-weight:600;color:#E2231A;text-decoration:none;">${t.title}</a>
                        <div style="display:flex;gap:8px;">
                            <button onclick="editThread('${t.id}')" style="padding:6px 12px;background:#3498db;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">Edit</button>
                            <button onclick="deleteThread('${t.id}')" style="padding:6px 12px;background:#e74c3c;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">Delete</button>
                        </div>
                    </div>
                    <p style="color:#666;font-size:14px;margin-bottom:8px;">${t.content.substring(0,100)}...</p>
                    <div style="display:flex;gap:12px;font-size:13px;color:#999;">
                        <span>👁️ ${t.views} views</span>
                        <span>💬 ${t.replies} replies</span>
                        <span>⭐ ${t.likes} likes</span>
                    </div>
                </div>
            `).join('');
        
        // My Replies
        const replies = JSON.parse(localStorage.getItem('autoilty_replies') || '[]')
            .filter(r => r.userId === currentUser.id);
        
        const allThreads = JSON.parse(localStorage.getItem('autoilty_threads') || '[]');
        
        const myRepliesDiv = document.getElementById('myReplies');
        myRepliesDiv.innerHTML = replies.length === 0 ?
            '<p style="color:#999;">You haven\'t posted any replies yet.</p>' :
            replies.map(r => {
                const thread = allThreads.find(t => t.id === r.threadId);
                return `
                    <div style="background:#f8f9fa;padding:16px;border-radius:8px;">
                        <div style="font-size:12px;color:#999;margin-bottom:8px;">Reply in: <a href="thread.html?id=${r.threadId}" style="color:#E2231A;">${thread?.title || 'Thread'}</a></div>
                        <p style="color:#666;font-size:14px;">${r.content.substring(0,100)}${r.content.length > 100 ? '...' : ''}</p>
                        <div style="font-size:12px;color:#999;margin-top:8px;">${formatTime(r.created)}</div>
                    </div>
                `;
            }).join('');
        
        document.getElementById('profileModal').style.display = 'flex';
        // Scroll to top of modal
        document.getElementById('profileModal').scrollTop = 0;
    }
    
    function closeProfile() {
        document.getElementById('profileModal').style.display = 'none';
    }
    
    // Initialize
    updateAuthButton();
    loadThreads();
    </script>
</body>
</html>
